This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.
The content has been processed where empty lines have been removed.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/*.spec.ts, **/ui/**, public/**, node_modules/**, .git/**, estructura.txt
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Empty lines have been removed from all files
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
app/[slug]/page.tsx
app/admin/actions.ts
app/admin/inventory/page.tsx
app/admin/layout.tsx
app/admin/orders/page.tsx
app/admin/page.tsx
app/admin/product/edit/[id]/page.tsx
app/admin/product/new/page.tsx
app/admin/settings/page.tsx
app/admin/setup/page.tsx
app/auth/callback/route.ts
app/globals.css
app/layout.tsx
app/login/page.tsx
app/page.tsx
app/product/[id]/page.tsx
app/store/useCart.ts
app/subscription/page.tsx
components/AddToCartBtn.tsx
components/admin/RateWidget.tsx
components/admin/ShippingSettings.tsx
components/AmbientBackground.tsx
components/FloatingCheckout.tsx
components/LandingClient.tsx
components/NumberTicker.tsx
components/PaymentSettings.tsx
components/ProductEditor.tsx
components/ProductModal.tsx
components/ShareButton.tsx
components/StoreInterface.tsx
eslint.config.mjs
lib/supabase-client.ts
lib/supabase.ts
middleware.ts
next.config.ts
package.json
postcss.config.mjs
README.md
tailwind.config.mjs
tsconfig.json
utils/supabaseServer.ts
utils/supabaseStorage.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/admin/actions.ts">
'use server'
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { revalidatePath } from 'next/cache'
import { z } from 'zod'
export type ActionState = {
  success: boolean
  message: string
  timestamp?: number
}
// Validación simple: solo permitimos 'usd' o 'eur'
const CurrencySchema = z.object({
  currency: z.enum(['usd', 'eur']),
})
export async function updateStoreCurrency(prevState: ActionState, formData: FormData): Promise<ActionState> {
  const cookieStore = await cookies()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll(cookiesToSet) {
            try {
                cookiesToSet.forEach(({ name, value, options }) => 
                    cookieStore.set(name, value, options)
                )
            } catch {}
        },
      },
    }
  )
  // 1. Auth Check
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return { success: false, message: 'No autorizado' }
  // 2. Validación
  const currency = formData.get('currency')
  const validated = CurrencySchema.safeParse({ currency })
  if (!validated.success) {
    return { success: false, message: 'Moneda no válida' }
  }
  try {
    // 3. Actualizar la preferencia de la tienda (Tabla 'stores')
    const { error } = await supabase
      .from('stores')
      .update({ currency_type: validated.data.currency })
      .eq('user_id', user.id)
    if (error) throw error
    revalidatePath('/', 'layout') 
    return { 
      success: true, 
      message: `Moneda base cambiada a ${validated.data.currency.toUpperCase()}`,
      timestamp: Date.now()
    }
  } catch (error) {
    return { success: false, message: 'Error al actualizar preferencia' }
  }
}
</file>

<file path="components/admin/RateWidget.tsx">
'use client'
import { useOptimistic, useActionState, startTransition } from 'react'
import { updateStoreCurrency, type ActionState } from '@/app/admin/actions'
import { RefreshCw, DollarSign, Euro, Wallet } from 'lucide-react'
import { clsx } from 'clsx'
interface RateWidgetProps {
  storeCurrency?: 'usd' | 'eur' // Opcional para evitar crash si falta
  usdRate?: number              // Opcional
  eurRate?: number              // Opcional
  lastUpdated?: string | null   // Opcional
}
const initialState: ActionState = {
  success: false,
  message: '',
}
export default function RateWidget({ 
  storeCurrency = 'usd', // Valor por defecto
  usdRate = 0,           // Valor por defecto (Evita undefined)
  eurRate = 0,           // Valor por defecto (Evita undefined)
  lastUpdated = null     
}: RateWidgetProps) {
  // 1. Hook de Server Action (Manejo de estado del formulario)
  const [state, formAction, isPending] = useActionState(updateStoreCurrency, initialState)
  // 2. Optimistic UI (Feedback instantáneo)
  const [optimisticCurrency, setOptimisticCurrency] = useOptimistic(
    storeCurrency,
    (current, newCurrency: 'usd' | 'eur') => newCurrency
  )
  // 3. Lógica de Negocio Segura (Casteo a Número para evitar crash de .toFixed)
  const safeUsd = Number(usdRate) || 0
  const safeEur = Number(eurRate) || 0
  const activeRate = optimisticCurrency === 'usd' ? safeUsd : safeEur
  // Handler para el cambio de moneda
  const handleCurrencyChange = (currency: 'usd' | 'eur') => {
    startTransition(() => {
      setOptimisticCurrency(currency)
      const formData = new FormData()
      formData.append('currency', currency)
      formAction(formData)
    })
  }
  return (
    <section className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 h-full flex flex-col justify-between relative overflow-hidden group hover:border-blue-200 transition-colors">
        {/* Fondo decorativo sutil */}
        <div className="absolute top-0 right-0 w-32 h-32 bg-gray-50 rounded-bl-full -mr-10 -mt-10 z-0 pointer-events-none group-hover:bg-blue-50 transition-colors" />
        <div className="relative z-10">
            <header className="flex items-center gap-3 mb-6">
                <div className="p-3 rounded-2xl bg-gray-900 text-white shadow-lg shadow-gray-900/20">
                    <Wallet size={24} strokeWidth={2} />
                </div>
                <div>
                    <h2 className="text-lg font-black text-gray-900 leading-tight">
                        Tasa Activa
                    </h2>
                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest">
                        {optimisticCurrency === 'usd' ? 'BCV / Paralelo' : 'Banco Central (EUR)'}
                    </p>
                </div>
            </header>
            {/* Display de la Tasa */}
            <div className="mb-8">
                <div className="flex items-baseline gap-1">
                    <span className="text-4xl font-black text-gray-900 tracking-tight">
                        Bs. {activeRate.toFixed(2)}
                    </span>
                </div>
                <div className="flex items-center gap-2 mt-2 text-xs font-medium text-gray-400">
                    <RefreshCw className={clsx("w-3 h-3", isPending && "animate-spin text-blue-600")} />
                    <span>
                        {isPending 
                            ? 'Actualizando...' 
                            : lastUpdated 
                                ? `Actualizado: ${new Date(lastUpdated).toLocaleTimeString('es-VE', {hour: '2-digit', minute:'2-digit'})}` 
                                : 'Esperando sincronización...'
                        }
                    </span>
                </div>
            </div>
        </div>
        {/* Selector de Moneda (Switch) */}
        <div className="relative z-10 bg-gray-50 p-1.5 rounded-2xl flex border border-gray-100">
            <button
                type="button" // Importante: type="button" para evitar submit accidental fuera del form
                onClick={() => handleCurrencyChange('usd')}
                disabled={isPending}
                className={clsx(
                    "flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 cursor-pointer",
                    optimisticCurrency === 'usd'
                        ? "bg-white text-gray-900 shadow-sm ring-1 ring-black/5"
                        : "text-gray-400 hover:text-gray-600"
                )}
            >
                <DollarSign size={16} strokeWidth={3} />
                USD
            </button>
            <button
                type="button"
                onClick={() => handleCurrencyChange('eur')}
                disabled={isPending}
                className={clsx(
                    "flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 cursor-pointer",
                    optimisticCurrency === 'eur'
                        ? "bg-white text-gray-900 shadow-sm ring-1 ring-black/5"
                        : "text-gray-400 hover:text-gray-600"
                )}
            >
                <Euro size={16} strokeWidth={3} />
                EUR
            </button>
        </div>
    </section>
  )
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="app/admin/inventory/page.tsx">
'use client'
import { useState, useEffect, useMemo } from 'react'
import { ArrowLeft, Search, Filter, AlertTriangle, CheckCircle2, XCircle, Package, Save, Loader2, ArrowUpRight } from 'lucide-react'
import Link from 'next/link'
import { getSupabase } from '@/lib/supabase-client'
import Swal from 'sweetalert2'
export default function InventoryPage() {
  const supabase = getSupabase()
  const [loading, setLoading] = useState(true)
  const [items, setItems] = useState<any[]>([])
  const [search, setSearch] = useState('')
  const [filterStatus, setFilterStatus] = useState('all') // all, low, out
  // Estado para control de cambios pendientes (Quick Edit)
  const [pendingChanges, setPendingChanges] = useState<{ [key: string]: number }>({})
  const [savingButtons, setSavingButtons] = useState<{ [key: string]: boolean }>({})
  // 1. CARGAR INVENTARIO (Flatten Data)
  useEffect(() => {
    const fetchInventory = async () => {
      try {
        // Traemos productos y sus variantes
        const { data: products, error } = await supabase
          .from('products')
          .select('id, name, image_url, category, product_variants(*)')
          .order('created_at', { ascending: false })
        if (error) throw error
        // "Aplanamos" la data: Creamos una fila por cada VARIANTE, no por producto
        const flatInventory: any[] = []
        products?.forEach((prod: any) => {
          if (prod.product_variants && prod.product_variants.length > 0) {
            prod.product_variants.forEach((variant: any) => {
              flatInventory.push({
                rowId: variant.id, // ID único para la fila
                productId: prod.id,
                name: prod.name,
                image: variant.variant_image || prod.image_url, // Prioridad foto variante
                category: prod.category,
                // Datos Variante
                variantId: variant.id,
                color: variant.color_name,
                hex: variant.color_hex,
                size: variant.size,
                stock: variant.stock
              })
            })
          } else {
            // Producto sin variantes (Raro en tu sistema actual, pero por si acaso)
            flatInventory.push({
                rowId: prod.id,
                productId: prod.id,
                name: prod.name,
                image: prod.image_url,
                category: prod.category,
                variantId: null,
                color: 'Único',
                hex: '#000000',
                size: 'U',
                stock: 0
            })
          }
        })
        setItems(flatInventory)
      } catch (error) {
        console.error(error)
      } finally {
        setLoading(false)
      }
    }
    fetchInventory()
  }, [])
  // 2. ACTUALIZAR STOCK (Lógica Quick Edit)
  const handleStockChange = (id: string, newVal: string) => {
    const val = parseInt(newVal)
    if (isNaN(val)) return
    setPendingChanges(prev => ({
        ...prev,
        [id]: val
    }))
  }
  const saveStock = async (row: any) => {
    const newStock = pendingChanges[row.rowId]
    if (newStock === undefined) return
    setSavingButtons(prev => ({ ...prev, [row.rowId]: true }))
    try {
        if (row.variantId) {
            // Actualizar Variante
            const { error } = await supabase
                .from('product_variants')
                .update({ stock: newStock })
                .eq('id', row.variantId)
            if (error) throw error
        }
        // Actualizar estado local visualmente
        setItems(prev => prev.map(item => 
            item.rowId === row.rowId ? { ...item, stock: newStock } : item
        ))
        // Limpiar pendiente
        const remaining = { ...pendingChanges }
        delete remaining[row.rowId]
        setPendingChanges(remaining)
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 1500,
            customClass: { popup: 'rounded-xl text-xs font-bold' }
        })
        Toast.fire({ icon: 'success', title: 'Stock Actualizado' })
    } catch (error) {
        Swal.fire('Error', 'No se pudo actualizar', 'error')
    } finally {
        setSavingButtons(prev => ({ ...prev, [row.rowId]: false }))
    }
  }
  // 3. FILTROS Y BÚSQUEDA
  const filteredItems = useMemo(() => {
    return items.filter(item => {
        // Filtro Texto
        const textMatch = 
            item.name.toLowerCase().includes(search.toLowerCase()) ||
            item.color.toLowerCase().includes(search.toLowerCase()) ||
            item.size.toLowerCase().includes(search.toLowerCase())
        // Filtro Estado
        let statusMatch = true
        if (filterStatus === 'low') statusMatch = item.stock > 0 && item.stock <= 3
        if (filterStatus === 'out') statusMatch = item.stock === 0
        return textMatch && statusMatch
    })
  }, [items, search, filterStatus])
  // Estadísticas Rápidas
  const stats = useMemo(() => {
    return {
        total: items.length,
        low: items.filter(i => i.stock > 0 && i.stock <= 3).length,
        out: items.filter(i => i.stock === 0).length
    }
  }, [items])
  return (
    <div className="min-h-screen bg-[#F8F9FA] pb-20 font-sans text-gray-900">
        {/* HEADER */}
        <div className="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-30 px-4 md:px-8 py-4 flex justify-between items-center transition-all">
            <div className="flex items-center gap-4">
                <Link href="/admin" className="p-2 bg-white border border-gray-200 hover:border-black hover:bg-gray-50 rounded-full transition-all group">
                    <ArrowLeft size={18} className="text-gray-500 group-hover:text-black"/>
                </Link>
                <div>
                    <h1 className="font-black text-xl tracking-tight leading-none">Inventario</h1>
                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Control de Stock</p>
                </div>
            </div>
            {/* KPI CHIPS (Solo Desktop) */}
            <div className="hidden md:flex gap-3">
                <div className="px-4 py-2 bg-white border border-gray-100 rounded-xl shadow-sm flex items-center gap-3">
                    <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <div>
                        <span className="block text-[9px] font-bold text-gray-400 uppercase">Agotados</span>
                        <span className="block text-sm font-black text-gray-900 leading-none">{stats.out}</span>
                    </div>
                </div>
                <div className="px-4 py-2 bg-white border border-gray-100 rounded-xl shadow-sm flex items-center gap-3">
                    <div className="w-2 h-2 rounded-full bg-orange-400"></div>
                    <div>
                        <span className="block text-[9px] font-bold text-gray-400 uppercase">Poco Stock</span>
                        <span className="block text-sm font-black text-gray-900 leading-none">{stats.low}</span>
                    </div>
                </div>
            </div>
        </div>
        {/* CONTROLES */}
        <div className="max-w-6xl mx-auto px-4 md:px-8 py-6 space-y-6">
            <div className="flex flex-col md:flex-row gap-4">
                {/* Buscador */}
                <div className="relative flex-1 group">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-black transition-colors" size={18}/>
                    <input 
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        placeholder="Buscar por nombre, color, talla..." 
                        className="w-full bg-white border-none rounded-2xl pl-11 pr-4 py-4 font-medium shadow-sm focus:ring-2 focus:ring-black/5 outline-none placeholder:text-gray-300 transition-all"
                    />
                </div>
                {/* Filtros */}
                <div className="flex bg-gray-200/50 p-1 rounded-2xl">
                    <button onClick={() => setFilterStatus('all')} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${filterStatus === 'all' ? 'bg-white text-black shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Todos</button>
                    <button onClick={() => setFilterStatus('low')} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${filterStatus === 'low' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Poco Stock</button>
                    <button onClick={() => setFilterStatus('out')} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${filterStatus === 'out' ? 'bg-white text-red-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Agotados</button>
                </div>
            </div>
            {/* TABLA ELITE */}
            <div className="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                {loading ? (
                    <div className="p-20 flex justify-center"><Loader2 className="animate-spin text-gray-300"/></div>
                ) : filteredItems.length === 0 ? (
                    <div className="p-10 text-center text-gray-400 font-bold text-sm">No se encontraron items.</div>
                ) : (
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="border-b border-gray-100 text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-50/50">
                                <th className="p-6">Producto</th>
                                <th className="p-6 hidden md:table-cell">Variante</th>
                                <th className="p-6 text-center">Stock Real</th>
                                <th className="p-6 text-right">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredItems.map((item) => {
                                const isPending = pendingChanges[item.rowId] !== undefined
                                const currentStockDisplay = isPending ? pendingChanges[item.rowId] : item.stock
                                const isSaving = savingButtons[item.rowId]
                                // Lógica de Semáforo
                                let statusColor = 'bg-green-100 text-green-700'
                                let StatusIcon = CheckCircle2
                                let statusText = 'Disponible'
                                if (currentStockDisplay === 0) {
                                    statusColor = 'bg-red-50 text-red-600'
                                    StatusIcon = XCircle
                                    statusText = 'Agotado'
                                } else if (currentStockDisplay <= 3) {
                                    statusColor = 'bg-orange-50 text-orange-600'
                                    StatusIcon = AlertTriangle
                                    statusText = 'Bajo'
                                }
                                return (
                                    <tr key={item.rowId} className="group hover:bg-gray-50/50 transition-colors border-b border-gray-50 last:border-0">
                                        {/* COL 1: Producto */}
                                        <td className="p-4 md:p-6">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 rounded-xl bg-gray-100 border border-gray-200 overflow-hidden shrink-0">
                                                    {item.image ? (
                                                        <img src={item.image} className="w-full h-full object-cover mix-blend-multiply" />
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center text-gray-300"><Package size={16}/></div>
                                                    )}
                                                </div>
                                                <div>
                                                    <p className="font-bold text-sm text-gray-900 leading-tight">{item.name}</p>
                                                    <div className="flex items-center gap-2 mt-1 md:hidden">
                                                        {/* Info variante móvil */}
                                                        <span className="w-2 h-2 rounded-full shadow-sm border border-gray-200" style={{background: item.hex}}></span>
                                                        <span className="text-xs text-gray-500 font-mono">{item.size}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        {/* COL 2: Variante (Desktop) */}
                                        <td className="p-6 hidden md:table-cell">
                                            <div className="flex items-center gap-2">
                                                <div className="px-3 py-1.5 rounded-lg border border-gray-200 bg-white shadow-sm flex items-center gap-2">
                                                    <span className="w-3 h-3 rounded-full shadow-sm border border-gray-100" style={{background: item.hex}}></span>
                                                    <span className="text-xs font-bold text-gray-700">{item.color}</span>
                                                </div>
                                                <div className="px-3 py-1.5 rounded-lg border border-gray-200 bg-white shadow-sm">
                                                    <span className="text-xs font-mono font-bold text-gray-600">Talla: {item.size}</span>
                                                </div>
                                            </div>
                                        </td>
                                        {/* COL 3: Stock Quick Edit */}
                                        <td className="p-4 md:p-6">
                                            <div className="flex justify-center">
                                                <div className={`relative flex items-center w-24 md:w-32 transition-all duration-300 ${isPending ? 'scale-105' : ''}`}>
                                                    <input 
                                                        type="number"
                                                        value={currentStockDisplay}
                                                        onChange={(e) => handleStockChange(item.rowId, e.target.value)}
                                                        className={`w-full text-center font-mono font-bold text-lg py-2 rounded-xl border-2 outline-none transition-all ${
                                                            isPending 
                                                                ? 'border-black bg-white shadow-lg text-black' 
                                                                : 'border-transparent bg-gray-100 text-gray-600 group-hover:bg-white group-hover:border-gray-200'
                                                        }`}
                                                    />
                                                    {/* Botón Guardar Flotante */}
                                                    {isPending && (
                                                        <button 
                                                            onClick={() => saveStock(item)}
                                                            disabled={isSaving}
                                                            className="absolute -right-4 -top-3 bg-black text-white p-1.5 rounded-full shadow-lg hover:bg-gray-800 transition-transform hover:scale-110"
                                                        >
                                                            {isSaving ? <Loader2 size={12} className="animate-spin"/> : <Save size={12} />}
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </td>
                                        {/* COL 4: Estado */}
                                        <td className="p-6 text-right">
                                            <div className="flex justify-end items-center gap-4">
                                                <div className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${statusColor}`}>
                                                    <StatusIcon size={12} /> {statusText}
                                                </div>
                                                <Link href={`/admin/product/edit/${item.productId}`} className="text-gray-300 hover:text-black transition-colors" title="Ir al producto">
                                                    <ArrowUpRight size={18} />
                                                </Link>
                                            </div>
                                        </td>
                                    </tr>
                                )
                            })}
                        </tbody>
                    </table>
                )}
            </div>
        </div>
    </div>
  )
}
</file>

<file path="app/admin/layout.tsx">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'
export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const cookieStore = await cookies()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
      },
    }
  )
  // 1. Verificar Usuario
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    redirect('/login')
  }
  // 2. Verificar Suscripción
  const { data: store } = await supabase
    .from('stores')
    .select('subscription_status, trial_ends_at')
    .eq('user_id', user.id)
    .single()
  if (store) {
    const isExpired = store.subscription_status === 'expired'
    // Verificamos si la fecha de prueba ya pasó
    const trialEnded = store.trial_ends_at ? new Date(store.trial_ends_at) < new Date() : false
    const isTrial = store.subscription_status === 'trial'
    // REGLA DE ORO: Si está expirado O (está en trial Y el tiempo se acabó) -> A LA CÁRCEL
    if (isExpired || (isTrial && trialEnded)) {
      redirect('/subscription')
    }
  }
  // Si todo está bien, dejamos pasar
  return (
    <>
      {children}
    </>
  )
}
</file>

<file path="app/admin/orders/page.tsx">
'use client'
import { useState, useEffect, useMemo } from 'react'
import { ArrowLeft, Search, CheckCircle2, Clock, Truck, XCircle, Package, MessageCircle, ChevronDown, ChevronUp, DollarSign, MapPin, Loader2 } from 'lucide-react'
import Link from 'next/link'
import { getSupabase } from '@/lib/supabase-client'
import Swal from 'sweetalert2'
// --- BADGE COMPONENT (Optimizado) ---
const StatusBadge = ({ status }: { status: string }) => {
  const styles: any = {
    pending: 'bg-yellow-50 text-yellow-700 border-yellow-200',
    paid: 'bg-emerald-50 text-emerald-700 border-emerald-200',
    shipped: 'bg-blue-50 text-blue-700 border-blue-200',
    completed: 'bg-gray-100 text-gray-600 border-gray-200',
    cancelled: 'bg-red-50 text-red-700 border-red-200'
  }
  const labels: any = {
    pending: 'Pendiente',
    paid: 'Pagado',
    shipped: 'Enviado',
    completed: 'Entregado',
    cancelled: 'Cancelado'
  }
  const Icon = status === 'pending' ? Clock : status === 'paid' ? DollarSign : status === 'shipped' ? Truck : status === 'cancelled' ? XCircle : CheckCircle2
  return (
    <span className={`flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide border ${styles[status] || styles.pending}`}>
      <Icon size={12} strokeWidth={3} />
      {labels[status] || status}
    </span>
  )
}
export default function OrdersPage() {
  const supabase = getSupabase()
  const [loading, setLoading] = useState(true)
  const [orders, setOrders] = useState<any[]>([])
  const [search, setSearch] = useState('')
  const [filterStatus, setFilterStatus] = useState('all') 
  const [expandedOrderId, setExpandedOrderId] = useState<string | null>(null)
  // ESTADO NUEVO: Controla qué botón específico se está actualizando para mostrar spinner
  const [updatingId, setUpdatingId] = useState<string | null>(null)
  const fetchOrders = async () => {
    // Solo mostramos loading global la primera vez
    if (orders.length === 0) setLoading(true)
    try {
      const { data, error } = await supabase
        .from('orders')
        .select(`*, order_items (*)`)
        .order('created_at', { ascending: false })
      if (error) throw error
      setOrders(data || [])
    } catch (error) {
      console.error(error)
    } finally {
      setLoading(false)
    }
  }
  useEffect(() => {
    fetchOrders()
  }, [])
  const updateStatus = async (orderId: string, newStatus: string) => {
    setUpdatingId(orderId) // Activar spinner en la UI
    const previousOrders = [...orders] // Guardar estado anterior por si falla (Rollback)
    try {
        // 1. Actualización Optimista (Visual inmediata)
        setOrders(prev => prev.map(o => o.id === orderId ? { ...o, status: newStatus } : o))
        // 2. Actualización Real en BD
        const { error } = await supabase
            .from('orders')
            .update({ status: newStatus })
            .eq('id', orderId)
        if (error) throw error
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 1500,
            customClass: { popup: 'rounded-xl font-bold text-xs' }
        })
        Toast.fire({ icon: 'success', title: 'Estado Actualizado' })
    } catch (error: any) {
        // 3. Rollback si falla
        setOrders(previousOrders)
        console.error("Update error:", error)
        Swal.fire('Error', 'No se pudo actualizar el estado. Verifica tu conexión o permisos.', 'error')
    } finally {
        setUpdatingId(null)
    }
  }
  const filteredOrders = useMemo(() => {
    return orders.filter(order => {
        const matchesSearch = 
            order.customer_name?.toLowerCase().includes(search.toLowerCase()) ||
            order.order_number?.toString().includes(search)
        const matchesFilter = filterStatus === 'all' || order.status === filterStatus
        return matchesSearch && matchesFilter
    })
  }, [orders, search, filterStatus])
  // --- CÁLCULOS INTELIGENTES ---
  const getBsAmount = (order: any) => {
      if (order.total_bs && Number(order.total_bs) > 0) return Number(order.total_bs)
      return Number(order.total_usd || 0) * Number(order.exchange_rate || 0)
  }
  const stats = useMemo(() => {
    const today = new Date().toISOString().split('T')[0]
    const todayOrders = orders.filter(o => o.created_at.startsWith(today) && o.status !== 'cancelled')
    return {
        total: orders.length,
        pending: orders.filter(o => o.status === 'pending').length,
        salesTodayUSD: todayOrders.reduce((acc, o) => acc + Number(o.total_usd || 0), 0),
        salesTodayBs: todayOrders.reduce((acc, o) => acc + getBsAmount(o), 0)
    }
  }, [orders])
  return (
    <div className="min-h-screen bg-[#F8F9FA] pb-20 font-sans text-gray-900">
        {/* HEADER */}
        <div className="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-30 px-4 md:px-8 py-4 flex justify-between items-center transition-all">
            <div className="flex items-center gap-4">
                <Link href="/admin" className="p-2 bg-white border border-gray-200 hover:border-black hover:bg-gray-50 rounded-full transition-all group">
                    <ArrowLeft size={18} className="text-gray-500 group-hover:text-black"/>
                </Link>
                <div>
                    <h1 className="font-black text-xl tracking-tight leading-none">Pedidos</h1>
                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Gestión de Ventas</p>
                </div>
            </div>
            <button onClick={fetchOrders} className="p-2 hover:bg-gray-100 rounded-full transition-colors" title="Refrescar">
                <Clock size={18} className="text-gray-400"/>
            </button>
        </div>
        {/* CONTENT */}
        <div className="max-w-5xl mx-auto px-4 md:px-8 py-8 space-y-8">
            {/* KPI CARDS */}
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Pendientes</p>
                    <div className="flex items-center gap-2">
                        <span className="text-2xl font-black text-yellow-600">{stats.pending}</span>
                        {stats.pending > 0 && <span className="flex h-2 w-2 relative"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span><span className="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span></span>}
                    </div>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center">
                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Ventas Hoy</p>
                    <p className="text-2xl font-black text-gray-900 leading-none">${stats.salesTodayUSD.toFixed(2)}</p>
                    <p className="text-xs font-mono font-bold text-gray-400 mt-1">
                        Bs {stats.salesTodayBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                    </p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm col-span-2 md:col-span-1">
                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Total Histórico</p>
                    <p className="text-2xl font-black text-gray-900">{stats.total} <span className="text-sm text-gray-400 font-medium">Pedidos</span></p>
                </div>
            </div>
            {/* FILTERS & SEARCH */}
            <div className="flex flex-col md:flex-row gap-4 justify-between items-end md:items-center">
                 <div className="flex bg-gray-200/50 p-1 rounded-xl overflow-x-auto no-scrollbar w-full md:w-auto">
                    {['all', 'pending', 'paid', 'shipped'].map(status => (
                        <button 
                            key={status}
                            onClick={() => setFilterStatus(status)}
                            className={`px-4 py-2 rounded-lg text-xs font-bold capitalize transition-all whitespace-nowrap ${filterStatus === status ? 'bg-white text-black shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                        >
                            {status === 'all' ? 'Todos' : status === 'pending' ? 'Pendientes' : status === 'paid' ? 'Pagados' : 'Enviados'}
                        </button>
                    ))}
                </div>
                <div className="relative group w-full md:w-64">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-black transition-colors" size={16}/>
                    <input 
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        placeholder="Buscar pedido o cliente..." 
                        className="w-full bg-white border border-gray-200 rounded-xl pl-9 pr-4 py-2.5 text-sm font-medium focus:border-black focus:ring-1 focus:ring-black outline-none transition-all"
                    />
                </div>
            </div>
            {/* ORDERS LIST */}
            <div className="space-y-4">
                {loading && orders.length === 0 ? (
                     <div className="text-center py-20"><Loader2 className="animate-spin text-gray-300 mx-auto" size={32}/></div>
                ) : filteredOrders.length === 0 ? (
                    <div className="text-center py-20 bg-white rounded-3xl border border-dashed border-gray-200">
                        <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300"><Package size={24}/></div>
                        <p className="text-gray-400 font-bold text-sm">No se encontraron pedidos.</p>
                    </div>
                ) : (
                    filteredOrders.map(order => {
                        const bsAmount = getBsAmount(order)
                        const isUpdating = updatingId === order.id // Check if this card is processing
                        return (
                        <div key={order.id} className="bg-white rounded-2xl border border-gray-100 shadow-sm hover:border-gray-300 transition-all overflow-hidden group">
                            {/* CARD HEADER */}
                            <div 
                                onClick={() => setExpandedOrderId(expandedOrderId === order.id ? null : order.id)}
                                className="p-5 flex flex-col md:flex-row md:items-center gap-4 cursor-pointer relative"
                            >   
                                {/* Col 1 */}
                                <div className="flex items-center justify-between md:justify-start gap-4 md:w-1/4">
                                    <div>
                                        <p className="text-xs font-black text-gray-900">#{order.order_number}</p>
                                        <p className="text-[10px] text-gray-400 font-mono">{new Date(order.created_at).toLocaleDateString()}</p>
                                    </div>
                                    <StatusBadge status={order.status} />
                                </div>
                                {/* Col 2 */}
                                <div className="flex-1">
                                    <p className="font-bold text-sm text-gray-900">{order.customer_name}</p>
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                        <span className="bg-gray-100 px-1.5 py-0.5 rounded text-[10px] font-mono uppercase">{order.payment_method}</span>
                                        <span>&bull;</span>
                                        <span className="bg-gray-100 px-1.5 py-0.5 rounded text-[10px] font-mono uppercase">{order.shipping_method === 'pickup' ? 'Retiro' : 'Envío'}</span>
                                    </div>
                                </div>
                                {/* Col 3 */}
                                <div className="text-right">
                                    <p className="font-black text-lg text-gray-900">${order.total_usd}</p>
                                    <p className="text-[10px] font-mono font-bold text-gray-400">
                                        Bs {bsAmount.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    </p>
                                </div>
                                <div className="absolute right-2 top-2 md:relative md:right-0 md:top-0 text-gray-300 group-hover:text-black transition-colors">
                                    {expandedOrderId === order.id ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
                                </div>
                            </div>
                            {/* CARD DETAILS */}
                            {expandedOrderId === order.id && (
                                <div className="border-t border-gray-100 bg-gray-50/50 p-5 animate-in slide-in-from-top-2">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        {/* Products */}
                                        <div className="space-y-3">
                                            <h4 className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Productos ({order.order_items.length})</h4>
                                            {order.order_items.map((item: any) => (
                                                <div key={item.id} className="flex justify-between items-start text-sm bg-white p-3 rounded-xl border border-gray-100">
                                                    <div>
                                                        <p className="font-bold text-gray-900">{item.product_name}</p>
                                                        <p className="text-xs text-gray-500">{item.variant_info}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="font-mono font-bold text-gray-900">x{item.quantity}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        {/* Actions */}
                                        <div className="space-y-6">
                                            <div>
                                                <h4 className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Datos de Entrega</h4>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 space-y-2">
                                                    <div className="flex items-start gap-2">
                                                        <MapPin size={14} className="text-gray-400 mt-0.5 shrink-0"/>
                                                        <p className="text-xs font-medium text-gray-700">{order.delivery_info || 'Sin dirección'}</p>
                                                    </div>
                                                    {order.customer_phone && (
                                                        <div className="flex items-center gap-2">
                                                            <MessageCircle size={14} className="text-green-500 shrink-0"/>
                                                            <a 
                                                                href={`https://wa.me/${order.customer_phone.replace(/\D/g, '')}`} 
                                                                target="_blank" 
                                                                className="text-xs font-bold text-green-600 hover:underline"
                                                            >
                                                                Contactar al Cliente
                                                            </a>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <div>
                                                <h4 className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Cambiar Estado</h4>
                                                <div className="flex flex-wrap gap-2">
                                                    {['pending', 'paid', 'shipped', 'cancelled'].map(status => (
                                                        <button
                                                            key={status}
                                                            onClick={() => updateStatus(order.id, status)}
                                                            disabled={order.status === status || isUpdating}
                                                            className={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wide border transition-all flex items-center gap-2 ${
                                                                order.status === status 
                                                                    ? 'bg-black text-white border-black opacity-50 cursor-not-allowed' 
                                                                    : 'bg-white text-gray-600 border-gray-200 hover:border-black hover:text-black'
                                                            }`}
                                                        >
                                                            {/* Spinner pequeño si esta tarjeta específica se está actualizando */}
                                                            {isUpdating && <Loader2 size={10} className="animate-spin"/>}
                                                            {status === 'pending' ? 'Pendiente' : status === 'paid' ? 'Pagado' : status === 'shipped' ? 'Enviado' : 'Cancelar'}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )})
                )}
            </div>
        </div>
        <style jsx global>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
    </div>
  )
}
</file>

<file path="app/admin/settings/page.tsx">
'use client'
import { useState, useEffect } from 'react'
import { ArrowLeft, Save, CreditCard, Truck, Loader2, Check, Smartphone, Bitcoin, DollarSign, MapPin, Box } from 'lucide-react'
import Link from 'next/link'
import { getSupabase } from '@/lib/supabase-client'
import Swal from 'sweetalert2'
export default function SettingsPage() {
  const supabase = getSupabase()
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [storeId, setStoreId] = useState('')
  // --- ESTADO DE PAGOS ---
  const [payments, setPayments] = useState({
    pago_movil: { active: false, details: '' }, // Tlf + CI + Banco
    zelle: { active: false, details: '' },      // Email
    binance: { active: false, details: '' },    // Pay ID / Email
    zinli: { active: false, details: '' },      // Email
    cash: { active: false, details: '' }        // Instrucciones (Ej: Billete buen estado)
  })
  // --- ESTADO DE ENVÍOS ---
  const [shipping, setShipping] = useState({
    pickup: { active: true, details: '' }, // Dirección de entrega personal
    mrw: { active: false, price: 0 },
    zoom: { active: false, price: 0 },
    tealca: { active: false, price: 0 }
  })
  // 1. CARGAR CONFIGURACIÓN
  useEffect(() => {
    const fetchSettings = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return
        const { data: store } = await supabase
            .from('stores')
            .select('*')
            .eq('user_id', user.id)
            .single()
        if (store) {
            setStoreId(store.id)
            // Fusionar con defaults para evitar errores si viene null
            if (store.payment_config) setPayments({ ...payments, ...store.payment_config })
            if (store.shipping_config) setShipping({ ...shipping, ...store.shipping_config })
        }
      } catch (error) {
        console.error(error)
      } finally {
        setLoading(false)
      }
    }
    fetchSettings()
  }, [])
  // 2. GUARDAR
  const handleSave = async () => {
    setSaving(true)
    try {
        const { error } = await supabase
            .from('stores')
            .update({
                payment_config: payments,
                shipping_config: shipping
            })
            .eq('id', storeId)
        if (error) throw error
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 1500,
            customClass: { popup: 'rounded-xl font-bold' }
        })
        Toast.fire({ icon: 'success', title: 'Configuración Guardada' })
    } catch (error) {
        Swal.fire('Error', 'No se pudo guardar', 'error')
    } finally {
        setSaving(false)
    }
  }
  // Helper para toggles
  const togglePayment = (key: keyof typeof payments) => {
    setPayments(prev => ({ ...prev, [key]: { ...prev[key], active: !prev[key].active } }))
  }
  const toggleShipping = (key: keyof typeof shipping) => {
    setShipping(prev => ({ ...prev, [key]: { ...prev[key], active: !prev[key].active } }))
  }
  if (loading) return <div className="h-screen flex items-center justify-center bg-[#F8F9FA]"><Loader2 className="animate-spin"/></div>
  return (
    <div className="min-h-screen bg-[#F8F9FA] pb-20 font-sans text-gray-900">
        {/* HEADER */}
        <div className="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-30 px-4 md:px-8 py-4 flex justify-between items-center transition-all">
            <div className="flex items-center gap-4">
                <Link href="/admin" className="p-2 bg-white border border-gray-200 hover:border-black hover:bg-gray-50 rounded-full transition-all group">
                    <ArrowLeft size={18} className="text-gray-500 group-hover:text-black"/>
                </Link>
                <div>
                    <h1 className="font-black text-xl tracking-tight leading-none">Ajustes</h1>
                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Pagos y Envíos</p>
                </div>
            </div>
            <button onClick={handleSave} disabled={saving} className="bg-black text-white px-6 py-2.5 rounded-full font-bold text-sm hover:bg-gray-800 transition-all flex items-center gap-2 shadow-lg">
                {saving ? <Loader2 className="animate-spin" size={16}/> : <><Save size={16}/> Guardar</>}
            </button>
        </div>
        <div className="max-w-4xl mx-auto px-4 md:px-8 py-8 space-y-8">
            {/* SECCIÓN 1: MÉTODOS DE PAGO */}
            <section className="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
                <h2 className="text-lg font-black text-gray-900 mb-6 flex items-center gap-2">
                    <CreditCard className="text-blue-600" size={20}/> Métodos de Pago
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* PAGO MÓVIL */}
                    <div className={`p-4 rounded-2xl border-2 transition-all ${payments.pago_movil.active ? 'border-blue-500 bg-blue-50/30' : 'border-gray-100 bg-gray-50'}`}>
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-2">
                                <Smartphone size={18} className={payments.pago_movil.active ? 'text-blue-600' : 'text-gray-400'}/>
                                <span className="font-bold text-sm">Pago Móvil</span>
                            </div>
                            <button onClick={() => togglePayment('pago_movil')} className={`w-10 h-6 rounded-full p-1 transition-colors ${payments.pago_movil.active ? 'bg-blue-600' : 'bg-gray-300'}`}>
                                <div className={`w-4 h-4 rounded-full bg-white transition-transform ${payments.pago_movil.active ? 'translate-x-4' : ''}`}></div>
                            </button>
                        </div>
                        {payments.pago_movil.active && (
                            <input 
                                value={payments.pago_movil.details}
                                onChange={(e) => setPayments({...payments, pago_movil: {...payments.pago_movil, details: e.target.value}})}
                                placeholder="Ej: 0412-1234567, CI 123456, Banesco"
                                className="w-full text-xs p-2 rounded-lg border border-gray-200 focus:border-blue-500 outline-none"
                            />
                        )}
                    </div>
                    {/* ZELLE */}
                    <div className={`p-4 rounded-2xl border-2 transition-all ${payments.zelle.active ? 'border-purple-500 bg-purple-50/30' : 'border-gray-100 bg-gray-50'}`}>
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-2">
                                <DollarSign size={18} className={payments.zelle.active ? 'text-purple-600' : 'text-gray-400'}/>
                                <span className="font-bold text-sm">Zelle</span>
                            </div>
                            <button onClick={() => togglePayment('zelle')} className={`w-10 h-6 rounded-full p-1 transition-colors ${payments.zelle.active ? 'bg-purple-600' : 'bg-gray-300'}`}>
                                <div className={`w-4 h-4 rounded-full bg-white transition-transform ${payments.zelle.active ? 'translate-x-4' : ''}`}></div>
                            </button>
                        </div>
                        {payments.zelle.active && (
                            <input 
                                value={payments.zelle.details}
                                onChange={(e) => setPayments({...payments, zelle: {...payments.zelle, details: e.target.value}})}
                                placeholder="Ej: micorreo@gmail.com (Titular)"
                                className="w-full text-xs p-2 rounded-lg border border-gray-200 focus:border-purple-500 outline-none"
                            />
                        )}
                    </div>
                    {/* BINANCE */}
                    <div className={`p-4 rounded-2xl border-2 transition-all ${payments.binance.active ? 'border-yellow-500 bg-yellow-50/30' : 'border-gray-100 bg-gray-50'}`}>
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-2">
                                <Bitcoin size={18} className={payments.binance.active ? 'text-yellow-600' : 'text-gray-400'}/>
                                <span className="font-bold text-sm">Binance Pay</span>
                            </div>
                            <button onClick={() => togglePayment('binance')} className={`w-10 h-6 rounded-full p-1 transition-colors ${payments.binance.active ? 'bg-yellow-500' : 'bg-gray-300'}`}>
                                <div className={`w-4 h-4 rounded-full bg-white transition-transform ${payments.binance.active ? 'translate-x-4' : ''}`}></div>
                            </button>
                        </div>
                        {payments.binance.active && (
                            <input 
                                value={payments.binance.details}
                                onChange={(e) => setPayments({...payments, binance: {...payments.binance, details: e.target.value}})}
                                placeholder="Ej: Pay ID o Correo"
                                className="w-full text-xs p-2 rounded-lg border border-gray-200 focus:border-yellow-500 outline-none"
                            />
                        )}
                    </div>
                    {/* CASH */}
                    <div className={`p-4 rounded-2xl border-2 transition-all ${payments.cash.active ? 'border-green-500 bg-green-50/30' : 'border-gray-100 bg-gray-50'}`}>
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-2">
                                <DollarSign size={18} className={payments.cash.active ? 'text-green-600' : 'text-gray-400'}/>
                                <span className="font-bold text-sm">Efectivo (Divisa)</span>
                            </div>
                            <button onClick={() => togglePayment('cash')} className={`w-10 h-6 rounded-full p-1 transition-colors ${payments.cash.active ? 'bg-green-600' : 'bg-gray-300'}`}>
                                <div className={`w-4 h-4 rounded-full bg-white transition-transform ${payments.cash.active ? 'translate-x-4' : ''}`}></div>
                            </button>
                        </div>
                        {payments.cash.active && (
                            <input 
                                value={payments.cash.details}
                                onChange={(e) => setPayments({...payments, cash: {...payments.cash, details: e.target.value}})}
                                placeholder="Ej: Solo billetes en buen estado"
                                className="w-full text-xs p-2 rounded-lg border border-gray-200 focus:border-green-500 outline-none"
                            />
                        )}
                    </div>
                </div>
            </section>
            {/* SECCIÓN 2: MÉTODOS DE ENVÍO */}
            <section className="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
                <h2 className="text-lg font-black text-gray-900 mb-6 flex items-center gap-2">
                    <Truck className="text-black" size={20}/> Logística y Envíos
                </h2>
                <div className="space-y-4">
                    {/* PICKUP */}
                    <div className="flex items-center justify-between p-4 border border-gray-100 rounded-2xl hover:border-black transition-colors">
                        <div className="flex items-center gap-3">
                            <div className="bg-gray-50 p-2 rounded-lg"><MapPin size={20}/></div>
                            <div>
                                <p className="font-bold text-sm">Entrega Personal (Pickup)</p>
                                {shipping.pickup.active && <input 
                                    value={shipping.pickup.details}
                                    onChange={(e) => setShipping({...shipping, pickup: {...shipping.pickup, details: e.target.value}})}
                                    placeholder="Dirección de tu tienda/casa..."
                                    className="mt-1 text-xs border-b border-gray-200 py-2 px-1.5 rounded-lg focus:border-black outline-none w-full md:w-64"
                                />}
                            </div>
                        </div>
                        <button onClick={() => toggleShipping('pickup')} className={`w-10 h-6 shrink-0 rounded-full p-1 transition-colors ${shipping.pickup.active ? 'bg-black' : 'bg-gray-300'}`}>
                            <div className={`w-4 h-4 rounded-full bg-white transition-transform ${shipping.pickup.active ? 'translate-x-4' : ''}`}></div>
                        </button>
                    </div>
                    {/* COURIERS */}
                    {['mrw', 'zoom', 'tealca'].map((courier) => (
                        <div key={courier} className="flex items-center justify-between p-4 border border-gray-100 rounded-2xl hover:border-black transition-colors">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-50 p-2 rounded-lg text-blue-600"><Box size={20}/></div>
                                <div>
                                    <p className="font-bold text-sm uppercase">{courier}</p>
                                    <p className="text-xs text-gray-400">Envío nacional cobro en destino</p>
                                </div>
                            </div>
                            <button onClick={() => toggleShipping(courier as any)} className={`w-10 h-6 shrink-0 rounded-full p-1 transition-colors ${shipping[courier as keyof typeof shipping].active ? 'bg-blue-600' : 'bg-gray-300'}`}>
                                <div className={`w-4 h-4 rounded-full bg-white transition-transform ${shipping[courier as keyof typeof shipping].active ? 'translate-x-4' : ''}`}></div>
                            </button>
                        </div>
                    ))}
                </div>
            </section>
        </div>
    </div>
  )
}
</file>

<file path="components/NumberTicker.tsx">
"use client";
import { useEffect, useRef } from "react";
import { useInView, useMotionValue, useSpring } from "framer-motion";
export default function NumberTicker({ value }: { value: number }) {
  const ref = useRef<HTMLSpanElement>(null);
  const motionValue = useMotionValue(0);
  const springValue = useSpring(motionValue, {
    damping: 30,
    stiffness: 100,
  });
  const isInView = useInView(ref, { once: true, margin: "0px" });
  useEffect(() => {
    if (isInView) {
      motionValue.set(value);
    }
  }, [motionValue, isInView, value]);
  useEffect(() => {
    springValue.on("change", (latest) => {
      if (ref.current) {
        // Formato Venezuela: 1.234,56
        ref.current.textContent = Intl.NumberFormat("es-VE", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(latest);
      }
    });
  }, [springValue]);
  return <span ref={ref} className="font-mono tabular-nums tracking-tight" />;
}
</file>

<file path="components/ProductEditor.tsx">
'use client'
import { useState, useEffect, useRef, useMemo } from 'react'
import { ArrowLeft, Upload, Plus, Save, Loader2, DollarSign, Trash2, X, Package, Box, Tag, AlertCircle } from 'lucide-react'
import { useRouter } from 'next/navigation'
import { getSupabase } from '@/lib/supabase-client'
import Swal from 'sweetalert2'
interface ProductEditorProps {
  productId?: string
  rates: { usd: number, eur: number }
  storeSettings: { id: string, currency: string }
}
export default function ProductEditor({ productId, rates, storeSettings }: ProductEditorProps) {
  const router = useRouter()
  const supabase = getSupabase()
  const mainImageInputRef = useRef<HTMLInputElement>(null)
  const variantImageInputRef = useRef<HTMLInputElement>(null)
  const [loading, setLoading] = useState(!!productId)
  const [saving, setSaving] = useState(false)
  const [uploading, setUploading] = useState(false) 
  // LOGICA DE MONEDA
  const isEur = storeSettings.currency === 'eur'
  const activeRate = isEur ? rates.eur : rates.usd
  const rateLabel = isEur ? 'Tasa Euro' : 'Tasa BCV'
  const [formData, setFormData] = useState({
    name: '',
    category: '',
    description: '',
    image_url: '',
    price: 0,    // Precio Cash (Divisa)
    penalty: 0,  // Margen para Bs
    status: 'active'
  })
  const [variants, setVariants] = useState<any[]>([])
  const [deletedVariantIds, setDeletedVariantIds] = useState<string[]>([])
  const [variantInput, setVariantInput] = useState({
    colorName: '',
    colorHex: '#000000',
    sizes: '',
    defaultStock: 10,
    images: [] as string[]
  })
  // --- MOTOR DE CÁLCULO DE DESCUENTOS ---
  const math = useMemo(() => {
      const cashPrice = Number(formData.price) || 0
      const markup = Number(formData.penalty) || 0
      // 1. Precio de Lista (Full)
      const listPrice = cashPrice + markup
      // 2. Porcentaje de Descuento (Para el Badge)
      // Fórmula: (Markup / ListPrice) * 100
      const discountPercent = listPrice > 0 ? Math.round((markup / listPrice) * 100) : 0
      // 3. Referencia en Bolívares
      // Siempre se calcula sobre el Precio de Lista * Tasa Seleccionada
      const refBs = listPrice * activeRate
      return { listPrice, discountPercent, refBs }
  }, [formData.price, formData.penalty, activeRate])
  // CARGA INICIAL
  useEffect(() => {
    if (productId) {
      const fetchProduct = async () => {
        const { data: product, error } = await supabase
          .from('products')
          .select(`*, product_variants(*)`)
          .eq('id', productId)
          .single()
        if (error || !product) {
          Swal.fire('Error', 'Producto no encontrado', 'error')
          router.push('/admin/inventory')
          return
        }
        setFormData({
          name: product.name,
          category: product.category,
          description: product.description || '',
          image_url: product.image_url || '',
          price: product.usd_cash_price || 0,
          penalty: product.usd_penalty || 0,
          status: product.status || 'active'
        })
        if (product.product_variants) {
           setVariants(product.product_variants.sort((a: any, b: any) => a.created_at.localeCompare(b.created_at)))
        }
        setLoading(false)
      }
      fetchProduct()
    } else {
        setLoading(false)
    }
  }, [productId])
  // SUBIDA DE IMÁGENES
  const handleImageUpload = async (file: File, target: 'main' | 'variant') => {
      try {
          setUploading(true)
          if (!file.type.startsWith('image/')) throw new Error('Solo imágenes')
          if (file.size > 5 * 1024 * 1024) throw new Error('Máx 5MB')
          const fileExt = file.name.split('.').pop()
          const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`
          const filePath = `${fileName}`
          const { error } = await supabase.storage.from('variants').upload(filePath, file)
          if (error) throw error
          const { data: { publicUrl } } = supabase.storage.from('variants').getPublicUrl(filePath)
          if (target === 'main') {
              setFormData(prev => ({ ...prev, image_url: publicUrl }))
          } else {
              if (variantInput.images.length >= 3) return Swal.fire('Límite', 'Máx 3 fotos', 'warning')
              setVariantInput(prev => ({ ...prev, images: [...prev.images, publicUrl] }))
          }
      } catch (error: any) {
          Swal.fire('Error', error.message, 'error')
      } finally {
          setUploading(false)
      }
  }
  const removeImageFromVariantInput = (index: number) => {
      const newImages = [...variantInput.images]
      newImages.splice(index, 1)
      setVariantInput({ ...variantInput, images: newImages })
  }
  const addVariantGroup = () => {
     if (!variantInput.colorName) return Swal.fire('Falta Color', 'Define un nombre', 'warning')
     if (!variantInput.sizes) return Swal.fire('Faltan Tallas', 'Ingresa tallas', 'warning')
     const sizeList = variantInput.sizes.split(',').map(s => s.trim()).filter(Boolean)
     const newVariants = sizeList.map(s => ({
         id: `temp-${crypto.randomUUID()}`, 
         color_name: variantInput.colorName,
         color_hex: variantInput.colorHex,
         size: s, 
         stock: variantInput.defaultStock,
         gallery: variantInput.images, 
         variant_image: variantInput.images[0] || '' 
     }))
     setVariants([...variants, ...newVariants])
     setVariantInput({ ...variantInput, sizes: '', defaultStock: 10, images: [] }) 
     Swal.fire({ icon: 'success', title: 'Agregado', toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 })
  }
  const removeVariant = (id: string) => {
      if (!id.startsWith('temp-')) setDeletedVariantIds(prev => [...prev, id])
      setVariants(variants.filter(v => v.id !== id))
  }
  const handleSave = async () => {
      if (!formData.name) return Swal.fire('Error', 'Falta el nombre', 'warning')
      if (formData.price <= 0) return Swal.fire('Error', 'Precio inválido', 'warning')
      setSaving(true)
      try {
          const { data: { user } } = await supabase.auth.getUser()
          if (!user) throw new Error("No auth")
          const payload = {
              name: formData.name,
              category: formData.category,
              description: formData.description,
              image_url: formData.image_url,
              usd_cash_price: formData.price, 
              usd_penalty: formData.penalty,
              status: formData.status,
              user_id: user.id,    
              store_id: storeSettings.id
          }
          let currentId = productId
          if (currentId) {
              const { error } = await supabase.from('products').update(payload).eq('id', currentId)
              if (error) throw error
          } else {
              const { data, error } = await supabase.from('products').insert(payload).select().single()
              if (error) throw error
              currentId = data.id
          }
          if (currentId) {
              if (deletedVariantIds.length > 0) {
                  await supabase.from('product_variants').delete().in('id', deletedVariantIds)
              }
              const toInsert: any[] = []
              const toUpdate: any[] = []
              variants.forEach(v => {
                  const vPayload = {
                      product_id: currentId,
                      color_name: v.color_name,
                      color_hex: v.color_hex,
                      size: v.size,
                      stock: v.stock,
                      variant_image: v.variant_image, 
                      gallery: v.gallery 
                  }
                  if (v.id.startsWith('temp-')) toInsert.push(vPayload)
                  else toUpdate.push({ ...vPayload, id: v.id })
              })
              if (toInsert.length > 0) await supabase.from('product_variants').insert(toInsert)
              if (toUpdate.length > 0) await supabase.from('product_variants').upsert(toUpdate)
          }
          Swal.fire({ title: '¡Guardado!', icon: 'success', confirmButtonColor: '#000'})
          router.push('/admin/inventory')
      } catch (error: any) {
          Swal.fire('Error', error.message, 'error')
      } finally {
          setSaving(false)
      }
  }
  if (loading) return <div className="min-h-screen flex items-center justify-center bg-[#F8F9FA]"><Loader2 className="animate-spin text-gray-400" size={32}/></div>
  return (
    <div className="min-h-screen bg-[#F8F9FA] pb-32 font-sans text-gray-900 selection:bg-black selection:text-white">
      {/* HEADER */}
      <div className="bg-white/90 backdrop-blur-xl border-b border-gray-200 sticky top-0 z-30 px-4 md:px-6 py-4 flex justify-between items-center transition-all shadow-sm">
        <div className="flex items-center gap-3">
            <button onClick={() => router.back()} className="p-2 -ml-2 hover:bg-gray-100 rounded-full transition-colors group">
                <ArrowLeft size={20} className="text-gray-500 group-hover:text-black"/>
            </button>
            <div>
                <h1 className="font-black text-lg md:text-xl leading-none">{productId ? 'Editar' : 'Nuevo Producto'}</h1>
                <div className="flex items-center gap-2 mt-1">
                    <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Inventario</span>
                    <span className={`text-[9px] px-1.5 py-0.5 rounded font-bold uppercase ${isEur ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
                        Calculando en {isEur ? 'Euros' : 'Dólares'}
                    </span>
                </div>
            </div>
        </div>
        <div className="flex items-center gap-2">
             <button onClick={() => router.back()} className="hidden md:block px-4 py-2 text-xs font-bold text-gray-500 hover:text-black transition-colors uppercase tracking-wide">Cancelar</button>
             <button onClick={handleSave} disabled={saving} className="bg-black text-white px-5 py-2.5 rounded-xl font-bold text-xs md:text-sm shadow-xl hover:scale-105 active:scale-95 transition-all flex items-center gap-2 disabled:opacity-70">
                {saving ? <Loader2 size={16} className="animate-spin"/> : <Save size={16} strokeWidth={2.5}/>}
                <span>Guardar</span>
             </button>
        </div>
      </div>
      <div className="max-w-[1200px] mx-auto px-4 md:px-6 py-6 md:py-10">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-10 items-start">
            {/* IZQUIERDA (INPUTS & MATRIZ) */}
            <div className="lg:col-span-8 space-y-6">
                {/* 1. INFO PRINCIPAL */}
                <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-6 md:gap-8">
                    {/* FOTO */}
                    <div className="w-full md:w-1/3 shrink-0">
                        <input type="file" ref={mainImageInputRef} className="hidden" accept="image/*" onChange={(e) => e.target.files?.[0] && handleImageUpload(e.target.files[0], 'main')}/>
                        <div onClick={() => mainImageInputRef.current?.click()} className={`aspect-square bg-gray-50 rounded-2xl border-2 border-dashed ${uploading ? 'border-blue-400 animate-pulse' : 'border-gray-200 hover:border-black'} flex flex-col items-center justify-center overflow-hidden relative group cursor-pointer transition-all`}>
                            {formData.image_url ? (
                                <img src={formData.image_url} className="w-full h-full object-contain p-4 mix-blend-multiply group-hover:scale-105 transition-transform duration-500" />
                            ) : (
                                <div className="text-center p-4">
                                    <div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center mx-auto mb-3 text-gray-400 shadow-sm border border-gray-100">
                                        {uploading ? <Loader2 className="animate-spin"/> : <Upload size={20}/>}
                                    </div>
                                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-black">Subir Foto</p>
                                </div>
                            )}
                        </div>
                    </div>
                    {/* INPUTS TEXTO */}
                    <div className="flex-1 space-y-4">
                        <div>
                            <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1.5 block ml-1">Nombre</label>
                            <input value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} placeholder="Ej: Nike Air Force 1" className="w-full bg-gray-50 border-2 border-transparent focus:bg-white focus:border-black rounded-xl px-4 py-3 font-bold text-base text-gray-900 placeholder:text-gray-300 transition-all outline-none"/>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1.5 block ml-1">Categoría</label>
                                <input value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})} placeholder="Ej: Zapatos" className="w-full bg-gray-50 border-2 border-transparent focus:bg-white focus:border-black rounded-xl px-4 py-3 font-bold text-gray-900 outline-none"/>
                            </div>
                             <div>
                                <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1.5 block ml-1">Estado</label>
                                <select value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})} className="w-full bg-gray-50 border-2 border-transparent focus:bg-white focus:border-black rounded-xl px-4 py-3 font-bold text-gray-900 outline-none cursor-pointer">
                                    <option value="active">Activo</option>
                                    <option value="draft">Borrador</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1.5 block ml-1">Descripción</label>
                            <textarea value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} placeholder="Detalles..." className="w-full bg-gray-50 border-2 border-transparent focus:bg-white focus:border-black rounded-xl px-4 py-3 font-medium text-sm text-gray-900 min-h-[80px] resize-none outline-none"/>
                        </div>
                    </div>
                </div>
                {/* 2. MATRIZ DE VARIANTES */}
                <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-black text-gray-900 flex items-center gap-2"><Box size={20}/> Variantes</h3>
                        <span className="bg-gray-100 px-3 py-1 rounded-full text-[10px] font-bold text-gray-500">{variants.length} SKU</span>
                    </div>
                    <div className="bg-gray-50 rounded-2xl p-5 mb-6 border border-gray-200">
                        <input type="file" ref={variantImageInputRef} className="hidden" accept="image/*" onChange={(e) => e.target.files?.[0] && handleImageUpload(e.target.files[0], 'variant')}/>
                        <div className="flex flex-col gap-6">
                            <div className="flex flex-col md:flex-row gap-6">
                                <div className="flex-1">
                                    <label className="text-[9px] font-bold text-gray-400 uppercase mb-2 block">1. Color</label>
                                    <div className="flex items-center gap-3 bg-white p-2 rounded-xl border-2 border-gray-200 focus-within:border-black transition-all">
                                        <input type="color" value={variantInput.colorHex} onChange={e => setVariantInput({...variantInput, colorHex: e.target.value})} className="w-10 h-10 rounded-lg border-none cursor-pointer bg-transparent"/>
                                        <input type="text" placeholder="Ej: Negro" value={variantInput.colorName} onChange={e => setVariantInput({...variantInput, colorName: e.target.value})} className="flex-1 bg-transparent border-none text-sm font-bold outline-none text-gray-900 -mt-0.5"/>
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <label className="text-[9px] font-bold text-gray-400 uppercase mb-2 flex justify-between">
                                        <span>2. Fotos ({variantInput.images.length}/3)</span>
                                    </label>
                                    <div className="flex gap-2 h-14">
                                        <button onClick={() => variantImageInputRef.current?.click()} disabled={variantInput.images.length >= 3 || uploading} className="w-14 h-full rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center hover:border-black hover:bg-white transition-all disabled:opacity-50 text-gray-400 hover:text-black">
                                            {uploading ? <Loader2 className="animate-spin" size={16}/> : <Plus size={20}/>}
                                        </button>
                                        {variantInput.images.map((img, idx) => (
                                            <div key={idx} className="relative w-14 h-full rounded-xl border border-gray-200 overflow-hidden group bg-white">
                                                <img src={img} className="w-full h-full object-cover"/>
                                                <button onClick={() => removeImageFromVariantInput(idx)} className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 text-white"><X size={16}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col md:flex-row gap-6 items-end">
                                <div className="flex-[2] w-full">
                                    <label className="text-[9px] font-bold text-gray-400 uppercase mb-2 block">3. Tallas (Separar con coma)</label>
                                    <input 
                                        placeholder="S, M, L, XL" 
                                        value={variantInput.sizes} 
                                        onChange={e => setVariantInput({...variantInput, sizes: e.target.value.toUpperCase()})} 
                                        className="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-3 font-bold text-gray-900 focus:border-black outline-none shadow-sm text-sm placeholder:text-gray-300"
                                    />
                                </div>
                                <div className="flex-1 w-full">
                                    <label className="text-[9px] font-bold text-gray-400 uppercase mb-2 block">4. Stock</label>
                                    <input type="number" min="0" value={variantInput.defaultStock} onChange={e => setVariantInput({...variantInput, defaultStock: parseInt(e.target.value) || 0})} className="w-full bg-white border-2 border-gray-200 focus:border-black rounded-xl px-4 py-3 font-black text-gray-900 outline-none shadow-sm text-center"/>
                                </div>
                            </div>
                            <button onClick={addVariantGroup} className="w-full bg-black text-white p-3 rounded-xl hover:bg-gray-800 transition-all font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-2">
                                <Plus size={16} strokeWidth={3}/> Agregar
                            </button>
                        </div>
                    </div>
                    <div className="space-y-2">
                        {variants.map((v, i) => (
                            <div key={i} className="flex items-center justify-between bg-white border border-gray-100 p-3 rounded-xl hover:border-gray-300 transition-all">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-lg border border-gray-200 overflow-hidden bg-gray-50 shrink-0">
                                        {v.variant_image ? <img src={v.variant_image} className="w-full h-full object-cover"/> : <div className="w-full h-full" style={{ backgroundColor: v.color_hex }}></div>}
                                    </div>
                                    <div>
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full" style={{ backgroundColor: v.color_hex }}></div>
                                            <p className="font-bold text-sm text-gray-900">{v.color_name}</p>
                                        </div>
                                        <p className="text-xs text-gray-500">Talla: <span className="font-bold text-black">{v.size}</span></p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right"><p className="text-[9px] font-bold text-gray-400 uppercase">Stock</p><p className="font-mono font-bold text-sm">{v.stock}</p></div>
                                    <button onClick={() => removeVariant(v.id)} className="p-2 rounded-lg text-gray-300 hover:text-red-500 hover:bg-red-50"><Trash2 size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
            {/* COLUMNA DERECHA (ESTRATEGIA PRECIOS) */}
            <div className="lg:col-span-4 space-y-6 lg:sticky lg:top-24 h-fit">
                <div className="bg-white p-6 md:p-8 rounded-3xl shadow-lg border border-gray-100">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-black text-gray-900 flex items-center gap-2"><DollarSign size={20} className="text-green-600"/> Precios</h3>
                    </div>
                    <div className="space-y-5">
                        {/* INPUTS DE PRECIO */}
                        <div>
                            <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1.5 block ml-1">Precio Cash (Divisa)</label>
                            <div className="relative group">
                                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold group-focus-within:text-green-600">$</span>
                                <input type="number" value={formData.price === 0 ? '' : formData.price} onChange={e => setFormData({...formData, price: parseFloat(e.target.value) || 0})} placeholder="0.00" className="w-full bg-gray-50 border-2 border-transparent focus:bg-white focus:border-green-500 rounded-xl pl-8 pr-4 py-3 font-black text-xl text-gray-900 outline-none"/>
                            </div>
                        </div>
                        <div>
                            <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1.5 block ml-1">Margen / Recargo</label>
                            <div className="relative group">
                                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold group-focus-within:text-red-500">$</span>
                                <input type="number" value={formData.penalty === 0 ? '' : formData.penalty} onChange={e => setFormData({...formData, penalty: parseFloat(e.target.value) || 0})} placeholder="0.00" className="w-full bg-gray-50 border-2 border-transparent focus:bg-white focus:border-red-500 rounded-xl pl-8 pr-4 py-3 font-bold text-lg text-gray-900 outline-none"/>
                            </div>
                        </div>
                        {/* TARJETA NEGRA DE SIMULACIÓN */}
                        <div className="bg-[#1A1D24] rounded-2xl p-5 text-center shadow-xl relative overflow-hidden mt-4">
                            <div className="relative z-10 flex flex-col items-center gap-4">
                                <span className="bg-white/10 text-white/70 px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider border border-white/5">
                                    {rateLabel}: {activeRate.toFixed(2)}
                                </span>
                                {/* SIMULACIÓN DEL BADGE */}
                                {math.discountPercent > 0 && (
                                    <div className="bg-white text-black px-4 py-1 rounded-full text-xs font-black uppercase tracking-widest shadow-lg transform -rotate-2">
                                        PAGA EN DIVISA -{math.discountPercent}%
                                    </div>
                                )}
                                <div className="w-full border-t border-white/10 pt-4 mt-2">
                                    <p className="text-white/40 text-[9px] font-bold uppercase tracking-widest mb-1">
                                        Precio Visible (Bs)
                                    </p>
                                    <p className="font-black text-3xl text-white tracking-tight leading-none">
                                        Bs {math.refBs.toLocaleString('es-VE', { maximumFractionDigits: 2 })}
                                    </p>
                                    <p className="text-[9px] text-white/30 mt-2">
                                        Equivale a ${math.listPrice.toFixed(2)} (Full)
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="components/ProductModal.tsx">
'use client'
import { useState, useEffect, useMemo } from 'react'
import { X, ShoppingBag, Truck, AlertCircle, Loader2, ChevronLeft, ChevronRight, Minus, Plus, Tag } from 'lucide-react'
import { getSupabase } from '@/lib/supabase-client'
import { useCart } from '@/app/store/useCart'
import Swal from 'sweetalert2'
interface ProductModalProps {
  isOpen: boolean
  onClose: () => void
  product: any 
  currency: 'usd' | 'eur'
  rates: { usd: number, eur: number }
}
export default function ProductModal({ isOpen, onClose, product, currency, rates }: ProductModalProps) {
  const { addItem } = useCart()
  const [supabase] = useState(() => getSupabase())
  const [fullProduct, setFullProduct] = useState<any>(null)
  const [variants, setVariants] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [selectedColor, setSelectedColor] = useState<string | null>(null)
  const [selectedSize, setSelectedSize] = useState<string | null>(null)
  const [quantity, setQuantity] = useState(1)
  const [currentGallery, setCurrentGallery] = useState<string[]>([])
  const [galleryIndex, setGalleryIndex] = useState(0)
  // LOGICA DE MONEDA
  const isEur = currency === 'eur'
  const activeRate = isEur ? rates.eur : rates.usd
  const currencySymbol = '$'
  // --- ENGINE PRECIOS ---
  const pricing = useMemo(() => {
    if (!product) return { cashPrice: 0, priceInBs: 0, hasDiscount: false, discountPercent: 0 }
    const cashPrice = Number(product.usd_cash_price || 0)
    const markup = Number(product.usd_penalty || 0)
    const listPrice = cashPrice + markup
    const priceInBs = listPrice * activeRate
    const discountPercent = listPrice > 0 ? Math.round((markup / listPrice) * 100) : 0
    return {
        cashPrice,
        priceInBs,
        discountPercent,
        hasDiscount: markup > 0
    }
  }, [product, activeRate])
  // --- FETCHING ---
  useEffect(() => {
    if (isOpen && product) {
      setLoading(true)
      const fetchData = async () => {
        const { data: vars } = await supabase
          .from('product_variants')
          .select('*')
          .eq('product_id', product.id)
          .gt('stock', 0)
        setFullProduct(product)
        setCurrentGallery([product.image_url])
        setGalleryIndex(0)
        setQuantity(1) 
        if (vars && vars.length > 0) {
          setVariants(vars)
          const firstColor = vars[0].color_name
          setSelectedColor(firstColor)
          const firstVar = vars[0]
          let images = []
          if (firstVar.gallery && firstVar.gallery.length > 0) images = firstVar.gallery
          else if (firstVar.variant_image) images = [firstVar.variant_image]
          else images = [product.image_url]
          setCurrentGallery(images)
        } else {
            setVariants([])
            setSelectedColor(null)
            setSelectedSize(null)
        }
        setLoading(false)
      }
      fetchData()
    } else {
        setFullProduct(null)
        setVariants([])
        setSelectedColor(null)
        setSelectedSize(null)
        setCurrentGallery([])
        setGalleryIndex(0)
        setQuantity(1)
    }
  }, [isOpen, product, supabase])
  // --- GALERIA UPDATE ---
  useEffect(() => {
    if (!selectedColor || variants.length === 0) return
    const variant = variants.find(v => v.color_name === selectedColor)
    if (variant) {
        let images = []
        if (variant.gallery && variant.gallery.length > 0) images = variant.gallery
        else if (variant.variant_image) images = [variant.variant_image]
        else images = [product.image_url]
        if (JSON.stringify(images) !== JSON.stringify(currentGallery)) {
            setCurrentGallery(images)
            setGalleryIndex(0)
        }
    }
  }, [selectedColor, variants, product, currentGallery])
  // --- HELPERS ---
  const availableColors = useMemo(() => {
    const map = new Map()
    variants.forEach(v => { if (!map.has(v.color_name)) map.set(v.color_name, { name: v.color_name, hex: v.color_hex }) })
    return Array.from(map.values())
  }, [variants])
  const availableSizes = useMemo(() => {
    if (!selectedColor) return []
    return variants.filter(v => v.color_name === selectedColor).sort((a, b) => a.size.localeCompare(b.size, undefined, { numeric: true }))
  }, [variants, selectedColor])
  const increaseQty = () => setQuantity(prev => prev + 1)
  const decreaseQty = () => setQuantity(prev => (prev > 1 ? prev - 1 : 1))
  const handleAddToCart = () => {
    if (variants.length > 0) {
        if (!selectedColor) return Swal.fire({ title: 'Falta Color', text: 'Selecciona un color', icon: 'warning', confirmButtonColor: '#000' })
        if (!selectedSize) return Swal.fire({ title: 'Falta Talla', text: 'Selecciona tu talla', icon: 'warning', confirmButtonColor: '#000' })
        const specificVariant = variants.find(v => v.color_name === selectedColor && v.size === selectedSize)
        if (specificVariant) addItem(product, specificVariant, quantity)
    } else {
        addItem(product, null, quantity)
    }
    const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 1000, customClass: { popup: 'bg-black text-white rounded-none' } })
    Toast.fire({ icon: 'success', title: `AGREGADO (+${quantity})` })
    onClose() 
  }
  const nextImage = () => setGalleryIndex((prev) => (prev + 1) % currentGallery.length)
  const prevImage = () => setGalleryIndex((prev) => (prev - 1 + currentGallery.length) % currentGallery.length)
  if (!isOpen) return null
  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200">
        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
        {/* MODAL CONTAINER - Altura fija y flex para scroll */}
        <div className="bg-white w-full max-w-4xl h-[90vh] md:h-[85vh] rounded-3xl overflow-hidden shadow-2xl relative flex flex-col md:flex-row animate-in zoom-in-95 duration-300">
            {/* Botón cerrar flotante */}
            <button onClick={onClose} className="absolute top-4 right-4 z-20 bg-white/80 p-2 rounded-full hover:bg-gray-100 transition-colors backdrop-blur shadow-sm border border-gray-100">
                <X size={20} className="pointer-events-none"/>
            </button>
            {/* COLUMNA 1: GALERÍA (40% Alto en Móvil / 50% Ancho en Desktop) */}
            <div className="w-full h-[40%] md:h-full md:w-1/2 bg-gray-50 relative flex items-center justify-center border-b md:border-b-0 md:border-r border-gray-100 shrink-0 group">
                {currentGallery.length > 0 ? (
                    <img 
                        src={currentGallery[galleryIndex]} 
                        alt="Producto" 
                        className="w-full h-full object-contain mix-blend-multiply p-8 transition-all duration-500 ease-out" 
                    />
                ) : (
                    <span className="text-4xl font-black text-gray-200">P.</span>
                )}
                {/* Navegación Carrusel (Botones SIEMPRE visibles en móvil) */}
                {currentGallery.length > 1 && (
                    <>
                        {/* Botón Izquierda - Visible en móvil (opacity-100) */}
                        <button 
                            onClick={(e) => { e.stopPropagation(); prevImage() }} 
                            className="absolute left-4 top-1/2 -translate-y-1/2 bg-white/90 p-2.5 rounded-full shadow-lg border border-gray-100 active:scale-95 transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100 z-10"
                        >
                            <ChevronLeft size={20} className="pointer-events-none"/>
                        </button>
                        {/* Botón Derecha - Visible en móvil (opacity-100) */}
                        <button 
                            onClick={(e) => { e.stopPropagation(); nextImage() }} 
                            className="absolute right-4 top-1/2 -translate-y-1/2 bg-white/90 p-2.5 rounded-full shadow-lg border border-gray-100 active:scale-95 transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100 z-10"
                        >
                            <ChevronRight size={20} className="pointer-events-none"/>
                        </button>
                        {/* Puntos indicadores */}
                        <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-1.5 p-1 bg-white/50 backdrop-blur rounded-full z-10">
                            {currentGallery.map((_, idx) => (
                                <div key={idx} className={`h-1.5 rounded-full transition-all duration-300 ${idx === galleryIndex ? 'bg-black w-4' : 'bg-gray-400 w-1.5'}`}/>
                            ))}
                        </div>
                    </>
                )}
                {/* ETIQUETA PRECIO FLOTANTE SOBRE IMAGEN */}
                <div className="absolute top-4 left-4 flex flex-col items-start gap-2 pointer-events-none z-10">
                    {pricing.hasDiscount && (
                        <div className="bg-black/90 backdrop-blur text-white text-[10px] font-bold uppercase px-3 py-1.5 rounded-lg flex items-center gap-1.5 shadow-lg">
                            <Tag size={12} className="text-emerald-400"/>
                            -{pricing.discountPercent}% OFF
                        </div>
                    )}
                </div>
            </div>
            {/* COLUMNA 2: INFO Y ACCIONES (Flex Column para manejar el scroll) */}
            <div className="w-full h-[60%] md:h-full md:w-1/2 flex flex-col bg-white">
                {/* 1. CONTENIDO SCROLLABLE (flex-1 overflow-y-auto) */}
                <div className="flex-1 overflow-y-auto p-6 md:p-8 space-y-6">
                    {/* Header Info */}
                    <div>
                        <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest bg-gray-50 px-2 py-1 rounded-md">{product?.category || 'General'}</span>
                        <h2 className="text-xl md:text-3xl font-black text-gray-900 leading-tight mt-3 tracking-tight">{product?.name}</h2>
                        {/* Precio Principal */}
                        <div className="mt-4 flex flex-col gap-1">
                            <div className="flex items-baseline gap-2">
                                <span className="text-3xl font-black text-gray-900 tracking-tighter">{currencySymbol}{pricing.cashPrice.toFixed(2)}</span>
                                <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full">Precio Cash</span>
                            </div>
                            <span className="text-xs font-medium text-gray-400">
                                Ref Bs: {new Intl.NumberFormat('es-VE', { maximumFractionDigits: 2 }).format(pricing.priceInBs)}
                            </span>
                        </div>
                        {product?.description && <p className="text-sm text-gray-500 mt-4 leading-relaxed whitespace-pre-line">{product.description}</p>}
                    </div>
                    {loading ? (
                        <div className="flex items-center justify-center py-10">
                            <Loader2 className="animate-spin text-gray-300" size={32}/>
                        </div>
                    ) : (
                        <div className="space-y-6 pb-4"> 
                            {/* SELECTOR DE COLOR */}
                            {variants.length > 0 && (
                                <>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs font-bold text-gray-900 uppercase tracking-wide">1. Color</span>
                                            <span className="text-xs font-medium text-gray-500">{selectedColor}</span>
                                        </div>
                                        <div className="flex flex-wrap gap-3">
                                            {availableColors.map((c: any) => (
                                                <button 
                                                    key={c.name} 
                                                    onClick={() => { setSelectedColor(c.name); setSelectedSize(null) }} 
                                                    className={`w-10 h-10 rounded-full border shadow-sm transition-all relative ${
                                                        selectedColor === c.name 
                                                        ? 'ring-2 ring-black ring-offset-2 scale-110' 
                                                        : 'hover:scale-105 border-gray-200'
                                                    }`} 
                                                    style={{ backgroundColor: c.hex }}
                                                    title={c.name}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                    {/* SELECTOR DE TALLA */}
                                    <div className="space-y-3">
                                        <span className="text-xs font-bold text-gray-900 uppercase tracking-wide block">2. Talla</span>
                                        {!selectedColor ? (
                                            <div className="flex items-center gap-2 text-xs text-orange-600 bg-orange-50 p-3 rounded-xl border border-orange-100">
                                                <AlertCircle size={16}/> Selecciona un color primero
                                            </div>
                                        ) : (
                                            <div className="flex flex-wrap gap-2">
                                                {availableSizes.map(v => (
                                                    <button 
                                                        key={v.id} 
                                                        onClick={() => setSelectedSize(v.size)} 
                                                        className={`min-w-[3rem] px-3 py-2.5 rounded-lg text-xs font-bold border transition-all ${
                                                            selectedSize === v.size 
                                                            ? 'bg-black text-white border-black shadow-md' 
                                                            : 'bg-white text-gray-600 border-gray-200 hover:border-black'
                                                        }`}
                                                    >
                                                        {v.size}
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                            {/* Badge Envío */}
                            <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                                <div className="bg-white p-1.5 rounded-full shadow-sm">
                                    <Truck size={16} className="text-black"/>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-[10px] font-bold text-gray-900 uppercase">Envío Inmediato</span>
                                    <span className="text-[10px] text-gray-500">Disponible para despacho hoy</span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                {/* 2. FOOTER FIJO (shrink-0 para que no desaparezca) */}
                <div className="p-4 md:p-6 bg-white border-t border-gray-100 shrink-0 z-10 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
                    <div className="flex gap-3 md:gap-4">
                        {/* Selector Cantidad */}
                        <div className="flex items-center bg-gray-50 rounded-xl p-1 border border-gray-200 shrink-0">
                            <button onClick={decreaseQty} className="w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-sm border border-gray-100 text-gray-600 hover:text-black active:scale-95 transition-all">
                                <Minus size={16} className="pointer-events-none"/>
                            </button>
                            <span className="font-bold text-sm w-8 text-center tabular-nums">{quantity}</span>
                            <button onClick={increaseQty} className="w-10 h-10 flex items-center justify-center bg-black text-white rounded-lg shadow-sm border border-black hover:bg-gray-800 active:scale-95 transition-all">
                                <Plus size={16} className="pointer-events-none"/>
                            </button>
                        </div>
                        {/* Botón Agregar */}
                        <button 
                            onClick={handleAddToCart} 
                            disabled={product?.stock <= 0}
                            className="flex-1 bg-black text-white py-3.5 rounded-xl font-bold uppercase tracking-widest text-xs hover:bg-gray-900 transition-all shadow-xl shadow-black/10 active:scale-[0.98] flex items-center justify-center gap-[1.33px] disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <ShoppingBag size={18} className="pointer-events-none mb-0.5" /> 
                            <span>{variants.length > 0 ? 'Agregar Selección' : 'Agregar al Carrito'}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <style jsx global>{`
            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        `}</style>
    </div>
  )
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="lib/supabase-client.ts">
import { createBrowserClient } from '@supabase/ssr'
// Definimos el tipo global para evitar errores de TypeScript
declare global {
  var __supabaseInstance: ReturnType<typeof createBrowserClient> | undefined
}
export const getSupabase = () => {
  // 1. En el servidor (SSR), siempre creamos una nueva instancia limpia.
  if (typeof window === 'undefined') {
    return createBrowserClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )
  }
  // 2. En el cliente (Navegador), usamos una variable global única.
  // Si no existe, la creamos. Si ya existe, la reutilizamos.
  if (!globalThis.__supabaseInstance) {
    globalThis.__supabaseInstance = createBrowserClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )
  }
  return globalThis.__supabaseInstance
}
</file>

<file path="lib/supabase.ts">
import { getSupabase } from './supabase-client'
// En lugar de crear un cliente nuevo con createClient(),
// reutilizamos la instancia única que ya creamos en el otro archivo.
export const supabase = getSupabase()
</file>

<file path="middleware.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'
export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })
  // 1. Creamos un cliente de Supabase temporal solo para verificar la sesión
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value,
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value,
            ...options,
          })
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value: '',
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value: '',
            ...options,
          })
        },
      },
    }
  )
  // 2. Verificamos si hay usuario
  const { data: { user } } = await supabase.auth.getUser()
  // 3. REGLA DE SEGURIDAD:
  // Si intenta entrar a una ruta que empieza por '/admin' Y no hay usuario...
  if (request.nextUrl.pathname.startsWith('/admin') && !user) {
    // ...lo mandamos al Login
    return NextResponse.redirect(new URL('/login', request.url))
  }
  // 4. Si intenta ir al Login PERO ya tiene usuario...
  if (request.nextUrl.pathname.startsWith('/login') && user) {
     // ...lo mandamos directo al Admin (para que no se loguee dos veces)
    return NextResponse.redirect(new URL('/admin', request.url))
  }
  return response
}
// Configuración: En qué rutas se ejecuta este portero
export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="utils/supabaseServer.ts">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
export async function createClient() {
  const cookieStore = await cookies()
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // El método 'setAll' fue llamado desde un Server Component.
            // Esto se puede ignorar si tienes un middleware refrescando
            // las sesiones de usuario.
          }
        },
      },
    }
  )
}
</file>

<file path="utils/supabaseStorage.ts">
// utils/supabaseStorage.ts
import { SupabaseClient } from '@supabase/supabase-js'
export async function uploadImageToSupabase(
  supabase: SupabaseClient, 
  file: File, 
  bucket: string, 
  folderPath: string
) {
  // 1. Validar Tamaño (Max 5MB)
  const MAX_SIZE = 5 * 1024 * 1024;
  if (file.size > MAX_SIZE) {
    throw new Error("La imagen es demasiado pesada. El límite es 5MB.");
  }
  // 2. Sanitizar nombre (El truco anti-errores)
  const fileExt = file.name.split('.').pop();
  const cleanFileName = `${Date.now()}-${Math.floor(Math.random() * 1000)}.${fileExt}`;
  const fullPath = `${folderPath}/${cleanFileName}`;
  // 3. Subir
  const { error: uploadError } = await supabase.storage
    .from(bucket)
    .upload(fullPath, file);
  if (uploadError) throw uploadError;
  // 4. Obtener URL
  const { data } = supabase.storage
    .from(bucket)
    .getPublicUrl(fullPath);
  return data.publicUrl;
}
</file>

<file path="app/subscription/page.tsx">
'use client'
import { MessageCircle, CheckCircle, Lock, Copy } from 'lucide-react'
import Link from 'next/link'
import Swal from 'sweetalert2'
export default function SubscriptionPage() {
  const price = "10$"
  const pagoMovil = {
    banco: "Venezuela",
    telefono: "0414-580-9864", // <--- TU NÚMERO
    cedula: "V-34.075.886"     // <--- TU CÉDULA
  }
  const handleReportPayment = () => {
    const message = `Hola, mi periodo de prueba en Preziso venció. Ya realicé el pago de la suscripción (${price}).\n\nAdjunto comprobante:`
    const url = `https://wa.me/584145811936?text=${encodeURIComponent(message)}`
    window.open(url, '_blank')
  }
  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
    Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Copiado', timer: 1000, showConfirmButton: false })
  }
  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans py-10">
      <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-gray-100 flex flex-col">
        {/* Header Rojo */}
        <div className="bg-black text-white p-6 md:p-8 text-center relative overflow-hidden flex-shrink-0">
            <div className="absolute top-0 left-0 w-full h-full bg-white/10 rotate-12 scale-150 transform origin-bottom-left"></div>
            <div className="relative z-10 flex flex-col items-center">
                <div className="bg-white/20 p-3 md:p-4 rounded-full mb-3 backdrop-blur-sm shadow-lg">
                    <Lock size={28} className="text-white"/>
                </div>
                <h1 className="text-xl md:text-2xl font-bold mb-1">Suscripción Requerida</h1>
                <p className="text-gray-300 text-xs md:text-sm px-4">Tu periodo de prueba gratuito ha finalizado.</p>
            </div>
        </div>
        {/* Body */}
        <div className="p-6 md:p-8 flex-1 flex flex-col">
            <div className="text-center mb-6">
                <p className="text-gray-600 mb-2 text-sm md:text-base">Reactiva tu tienda y sigue vendiendo sin límites.</p>
                <div className="text-3xl md:text-4xl font-black text-gray-900 tracking-tight">{price}<span className="text-sm text-gray-400 font-medium ml-1">/mes</span></div>
            </div>
            {/* Beneficios */}
            <ul className="space-y-3 mb-6 bg-gray-50 p-5 rounded-2xl border border-gray-100">
                <li className="flex items-center gap-3 text-sm text-gray-700">
                    <CheckCircle size={16} className="text-green-500 flex-shrink-0"/> Panel de Control Ilimitado
                </li>
                <li className="flex items-center gap-3 text-sm text-gray-700">
                    <CheckCircle size={16} className="text-green-500 flex-shrink-0"/> Catálogo Público Activo
                </li>
                <li className="flex items-center gap-3 text-sm text-gray-700">
                    <CheckCircle size={16} className="text-green-500 flex-shrink-0"/> Actualizaciones BCV
                </li>
            </ul>
            {/* Datos de Pago */}
            <div className="mb-6 text-center">
                <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Datos para Pago Móvil</p>
                <div className="bg-gray-100 p-4 rounded-xl text-sm font-mono text-gray-600 border border-gray-200 relative group">
                    <div className="space-y-1">
                        <p className="flex justify-between"><span>Banco:</span> <b className="text-black">{pagoMovil.banco}</b></p>
                        <p className="flex justify-between"><span>Tlf:</span> <b className="text-black">{pagoMovil.telefono}</b></p>
                        <p className="flex justify-between"><span>CI:</span> <b className="text-black">{pagoMovil.cedula}</b></p>
                    </div>
                    {/* Botón flotante para copiar todo */}
                    <button 
                        onClick={() => copyToClipboard(`${pagoMovil.banco}\n${pagoMovil.telefono}\n${pagoMovil.cedula}`)}
                        className="absolute top-2 right-2 p-1.5 bg-white rounded-md shadow-sm opacity-50 group-hover:opacity-100 transition-opacity hover:bg-gray-50"
                        title="Copiar datos"
                    >
                        <Copy size={14} className="text-gray-500"/>
                    </button>
                </div>
            </div>
            {/* Botón */}
            <div className="mt-auto">
                <button 
                    onClick={handleReportPayment}
                    className="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold text-base md:text-lg hover:bg-green-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-green-200 active:scale-95"
                >
                    <MessageCircle size={20} />
                    Reportar Pago
                </button>
                <div className="mt-4 text-center">
                    <Link href="/" className="text-xs text-gray-400 hover:text-gray-600 underline">Volver al inicio</Link>
                </div>
            </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="components/ShareButton.tsx">
'use client'
import { Share2, Check } from 'lucide-react'
import { useEffect, useState } from 'react'
interface Props {
  productName: string
  price: number
  slug: string // <--- El ID o Slug del producto
  imageUrl?: string // <--- Agregamos la imagen (Opcional)
}
export default function ShareButton({ productName, price, slug, imageUrl }: Props) {
  const [url, setUrl] = useState('')
  const [copied, setCopied] = useState(false)
  useEffect(() => {
    if (typeof window !== 'undefined') {
      setUrl(window.location.href)
    }
  }, [])
  const handleShare = async () => {
    if (!url) return
    const shareData = {
      title: `Mira este producto: ${productName}`,
      text: `¡Hola! Vi este ${productName} en $${price} y pensé que te gustaría.`,
      url: url
    }
    // 1. Intenta usar el Compartir Nativo del Celular (iPhone/Android)
    if (navigator.share && navigator.canShare(shareData)) {
      try {
        await navigator.share(shareData)
        return
      } catch (err) {
        console.log('Error compartiendo o cancelado', err)
      }
    }
    // 2. Si está en PC o falla el nativo, copiamos al portapapeles o abrimos WhatsApp
    // Opción A: Abrir WhatsApp Web
    const whatsappText = `${shareData.text} ${url}`
    window.open(`whatsapp://send?text=${encodeURIComponent(whatsappText)}`, '_blank')
  }
  return (
    <button 
      onClick={handleShare}
      className="p-3.5 bg-gray-100 hover:bg-gray-200 text-black rounded-xl transition-all active:scale-90 flex items-center justify-center min-w-[50px]"
      title="Compartir"
    >
      {copied ? <Check size={20} className="text-green-600"/> : <Share2 size={20} />}
    </button>
  )
}
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";
const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        // Reemplaza esto con TU dominio de Supabase (sin el https://)
        // Ejemplo: 'abcdefg.supabase.co'
        hostname: 'lrmhgzohfclrepwvrhdy.supabase.co',
        port: '',
        pathname: '/storage/v1/object/public/**',
      },
    ],
  },
};
export default nextConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="tailwind.config.mjs">
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</file>

<file path="app/admin/product/edit/[id]/page.tsx">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import ProductEditor from '@/components/ProductEditor'
export default async function EditProductPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params
  const cookieStore = await cookies()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    { cookies: { getAll() { return cookieStore.getAll() } } }
  )
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return <div>No autorizado</div>
  const [configRes, storeRes] = await Promise.all([
    supabase.from('app_config').select('usd_rate, eur_rate').eq('id', 1).single(),
    supabase.from('stores').select('id, currency_type').eq('user_id', user.id).single()
  ])
  return (
    <ProductEditor 
        productId={id} 
        rates={{ 
            usd: configRes.data?.usd_rate || 0, 
            eur: configRes.data?.eur_rate || 0 
        }}
        storeSettings={{
            id: storeRes.data?.id || '',
            currency: storeRes.data?.currency_type || 'usd'
        }}
    />
  )
}
</file>

<file path="app/admin/setup/page.tsx">
'use client'
import { useState } from 'react'
import { createBrowserClient } from '@supabase/ssr' // <--- CAMBIO: Usamos la librería moderna
import { useRouter } from 'next/navigation'
import { Store, Loader2, ArrowRight } from 'lucide-react'
export default function SetupPage() {
  const [name, setName] = useState('')
  const [slug, setSlug] = useState('')
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  // CAMBIO: Usamos createBrowserClient igual que en el Admin y Login
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value
    setName(val)
    setSlug(val.toLowerCase().replace(/ /g, '-').replace(/[^\w-]+/g, ''))
  }
  const handleCreateStore = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    try {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
         router.push('/login')
         return
      }
      // 1. Verificar si el slug ya existe
      const { data: existing } = await supabase
        .from('stores')
        .select('id')
        .eq('slug', slug)
        .maybeSingle() // Usamos maybeSingle para evitar errores en consola
      if (existing) {
        alert('¡Esa URL ya está ocupada! Prueba con otra.')
        setLoading(false)
        return
      }
      // 2. Crear la tienda
      const { error } = await supabase
        .from('stores')
        .insert([
          {
            user_id: user.id,
            name: name,
            slug: slug,
            currency_type: 'usd',
            phone: ''
          }
        ])
      if (error) throw error
      // 3. Éxito: Refrescamos y vamos al Admin
      router.refresh()
      router.push('/admin')
    } catch (error: any) {
      console.error(error)
      alert('Error creando la tienda: ' + error.message)
      setLoading(false)
    }
  }
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
        <div className="text-center mb-8">
          <div className="bg-black text-white w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4">
            <Store size={24} />
          </div>
          <h1 className="text-2xl font-bold text-gray-900">Nombra tu Imperio</h1>
          <p className="text-gray-500 text-sm mt-1">Configura la URL de tu tienda para empezar.</p>
        </div>
        <form onSubmit={handleCreateStore} className="space-y-6">
          <div>
            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Nombre de la Tienda</label>
            <input 
              type="text" 
              value={name}
              onChange={handleNameChange}
              placeholder="Ej: Zapatos Caracas"
              className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-black transition-all"
              required
            />
          </div>
          <div>
            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Tu URL (Link)</label>
            <div className="flex items-center bg-gray-50 border border-gray-200 rounded-xl px-3">
              <span className="text-gray-400 text-sm border-r border-gray-200 pr-2 mr-2">preziso...app/</span>
              <input 
                type="text" 
                value={slug}
                onChange={(e) => setSlug(e.target.value.toLowerCase().replace(/ /g, '-'))}
                className="w-full py-3 bg-transparent focus:outline-none font-medium text-black"
                placeholder="zapatos-caracas"
                required
              />
            </div>
          </div>
          <button 
            type="submit" 
            disabled={loading || !name || !slug}
            className="w-full bg-black text-white font-bold py-3.5 rounded-xl hover:bg-gray-800 transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2"
          >
            {loading ? <Loader2 className="animate-spin" /> : <>Crear Tienda <ArrowRight size={18} /></>}
          </button>
        </form>
      </div>
    </div>
  )
}
</file>

<file path="app/auth/callback/route.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse } from 'next/server'
export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  const next = searchParams.get('next') ?? '/admin'
  if (code) {
    // 1. Preparamos la respuesta vacía donde pegaremos las cookies
    const response = NextResponse.redirect(`${origin}${next}`)
    // 2. Usamos el adaptador MODERNO (getAll / setAll)
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            // Leemos las cookies de la petición
            const cookieHeader = request.headers.get('Cookie') ?? ''
            return parseCookieHeader(cookieHeader)
          },
          setAll(cookiesToSet) {
            // AQUÍ ESTÁ EL TRUCO: Supabase nos da las cookies y las pegamos en la respuesta
            cookiesToSet.forEach(({ name, value, options }) => {
              response.cookies.set({
                name,
                value,
                ...options,
              })
            })
          },
        },
      }
    )
    // 3. Canjeamos el código. Esto disparará 'setAll' automáticamente.
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    if (!error) {
      // Devolvemos la respuesta CON las cookies pegadas
      return response
    }
  }
  // Si falla, al login
  return NextResponse.redirect(`${origin}/login?error=auth-code-error`)
}
// Pequeña utilidad para leer cookies manuales (necesaria para getAll)
function parseCookieHeader(header: string) {
  const list: any[] = []
  if (!header) return list
  header.split(';').forEach((cookie) => {
    const parts = cookie.split('=')
    if (parts.length >= 2) {
      const name = parts.shift()?.trim()
      const value = parts.join('=')
      list.push({ name, value })
    }
  })
  return list
}
</file>

<file path="components/AmbientBackground.tsx">
'use client'
import { motion } from 'framer-motion'
export default function AmbientBackground() {
  // CONFIGURACIÓN DE ANIMACIÓN (MEMOIZED & TYPED)
  // El 'as const' soluciona el error de TypeScript con 'ease: "linear"'
  const floatAnimation = {
    animate: {
      transform: [
        "translate(0px, 0px) scale(1)",
        "translate(20px, -20px) scale(1.1)",
        "translate(-10px, 20px) scale(0.9)",
        "translate(0px, 0px) scale(1)"
      ]
    },
    transition: {
      duration: 15,
      repeat: Infinity,
      ease: "linear" as const // <--- ESTO ARREGLA EL ERROR TS2322
    }
  }
  return (
    <div className="fixed inset-0 -z-50 overflow-hidden pointer-events-none transform-gpu">
      {/* 1. LIENZO BASE */}
      <div className="absolute inset-0 bg-white dark:bg-[#020202] transition-colors duration-300"></div>
      {/* 2. SPOTLIGHTS OPTIMIZADOS 
          Usamos clases canónicas de Tailwind (w-200 = 800px) para silenciar los warnings.
      */}
      {/* Foco 1: Hero (Verde) */}
      <motion.div 
        {...floatAnimation}
        // Sobreescribimos solo la duración
        transition={{ ...floatAnimation.transition, duration: 20 }}
        className="absolute -top-[10%] -left-[10%] w-[60vh] h-[60vh] md:w-200 md:h-200 rounded-full will-change-transform opacity-40 dark:opacity-20"
        style={{
          background: 'radial-gradient(circle, rgba(16, 185, 129, 1) 0%, rgba(16, 185, 129, 0) 70%)',
        }}
      />
      {/* Foco 2: Features (Azul) */}
      <motion.div 
        {...floatAnimation}
        transition={{ ...floatAnimation.transition, duration: 25, delay: 2 }}
        className="absolute top-[30%] -right-[10%] w-[50vh] h-[50vh] md:w-[700px] md:h-[700px] rounded-full will-change-transform opacity-40 dark:opacity-20"
        style={{
          background: 'radial-gradient(circle, rgba(59, 130, 246, 1) 0%, rgba(59, 130, 246, 0) 70%)',
        }}
      />
      {/* Foco 3: Pricing (Violeta) */}
      <motion.div 
        {...floatAnimation}
        transition={{ ...floatAnimation.transition, duration: 30, delay: 5 }}
        className="absolute -bottom-[10%] left-[20%] w-[55vh] h-[55vh] md:w-[700px] md:h-[700px] rounded-full will-change-transform opacity-40 dark:opacity-20"
        style={{
          background: 'radial-gradient(circle, rgba(139, 92, 246, 1) 0%, rgba(139, 92, 246, 0) 70%)',
        }}
      />
      {/* 3. TEXTURA ESTÁTICA */}
      <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10 dark:opacity-[0.03] brightness-100 contrast-150 mix-blend-overlay"></div>
    </div>
  )
}
</file>

<file path="components/AddToCartBtn.tsx">
'use client'
import { ShoppingCart, Plus, Minus } from 'lucide-react'
import { useCart } from '@/app/store/useCart'
import Swal from 'sweetalert2'
export default function AddToCartBtn({ product, iconOnly = false }: { product: any, iconOnly?: boolean }) {
  const { addItem, items, updateQuantity, removeItem } = useCart()
  // Buscar si este producto ya existe en el carrito
  const existingItem = items.find((item) => item.productId === product.id || item.id === `${product.id}`)
  const quantity = existingItem ? existingItem.quantity : 0
  const handleAdd = (e: React.MouseEvent) => {
    e.preventDefault()
    e.stopPropagation()
    addItem(product)
    // Feedback visual sutil solo la primera vez
    if (quantity === 0) {
        const Toast = Swal.mixin({
            toast: true, position: 'top', showConfirmButton: false, timer: 1000,
            customClass: { popup: 'bg-black text-white rounded-none' }
        })
        Toast.fire({ icon: 'success', title: 'AGREGADO' })
    }
  }
  const handleIncrease = (e: React.MouseEvent) => {
    e.preventDefault(); e.stopPropagation();
    if(existingItem) updateQuantity(existingItem.id, 1)
  }
  const handleDecrease = (e: React.MouseEvent) => {
    e.preventDefault(); e.stopPropagation();
    if (quantity > 1 && existingItem) {
        updateQuantity(existingItem.id, -1)
    } else if (existingItem) {
        removeItem(existingItem.id)
    }
  }
  // --- ESTADO 1: YA ESTÁ EN EL CARRITO (MOSTRAR CONTADOR) ---
  if (quantity > 0) {
    if (iconOnly) {
        return (
            <div className="bg-black text-white p-1 rounded-lg flex flex-col items-center justify-between h-[100px] w-[40px] shadow-lg animate-in fade-in zoom-in duration-200" onClick={(e) => e.stopPropagation()}>
                <button onClick={handleIncrease} className="p-1 hover:bg-gray-700 rounded-full transition-colors"><Plus size={14}/></button>
                <span className="font-mono text-xs font-bold">{quantity}</span>
                <button onClick={handleDecrease} className="p-1 hover:bg-gray-700 rounded-full transition-colors"><Minus size={14}/></button>
            </div>
        )
    }
    return (
        <div className="w-full bg-black text-white h-[46px] rounded-xl flex items-center justify-between px-4 shadow-lg animate-in fade-in zoom-in duration-200" onClick={(e) => e.stopPropagation()}>
            <button onClick={handleDecrease} className="p-1 hover:bg-gray-700 rounded-full transition-colors"><Minus size={18}/></button>
            <span className="font-mono font-bold text-sm">{quantity}</span>
            <button onClick={handleIncrease} className="p-1 hover:bg-gray-700 rounded-full transition-colors"><Plus size={18}/></button>
        </div>
    )
  }
  // --- ESTADO 2: NO ESTÁ EN EL CARRITO (BOTÓN NORMAL) ---
  if (iconOnly) {
    return (
      <button 
        onClick={handleAdd}
        className="bg-black text-white p-2.5 rounded-lg hover:bg-gray-800 transition-colors shadow-sm active:scale-95"
        title="Agregar al carrito"
      >
        <ShoppingCart size={16} strokeWidth={2.5} />
      </button>
    )
  }
  return (
    <button 
      onClick={handleAdd}
      className="w-full bg-black text-white py-3.5 rounded-xl font-bold uppercase tracking-widest text-xs hover:bg-gray-800 transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2"
    >
      <ShoppingCart size={18} />
      Agregar al Carrito
    </button>
  )
}
</file>

<file path="components/admin/ShippingSettings.tsx">
'use client'
import { useState, useEffect } from 'react'
import { Truck, MapPin, Save, Loader2, Info } from 'lucide-react'
import { getSupabase } from '@/lib/supabase-client'
import Swal from 'sweetalert2'
export default function ShippingSettings({ storeId }: { storeId: string }) {
  const [loading, setLoading] = useState(false)
  const [config, setConfig] = useState({
    methods: {
      mrw: false,
      zoom: false,
      tealca: false,
      delivery: false,
      pickup: true
    },
    pickup_locations: [] as string[],
    delivery_zones: [] as string[]
  })
  const [newLocation, setNewLocation] = useState('')
  // INSTANCIAMOS EL CLIENTE CORRECTO (CON SESIÓN)
  const supabase = getSupabase()
  // Cargar Configuración Actual
  useEffect(() => {
    const fetchConfig = async () => {
      const { data, error } = await supabase
        .from('stores')
        .select('shipping_config')
        .eq('id', storeId)
        .single()
      // Si existe configuración guardada, la cargamos.
      // Si no, usamos el estado inicial (o mezclamos para evitar perder datos nuevos)
      if (data?.shipping_config) {
        // Hacemos un merge seguro para que si agregaste métodos nuevos no se rompa
        setConfig(prev => ({
            ...prev,
            ...data.shipping_config,
            methods: { ...prev.methods, ...data.shipping_config.methods }
        }))
      }
    }
    if (storeId) fetchConfig()
  }, [storeId])
  // Guardar Cambios
  const handleSave = async () => {
    if (!storeId) return
    setLoading(true)
    console.log("Guardando config con cliente autenticado:", config);
    const { error } = await supabase
      .from('stores')
      .update({ shipping_config: config })
      .eq('id', storeId)
    setLoading(false)
    if (error) {
       console.error(error)
       Swal.fire('Error', 'No se pudo guardar la configuración', 'error')
    } else {
       const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
          customClass: { popup: 'bg-black text-white' }
       })
       Toast.fire({ icon: 'success', title: 'Logística Actualizada' })
    }
  }
  const toggleMethod = (key: keyof typeof config.methods) => {
    setConfig(prev => ({
      ...prev,
      methods: { ...prev.methods, [key]: !prev.methods[key] }
    }))
  }
  const addLocation = () => {
    if (!newLocation.trim()) return
    setConfig(prev => ({
      ...prev,
      pickup_locations: [...prev.pickup_locations, newLocation.trim()]
    }))
    setNewLocation('')
  }
  const removeLocation = (index: number) => {
    setConfig(prev => ({
        ...prev,
        pickup_locations: prev.pickup_locations.filter((_, i) => i !== index)
    }))
  }
  return (
    <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-8">
        {/* CABECERA */}
        <div className="flex justify-between items-center">
            <div>
                <h3 className="text-lg font-black text-gray-900 flex items-center gap-2">
                    <Truck size={20} /> Logística de Envíos
                </h3>
                <p className="text-sm text-gray-500">Define cómo entregas tus productos.</p>
            </div>
            <button 
                onClick={handleSave}
                disabled={loading}
                className="bg-black text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-800 transition-all"
            >
                {loading ? <Loader2 className="animate-spin" size={16}/> : <Save size={16}/>}
                Guardar Cambios
            </button>
        </div>
        {/* 1. MÉTODOS DE ENVÍO NACIONAL */}
        <div className="space-y-4">
            <h4 className="text-xs font-bold text-gray-400 uppercase tracking-widest">Envíos Nacionales</h4>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {['mrw', 'zoom', 'tealca'].map((method) => (
                    <div 
                        key={method}
                        onClick={() => toggleMethod(method as any)}
                        className={`cursor-pointer p-4 rounded-xl border-2 transition-all flex items-center justify-between ${config.methods[method as keyof typeof config.methods] ? 'border-black bg-gray-50' : 'border-gray-100 hover:border-gray-200'}`}
                    >
                        <span className="font-bold uppercase">{method}</span>
                        <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${config.methods[method as keyof typeof config.methods] ? 'bg-black border-black' : 'border-gray-300'}`}>
                            {config.methods[method as keyof typeof config.methods] && <div className="w-2 h-2 bg-white rounded-full"/>}
                        </div>
                    </div>
                ))}
            </div>
        </div>
        {/* 2. DELIVERY & PICKUP */}
        <div className="space-y-4 pt-4 border-t border-gray-100">
            <h4 className="text-xs font-bold text-gray-400 uppercase tracking-widest">Entregas Locales</h4>
            {/* DELIVERY TOGGLE */}
            <div 
                onClick={() => toggleMethod('delivery')}
                className={`cursor-pointer p-4 rounded-xl border-2 transition-all flex items-center justify-between ${config.methods.delivery ? 'border-black bg-gray-50' : 'border-gray-100 hover:border-gray-200'}`}
            >
                <div className="flex items-center gap-3">
                    <span className="font-bold uppercase">Delivery (Motorizado)</span>
                    <span className="text-xs text-gray-500 bg-white px-2 py-0.5 rounded border border-gray-200">Local</span>
                </div>
                <div className={`w-10 h-6 rounded-full border flex items-center px-1 transition-colors ${config.methods.delivery ? 'bg-black border-black justify-end' : 'bg-gray-100 border-gray-200 justify-start'}`}>
                    <div className="w-3.5 h-3.5 bg-white rounded-full shadow-sm"/>
                </div>
            </div>
            {/* PICKUP LOCATIONS */}
            <div className={`p-4 rounded-xl border-2 transition-all space-y-4 ${config.methods.pickup ? 'border-black bg-white' : 'border-gray-100 opacity-60'}`}>
                 <div className="flex items-center justify-between cursor-pointer" onClick={() => toggleMethod('pickup')}>
                    <span className="font-bold uppercase flex items-center gap-2"><MapPin size={18}/> Retiro Personal</span>
                    <div className={`w-10 h-6 rounded-full border flex items-center px-1 transition-colors ${config.methods.pickup ? 'bg-black border-black justify-end' : 'bg-gray-100 border-gray-200 justify-start'}`}>
                        <div className="w-3.5 h-3.5 bg-white rounded-full shadow-sm"/>
                    </div>
                 </div>
                 {config.methods.pickup && (
                    <div className="pl-4 border-l-2 border-gray-100 space-y-3 animate-in fade-in">
                        <p className="text-xs text-gray-500">Agrega las direcciones donde el cliente puede buscar su pedido.</p>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                placeholder="Ej: C.C. Free Market, Local B-20, Naguanagua"
                                className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-black outline-none"
                                value={newLocation}
                                onChange={(e) => setNewLocation(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && addLocation()}
                            />
                            <button onClick={addLocation} className="bg-black text-white px-3 py-2 rounded-lg text-xs font-bold uppercase hover:bg-gray-800">Agregar</button>
                        </div>
                        <ul className="space-y-2">
                            {config.pickup_locations.map((loc, idx) => (
                                <li key={idx} className="flex justify-between items-center bg-gray-50 px-3 py-2 rounded-md border border-gray-100 text-sm">
                                    <span className="truncate mr-2">{loc}</span>
                                    <button onClick={() => removeLocation(idx)} className="text-red-500 hover:text-red-700 font-bold text-xs">ELIMINAR</button>
                                </li>
                            ))}
                        </ul>
                    </div>
                 )}
            </div>
        </div>
    </div>
  )
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "types": [
      "node"
    ],
        "paths": {
      "@/*": ["./*"] 
    }

  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="app/login/page.tsx">
'use client'
import { useState } from 'react'
import { createBrowserClient } from '@supabase/ssr'
import { useRouter } from 'next/navigation'
import { Lock, Mail, Loader2, UserPlus } from 'lucide-react'
import Swal from 'sweetalert2'
export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)
  const [isRegistering, setIsRegistering] = useState(false)
  const router = useRouter()
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
  const handleAuth = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    try {
      if (isRegistering) {
        // --- REGISTRO ---
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
        })
        if (error) throw error
        if (data.user && !data.session) {
          // ALERTA DE ÉXITO (Confirmar correo)
          Swal.fire({
            title: '¡Cuenta creada!',
            text: 'Revisa tu correo para confirmar tu cuenta, luego vuelve aqui .',
            icon: 'success',
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#000000',
            backdrop: true,
            allowOutsideClick: false
          })
          setLoading(false)
          return
        }
        router.refresh()
        router.push('/admin')
      } else {
        // --- LOGIN ---
        const { error } = await supabase.auth.signInWithPassword({
          email,
          password,
        })
        if (error) throw error
        router.refresh()
        router.push('/admin')
      }
    } catch (err: any) {
      // --- ALERTA DE ERROR (Aquí está el cambio) ---
      // Esto reemplaza al texto rojo. Ahora todo es SweetAlert.
      Swal.fire({
        title: 'Error',
        text: err.message || 'Ocurrió un error inesperado',
        icon: 'error',
        confirmButtonText: 'Intentar de nuevo',
        confirmButtonColor: '#000000', // Mantenemos tu branding negro
      })
      setLoading(false)
    }
  }
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100 transition-all">
        {/* HEADER */}
        <div className="text-center mb-8">
          <div className={`text-white w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-gray-200 transition-colors ${isRegistering ? 'bg-blue-600' : 'bg-black'}`}>
            {isRegistering ? <UserPlus size={24} /> : <Lock size={24} />}
          </div>
          <h1 className="text-2xl font-bold text-gray-900">
            {isRegistering ? 'Crear Cuenta Nueva' : 'Bienvenido de nuevo'}
          </h1>
          <p className="text-gray-500 text-sm mt-1">
            {isRegistering ? 'Empieza a vender hoy mismo' : 'Ingresa a tu panel de control'}
          </p>
        </div>
        <form onSubmit={handleAuth} className="space-y-4 text-gray-800">
          <div>
            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Email</label>
            <div className="relative">
              <Mail className="absolute left-3 top-3 text-gray-400" size={18} />
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full pl-10 pr-4 py-3 bg-gray-100 border border-gray-200 rounded-xl focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-all"
                placeholder="tu@email.com"
                required
              />
            </div>
          </div>
          <div>
            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Contraseña</label>
            <div className="relative">
              <Lock className="absolute left-3 top-3 text-gray-400" size={18} />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-all"
                placeholder="Minimo 6 caracteres"
                minLength={6}
                required
              />
            </div>
          </div>
          {/* YA NO HAY DIVS DE MENSAJES AQUÍ, EL DISEÑO QUEDA LIMPIO */}
          <button
            type="submit"
            disabled={loading}
            className={`w-full text-white font-bold py-3.5 rounded-xl hover:opacity-90 transition-all active:scale-95 disabled:opacity-70 flex items-center justify-center gap-2 ${isRegistering ? 'bg-blue-600' : 'bg-black'}`}
          >
            {loading ? <Loader2 className="animate-spin" /> : (isRegistering ? 'Registrarse' : 'Ingresar')}
          </button>
        </form>
        {/* SWITCH LOGIN / REGISTER */}
        <div className="mt-6 text-center pt-6 border-t border-gray-100">
          <p className="text-sm text-gray-500">
            {isRegistering ? '¿Ya tienes cuenta?' : '¿No tienes cuenta?'}
            <button
              onClick={() => {
                setIsRegistering(!isRegistering)
                // Ya no necesitamos limpiar errorMsg aquí porque no existe
              }}
              className="ml-2 font-bold text-black hover:underline focus:outline-none"
            >
              {isRegistering ? 'Inicia Sesión' : 'Regístrate aquí'}
            </button>
          </p>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="app/store/useCart.ts">
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'
// 1. DEFINICIÓN DE TIPOS (El Contrato)
// Aquí le decimos a TypeScript exactamente qué lleva un item del carrito
export interface CartItem {
  id: string
  productId: string
  variantId: string | null
  name: string
  price: number        // <--- Aquí definimos que SIEMPRE habrá un precio
  basePrice: number
  penalty: number
  image: string
  quantity: number
  variantInfo: string | null
}
interface CartState {
  items: CartItem[]
  addItem: (product: any, variant?: any, quantity?: number) => void
  removeItem: (itemId: string) => void
  updateQuantity: (itemId: string, quantity: number) => void
  clearCart: () => void
}
export const useCart = create<CartState>()(
  persist(
    (set, get) => ({
      items: [],
      addItem: (product, variant = null, quantity = 1) => {
        set((state) => {
          const variantId = variant ? variant.id : null
          const productId = product.id
          // Generamos ID único combinando producto y variante
          const uniqueId = `${productId}-${variantId || 'base'}`
          // Verificamos si ya existe
          const existingItemIndex = state.items.findIndex((i) => i.id === uniqueId)
          if (existingItemIndex > -1) {
            // SI EXISTE: Sumamos la cantidad nueva
            const newItems = [...state.items]
            newItems[existingItemIndex].quantity += quantity
            return { items: newItems }
          } else {
            // SI ES NUEVO: Creamos el objeto CartItem completo
            const newItem: CartItem = {
              id: uniqueId,
              productId: productId,
              variantId: variantId,
              name: product.name,
              // Lógica de Precio: Si la variante tuviera precio propio lo usaríamos, sino el del producto
              price: Number(product.usd_cash_price), 
              basePrice: Number(product.usd_cash_price),
              penalty: Number(product.usd_penalty || 0),
              // Lógica de Imagen: Prioridad Variante > Producto
              image: variant?.variant_image || product.image_url,
              quantity: quantity,
              variantInfo: variant ? `${variant.color_name} / ${variant.size}` : null
            }
            return { items: [...state.items, newItem] }
          }
        })
      },
      removeItem: (itemId) => {
        set((state) => ({
          items: state.items.filter((i) => i.id !== itemId),
        }))
      },
      updateQuantity: (itemId, quantity) => {
        set((state) => ({
          items: state.items.map((item) => {
            if (item.id === itemId) {
              // Evitamos cantidades negativas o cero
              const newQuantity = Math.max(1, quantity)
              return { ...item, quantity: newQuantity }
            }
            return item
          }),
        }))
      },
      clearCart: () => set({ items: [] }),
    }),
    {
      name: 'shopping-cart-storage',
      storage: createJSONStorage(() => localStorage),
    }
  )
)
</file>

<file path="components/PaymentSettings.tsx">
'use client'
import { useState } from 'react'
import { getSupabase } from '@/lib/supabase-client'
import { Save, Smartphone, Banknote, Bitcoin, Loader2 } from 'lucide-react'
import Swal from 'sweetalert2'
// CAMBIO: Ahora recibimos storeId en lugar de userId
export default function PaymentSettings({ storeId, initialData }: { storeId: string, initialData: any }) {
  const defaultMethods = {
    pago_movil: { active: false, bank: '', phone: '', id: '' },
    zelle: { active: false, email: '', holder: '' },
    cash: { active: true, info: '' },
    binance: { active: false, email: '' }
  }
  const [methods, setMethods] = useState({
    ...defaultMethods,
    ...(initialData || {}),
    pago_movil: { ...defaultMethods.pago_movil, ...(initialData?.pago_movil || {}) },
    zelle: { ...defaultMethods.zelle, ...(initialData?.zelle || {}) },
    cash: { ...defaultMethods.cash, ...(initialData?.cash || {}) },
    binance: { ...defaultMethods.binance, ...(initialData?.binance || {}) },
  })
  const [saving, setSaving] = useState(false)
  // Cliente Supabase Autenticado (Igual que en ShippingSettings)
  const supabase = getSupabase()
  const handleChange = (method: string, field: string, value: any) => {
    setMethods((prev: any) => ({
      ...prev,
      [method]: {
        ...prev[method],
        [field]: value
      }
    }))
  }
  const handleSave = async () => {
    if (!storeId) return
    setSaving(true)
    console.log("Guardando Pagos para tienda:", storeId);
    // GUARDAMOS USANDO storeId (No user_id)
    const { error } = await supabase
      .from('stores')
      .update({ payment_methods: methods })
      .eq('id', storeId) // <--- CRUCIAL
    setSaving(false)
    if (error) {
      console.error(error)
      Swal.fire('Error', 'No se pudo guardar la configuración', 'error')
    } else {
      const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
          customClass: { popup: 'bg-black text-white' }
       })
       Toast.fire({ icon: 'success', title: 'Métodos de Pago Actualizados' })
    }
  }
  return (
    <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mt-6">
      {/* HEADER */}
      <div className="flex justify-between items-center mb-6">
          <h3 className="text-lg font-black text-gray-900 flex items-center gap-2">
              <Banknote size={20} /> Métodos de Pago
          </h3>
          <button 
            onClick={handleSave} 
            disabled={saving} 
            className="bg-black text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-800 transition-all"
          >
             {saving ? <Loader2 className="animate-spin" size={16}/> : <Save size={16}/>}
             Guardar
          </button>
      </div>
      <div className="space-y-4">
        {/* PAGO MÓVIL */}
        <div className={`p-5 rounded-xl border transition-all ${methods.pago_movil?.active ? 'border-green-500 bg-green-50' : 'border-gray-100 bg-white'}`}>
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center gap-2 font-bold text-gray-800">
                <Smartphone size={18} className="text-green-600"/> Pago Móvil
            </div>
            <label className="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" className="sr-only peer" checked={methods.pago_movil?.active || false} onChange={(e) => handleChange('pago_movil', 'active', e.target.checked)} />
              <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
            </label>
          </div>
          {methods.pago_movil?.active && (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 animate-in fade-in">
              <input placeholder="Banco (Ej: Banesco)" value={methods.pago_movil.bank || ''} onChange={e => handleChange('pago_movil', 'bank', e.target.value)} className="input-elite" />
              <input placeholder="Teléfono (0414...)" value={methods.pago_movil.phone || ''} onChange={e => handleChange('pago_movil', 'phone', e.target.value)} className="input-elite" />
              <input placeholder="Cédula (V-123...)" value={methods.pago_movil.id || ''} onChange={e => handleChange('pago_movil', 'id', e.target.value)} className="input-elite" />
            </div>
          )}
        </div>
        {/* ZELLE */}
        <div className={`p-5 rounded-xl border transition-all ${methods.zelle?.active ? 'border-purple-500 bg-purple-50' : 'border-gray-100 bg-white'}`}>
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center gap-2 font-bold text-gray-800">
                <span className="text-purple-600 font-serif font-black italic text-lg">Z</span> Zelle
            </div>
            <label className="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" className="sr-only peer" checked={methods.zelle?.active || false} onChange={(e) => handleChange('zelle', 'active', e.target.checked)} />
              <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div>
            </label>
          </div>
          {methods.zelle?.active && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 animate-in fade-in">
              <input placeholder="Correo Zelle" value={methods.zelle.email || ''} onChange={e => handleChange('zelle', 'email', e.target.value)} className="input-elite" />
              <input placeholder="Nombre del Titular" value={methods.zelle.holder || ''} onChange={e => handleChange('zelle', 'holder', e.target.value)} className="input-elite" />
            </div>
          )}
        </div>
        {/* BINANCE */}
        <div className={`p-5 rounded-xl border transition-all ${methods.binance?.active ? 'border-yellow-500 bg-yellow-50' : 'border-gray-100 bg-white'}`}>
          <div className="flex justify-between items-center mb-4">
             <div className="flex items-center gap-2 font-bold text-gray-800">
                <Bitcoin size={18} className="text-yellow-600"/> Binance Pay
            </div>
            <label className="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" className="sr-only peer" checked={methods.binance?.active || false} onChange={(e) => handleChange('binance', 'active', e.target.checked)} />
              <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500"></div>
            </label>
          </div>
           {methods.binance?.active && (
            <div className="animate-in fade-in">
              <input placeholder="Email o Pay ID" value={methods.binance.email || ''} onChange={e => handleChange('binance', 'email', e.target.value)} className="input-elite" />
            </div>
          )}
        </div>
        {/* EFECTIVO */}
        <div className={`p-5 rounded-xl border transition-all ${methods.cash?.active ? 'border-green-800 bg-green-50' : 'border-gray-100 bg-white'}`}>
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center gap-2 font-bold text-gray-800">
                <Banknote size={18} className="text-green-800"/> Efectivo / Divisas
            </div>
            <label className="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" className="sr-only peer" checked={methods.cash?.active || false} onChange={(e) => handleChange('cash', 'active', e.target.checked)} />
              <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-800"></div>
            </label>
          </div>
          {methods.cash?.active && (
            <div className="animate-in fade-in">
                 <input placeholder="Instrucciones (Ej: Pagar al retirar)" value={methods.cash.info || ''} onChange={e => handleChange('cash', 'info', e.target.value)} className="input-elite" />
            </div>
          )}
        </div>
      </div>
      <style jsx global>{`
        .input-elite {
            @apply w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:ring-1 focus:ring-black focus:border-black transition-all placeholder:text-gray-400;
        }
      `}</style>
    </div>
  )
}
</file>

<file path="app/admin/product/new/page.tsx">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import ProductEditor from '@/components/ProductEditor'
export default async function NewProductPage() {
  const cookieStore = await cookies()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    { cookies: { getAll() { return cookieStore.getAll() } } }
  )
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return <div>No autorizado</div>
  const [configRes, storeRes] = await Promise.all([
    supabase.from('app_config').select('usd_rate, eur_rate').eq('id', 1).single(),
    supabase.from('stores').select('id, currency_type').eq('user_id', user.id).single()
  ])
  return (
    <ProductEditor 
        rates={{ 
            usd: configRes.data?.usd_rate || 0, 
            eur: configRes.data?.eur_rate || 0 
        }}
        storeSettings={{
            id: storeRes.data?.id || '',
            currency: storeRes.data?.currency_type || 'usd'
        }}
    />
  )
}
</file>

<file path="app/page.tsx">
import LandingClient from '@/components/LandingClient';
import { Metadata } from 'next';
// --- METADATOS SEO (CRUCIAL PARA GOOGLE) ---
export const metadata: Metadata = {
  title: 'Preziso | Automatización de Tasa BCV para E-commerce en Venezuela',
  description: 'Olvídate de calcular la tasa. Preziso actualiza tus precios automáticamente según el BCV y organiza tus pedidos de WhatsApp.',
  keywords: ['tasa bcv', 'ecommerce venezuela', 'tienda online venezuela', 'automatizacion ventas', 'catalogo digital'],
  openGraph: {
    title: 'Preziso - Vende en Dólares, Cobra en Bs (Automático)',
    description: 'Sistema operativo para comercios en Venezuela. Sincronización BCV 24/7.',
    type: 'website',
    // images: ['/og-image.jpg'], // Recuerda agregar una imagen luego
  }
};
// Optimizamos para que sea una página estática ultra rápida (SEO Friendly)
// Si necesitas que sea dinámica por alguna razón, cambia a 'force-dynamic'
export const dynamic = 'force-static'; 
export default function Home() {
  // NOTA: Hemos eliminado la lógica de Supabase (productos y dólar) 
  // porque esta es la página de Marketing del Software, no la tienda de un cliente.
  // La carga de productos se hará en las rutas de las tiendas (ej: /[slug]).
  return <LandingClient />;
}
</file>

<file path="app/product/[id]/page.tsx">
'use client'
import { useState, useEffect, useMemo } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { ArrowLeft, ShoppingBag, Truck, ShieldCheck, AlertCircle } from 'lucide-react'
import Link from 'next/link'
import { supabase } from '@/lib/supabase'
import { useCart } from '@/app/store/useCart'
import Swal from 'sweetalert2'
export default function ProductPage() {
  const { id } = useParams()
  const router = useRouter()
  const { addItem } = useCart()
  const [product, setProduct] = useState<any>(null)
  const [variants, setVariants] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  // ESTADOS DE SELECCIÓN (La Lógica Kinetic)
  const [selectedColor, setSelectedColor] = useState<string | null>(null)
  const [selectedSize, setSelectedSize] = useState<string | null>(null)
  const [currentImage, setCurrentImage] = useState<string>('')
  // 1. Cargar Datos
  useEffect(() => {
    const fetchProduct = async () => {
      // Cargar Producto Padre
      const { data: prod, error } = await supabase
        .from('products')
        .select('*, stores(name, id, currency_symbol, usd_price, currency_type)')
        .eq('id', id)
        .single()
      if (error || !prod) {
        router.push('/')
        return
      }
      setProduct(prod)
      setCurrentImage(prod.image_url) // Imagen inicial
      // Cargar Variantes
      const { data: vars } = await supabase
        .from('product_variants')
        .select('*')
        .eq('product_id', id)
        .gt('stock', 0) // Solo traer lo que tiene stock (Elite UX)
      if (vars && vars.length > 0) {
        setVariants(vars)
        // Auto-seleccionar primer color disponible para evitar clicks extra
        const firstColor = vars[0].color_name
        setSelectedColor(firstColor)
      }
      setLoading(false)
    }
    fetchProduct()
  }, [id, router])
  // 2. Lógica de Agrupación (Matrix)
  const availableColors = useMemo(() => {
    // Extraer colores únicos y sus hex
    const map = new Map()
    variants.forEach(v => {
        if (!map.has(v.color_name)) {
            map.set(v.color_name, { name: v.color_name, hex: v.color_hex, image: v.variant_image })
        }
    })
    return Array.from(map.values())
  }, [variants])
  const availableSizes = useMemo(() => {
    if (!selectedColor) return []
    // Filtrar tallas disponibles SOLO para el color seleccionado
    return variants
        .filter(v => v.color_name === selectedColor)
        .sort((a, b) => a.size.localeCompare(b.size, undefined, { numeric: true })) // Ordenar tallas lógicamente
  }, [variants, selectedColor])
  // 3. Manejadores (Handlers)
  const handleColorSelect = (colorName: string, imageOverride: string | null) => {
    setSelectedColor(colorName)
    setSelectedSize(null) // Resetear talla al cambiar color
    // Kinetic Image Swap
    if (imageOverride) setCurrentImage(imageOverride)
    else setCurrentImage(product.image_url) // Volver a la original si no hay override
  }
  const handleAddToCart = () => {
    // Validación Estricta
    if (variants.length > 0) {
        if (!selectedColor) return Swal.fire('Falta Color', 'Selecciona un color', 'warning')
        if (!selectedSize) return Swal.fire('Falta Talla', 'Selecciona tu talla', 'warning')
        // Encontrar la variante exacta (El ID real de la base de datos)
        const specificVariant = variants.find(v => v.color_name === selectedColor && v.size === selectedSize)
        if (specificVariant) {
            addItem(product, specificVariant)
        }
    } else {
        // Producto simple (sin variantes)
        addItem(product)
    }
    const Toast = Swal.mixin({
        toast: true, position: 'top', showConfirmButton: false, timer: 1500,
        customClass: { popup: 'bg-black text-white rounded-none' }
    })
    Toast.fire({ icon: 'success', title: 'AGREGADO AL CARRITO' })
  }
  if (loading) return <div className="min-h-screen bg-white flex items-center justify-center"><span className="animate-pulse font-bold text-xs tracking-widest">CARGANDO PRODUCTO...</span></div>
  return (
    <div className="min-h-screen bg-white text-gray-900 pb-32 animate-in fade-in duration-500">
      {/* NAV SIMPLE */}
      <div className="fixed top-0 w-full bg-white/80 backdrop-blur-md z-40 px-4 py-4 flex justify-between items-center border-b border-gray-100">
        <Link href="/" className="p-2 hover:bg-gray-100 rounded-full transition-colors">
            <ArrowLeft size={20} />
        </Link>
        <span className="font-bold text-sm tracking-wide uppercase truncate max-w-[200px]">{product.name}</span>
        <div className="w-10"></div> {/* Spacer */}
      </div>
      <div className="pt-20 max-w-md mx-auto px-4">
        {/* IMAGEN HERO (KINETIC) */}
        <div className="aspect-square bg-gray-50 rounded-2xl mb-8 relative overflow-hidden group border border-gray-100">
            {currentImage ? (
                <img 
                    src={currentImage} 
                    alt={product.name} 
                    className="w-full h-full object-contain p-6 mix-blend-multiply transition-all duration-500 group-hover:scale-105"
                />
            ) : (
                <div className="w-full h-full flex items-center justify-center text-gray-300 font-bold text-4xl">P.</div>
            )}
            {/* Badge de Precio */}
            <div className="absolute bottom-4 right-4 bg-black/90 text-white backdrop-blur px-4 py-2 rounded-lg shadow-lg">
                <span className="text-xs font-bold text-gray-400 mr-1">$</span>
                <span className="text-xl font-black tracking-tighter">{product.usd_cash_price}</span>
            </div>
        </div>
        {/* INFO PRINCIPAL */}
        <div className="mb-8">
            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{product.category}</span>
            <h1 className="text-3xl font-black tracking-tight leading-none mt-1 mb-3 text-black">{product.name}</h1>
            {product.description && <p className="text-gray-500 text-sm leading-relaxed">{product.description}</p>}
        </div>
        {/* --- SELECTORES "ELITE" --- */}
        {variants.length > 0 && (
            <div className="space-y-6 bg-gray-50/50 p-6 rounded-2xl border border-gray-100">
                {/* 1. SELECTOR DE COLOR */}
                <div>
                    <div className="flex justify-between mb-3">
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Color</span>
                        <span className="text-xs font-bold text-black">{selectedColor}</span>
                    </div>
                    <div className="flex flex-wrap gap-3">
                        {availableColors.map((c: any) => (
                            <button
                                key={c.name}
                                onClick={() => handleColorSelect(c.name, c.image)}
                                className={`w-10 h-10 rounded-full border-2 shadow-sm transition-all duration-300 relative ${selectedColor === c.name ? 'border-black scale-110 ring-2 ring-black ring-offset-2' : 'border-gray-200 hover:scale-105'}`}
                                style={{ backgroundColor: c.hex }}
                                title={c.name}
                            >
                                {/* Check visual si está seleccionado */}
                                {selectedColor === c.name && c.hex.toLowerCase() === '#ffffff' && <div className="absolute inset-0 flex items-center justify-center"><div className="w-2 h-2 bg-black rounded-full"></div></div>}
                            </button>
                        ))}
                    </div>
                </div>
                {/* 2. SELECTOR DE TALLA */}
                <div>
                     <div className="flex justify-between mb-3">
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Talla / Medida</span>
                        {selectedSize && <span className="text-xs font-bold text-black animate-in fade-in">Seleccionada: {selectedSize}</span>}
                    </div>
                    {!selectedColor ? (
                        <div className="flex items-center gap-2 text-xs text-orange-500 bg-orange-50 px-3 py-2 rounded-lg border border-orange-100">
                            <AlertCircle size={14} /> Selecciona un color primero
                        </div>
                    ) : (
                        <div className="grid grid-cols-4 gap-2">
                            {availableSizes.map((v) => (
                                <button
                                    key={v.id}
                                    onClick={() => setSelectedSize(v.size)}
                                    className={`py-3 rounded-xl text-sm font-bold border transition-all duration-200 ${
                                        selectedSize === v.size 
                                        ? 'bg-black text-white border-black shadow-lg transform -translate-y-0.5' 
                                        : 'bg-white text-gray-600 border-gray-200 hover:border-black hover:text-black'
                                    }`}
                                >
                                    {v.size}
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        )}
        {/* --- GARANTÍAS (Micro-copy de conversión) --- */}
        <div className="mt-8 grid grid-cols-2 gap-4">
            <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                <Truck size={20} className="text-gray-400"/>
                <span className="text-[10px] font-bold text-gray-500 uppercase leading-tight">Envío Nacional<br/>Disponible</span>
            </div>
            <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
                <ShieldCheck size={20} className="text-gray-400"/>
                <span className="text-[10px] font-bold text-gray-500 uppercase leading-tight">Compra Segura<br/>Verificada</span>
            </div>
        </div>
      </div>
      {/* FOOTER FIJO DE ACCIÓN */}
      <div className="fixed bottom-0 w-full bg-white border-t border-gray-100 p-4 safe-area-pb z-50">
         <div className="max-w-md mx-auto flex gap-4">
             <div className="flex flex-col justify-center">
                 <span className="text-[10px] font-bold text-gray-400 uppercase">Total</span>
                 <span className="text-2xl font-black text-black tracking-tight">${product.usd_cash_price}</span>
             </div>
             <button 
                onClick={handleAddToCart}
                className="flex-1 bg-black text-white rounded-xl font-bold uppercase tracking-widest text-sm hover:bg-gray-800 transition-all shadow-xl shadow-black/10 flex items-center justify-center gap-2"
             >
                <ShoppingBag size={18} /> Agregar
             </button>
         </div>
      </div>
    </div>
  )
}
</file>

<file path="components/LandingClient.tsx">
'use client'
import AmbientBackground from './AmbientBackground'
import { useState, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { 
  ShoppingBag, Zap, MessageCircle, ArrowRight, CheckCircle2, 
  Globe, RefreshCw, Menu, X, TrendingUp, 
  Layers, AlertTriangle, ChevronDown, Lock, Instagram, Mail, User,
  Moon, Sun
} from 'lucide-react'
// --- COMPONENTES PEQUEÑOS ---
const BcvTicker = () => (
  // Optimization: 'will-change-transform' ayuda al navegador a priorizar esta animación
  <div className="bg-gray-50/90 dark:bg-zinc-900/90 border-b border-gray-200 dark:border-zinc-800 py-2 overflow-hidden relative z-50 backdrop-blur-sm">
    <div className="whitespace-nowrap flex animate-ticker w-max will-change-transform">
      {[...Array(6)].map((_, i) => (
        <div key={i} className="flex items-center gap-8 mx-6 text-[10px] font-mono tracking-widest">
          <span className="flex items-center gap-2 text-green-600 dark:text-green-400 font-bold">
             <span className="relative flex h-2 w-2">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            BCV: EN VIVO
          </span>
          <span className="text-gray-400 dark:text-zinc-500">|</span>
          <span className="text-gray-600 dark:text-gray-300 font-medium">CUPO LIMITADO</span>
          <span className="text-gray-400 dark:text-zinc-500">|</span>
          <span className="text-gray-600 dark:text-gray-300 font-medium">ACCESO BETA</span>
          <span className="text-gray-400 dark:text-zinc-500">|</span>
          <span className="text-gray-600 dark:text-gray-300 font-medium">VENDE EN $ • COBRA EN BS</span>
        </div>
      ))}
    </div>
    <style jsx>{`
      /* Optimization: translate3d forces GPU acceleration */
      @keyframes ticker { 0% { transform: translate3d(0,0,0); } 100% { transform: translate3d(-50%,0,0); } }
      .animate-ticker { animation: ticker 40s linear infinite; }
    `}</style>
  </div>
)
const WaitlistForm = () => {
    const [form, setForm] = useState({ name: '', instagram: '', email: '' })
    const [loading, setLoading] = useState(false)
    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault()
        setLoading(true)
        setTimeout(() => {
            const message = `🚀 *SOLICITUD PREZISO*\n\nHola, quiero unirme a la lista.\n\n👤 *Nombre:* ${form.name}\n📸 *Instagram:* ${form.instagram}\n📧 *Correo:* ${form.email}`
            const myNumber = "584145811936" 
            const url = `https://wa.me/${myNumber}?text=${encodeURIComponent(message)}`
            window.open(url, '_blank')
            setLoading(false)
        }, 800)
    }
    return (
        <form onSubmit={handleSubmit} className="w-full max-w-md bg-white/70 dark:bg-zinc-900/70 backdrop-blur-md border border-gray-200 dark:border-zinc-800 p-2 rounded-2xl shadow-xl dark:shadow-black/50 flex flex-col gap-2 mt-8 relative z-20 transition-colors duration-300">
            <div className="absolute -top-3 left-4 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border border-green-200 dark:border-green-800/50">
                Lista de Espera Abierta
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 p-2">
                <div className="relative">
                    <User size={14} className="absolute top-3.5 left-3 text-gray-400"/>
                    <input 
                        required
                        placeholder="Tu Nombre"
                        value={form.name}
                        onChange={e => setForm({...form, name: e.target.value})}
                        className="w-full bg-gray-50/50 dark:bg-zinc-950/50 border border-transparent focus:bg-white dark:focus:bg-zinc-900 focus:border-gray-200 dark:focus:border-zinc-700 rounded-xl pl-9 pr-3 py-3 text-sm outline-none transition-all font-medium text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-zinc-600"
                    />
                </div>
                <div className="relative">
                    <Instagram size={14} className="absolute top-3.5 left-3 text-gray-400"/>
                    <input 
                        required
                        placeholder="@tu_negocio"
                        value={form.instagram}
                        onChange={e => setForm({...form, instagram: e.target.value})}
                        className="w-full bg-gray-50/50 dark:bg-zinc-950/50 border border-transparent focus:bg-white dark:focus:bg-zinc-900 focus:border-gray-200 dark:focus:border-zinc-700 rounded-xl pl-9 pr-3 py-3 text-sm outline-none transition-all font-medium text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-zinc-600"
                    />
                </div>
            </div>
            <div className="flex flex-col sm:flex-row gap-2 px-2 pb-2">
                 <div className="relative flex-1">
                    <Mail size={14} className="absolute top-3.5 left-3 text-gray-400"/>
                    <input 
                        required
                        type="email"
                        placeholder="tu@correo.com"
                        value={form.email}
                        onChange={e => setForm({...form, email: e.target.value})}
                        className="w-full bg-gray-50/50 dark:bg-zinc-950/50 border border-transparent focus:bg-white dark:focus:bg-zinc-900 focus:border-gray-200 dark:focus:border-zinc-700 rounded-xl pl-9 pr-3 py-3 text-sm outline-none transition-all font-medium text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-zinc-600"
                    />
                </div>
                <button 
                    type="submit"
                    disabled={loading}
                    className="bg-black dark:bg-white text-white dark:text-black px-6 py-3 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-gray-800 dark:hover:bg-gray-200 transition-all flex items-center justify-center gap-2 whitespace-nowrap shadow-lg disabled:opacity-70 disabled:cursor-not-allowed"
                >
                    {loading ? '...' : <>Unirme <ArrowRight size={14}/></>}
                </button>
            </div>
            <p className="text-[10px] text-gray-400 dark:text-zinc-500 text-center pb-2 flex items-center justify-center gap-1">
                <Lock size={10}/> Tus datos se envían encriptados a WhatsApp.
            </p>
        </form>
    )
}
const PainAlert = () => (
  <motion.div 
    initial={{ opacity: 0, y: 20, x: 20 }}
    animate={{ opacity: 1, y: 0, x: 0 }}
    transition={{ delay: 1, duration: 0.8 }}
    className="absolute -top-6 -right-6 z-20 bg-[rgba(255,255,255,0.8)] dark:bg-[#0a0c0bb3] border border-red-100 dark:border-[#ffc85547] p-4 rounded-2xl shadow-xl max-w-[200px] hidden md:block backdrop-blur-md"
  >
    <div className="flex items-start gap-3">
      <AlertTriangle size={16} className="text-red-500 dark:text-[#ffc855d1] shrink-0 mt-0.5" />
      <div>
        <p className="text-[10px] font-bold text-red-800 dark:text-[#ffc855d4] leading-tight mb-1">ALERTA DE MARGEN</p>
        <p className="text-[10px] text-red-600 dark:text-[#ffc855d4] leading-relaxed">
          Si el dólar sube hoy y tardas 1h en cambiar precios, pierdes el <span className="font-black">5% de tu ganancia</span>.
        </p>
      </div>
    </div>
  </motion.div>
)
const InteractiveDemo = () => {
    const [method, setMethod] = useState('zelle')
    const rate = 60.25
    const price = 45.00
    const penalty = 2.00 
    const finalUSD = method === 'pago_movil' ? price : (price - penalty)
    const finalBs = finalUSD * rate
    return (
        <div className="relative group w-full max-w-[340px] mx-auto perspective-1000">
             <PainAlert />
             {/* Glow Trasero */}
            <div className="absolute -inset-1 bg-gradient-to-tr from-gray-200 to-gray-100 dark:from-zinc-800 dark:to-[#3000ffed] rounded-[2rem] blur-xl opacity-50"></div>
            <div className="relative bg-white/90 dark:bg-[#000000a8] backdrop-blur-xl rounded-[1.8rem] border border-gray-200 dark:border-zinc-800 shadow-2xl overflow-hidden p-6 transition-colors duration-300">
                {/* Header Mockup */}
                <div className="flex justify-between items-center mb-6 border-b border-gray-100 dark:border-zinc-800 pb-4">
                    <div className="flex items-center gap-3">
                        <div className="w-9 h-9 bg-black dark:bg-white rounded-xl flex items-center justify-center text-white dark:text-black shadow-lg">
                            <ShoppingBag size={16} />
                        </div>
                        <div>
                            <p className="text-[10px] font-bold text-gray-400 uppercase leading-none mb-0.5">Checkout</p>
                            <p className="text-sm font-black text-gray-900 dark:text-white">Preziso Store</p>
                        </div>
                    </div>
                    <div className="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2.5 py-1 rounded-lg text-[10px] font-bold flex items-center gap-1">
                        <RefreshCw size={10} className="animate-spin-slow"/> BCV: {rate}
                    </div>
                </div>
                {/* Producto */}
                <div className="flex items-center gap-4 mb-6">
                    <div className="w-12 h-12 bg-gray-50 dark:bg-zinc-800 rounded-xl border border-gray-100 dark:border-zinc-700 flex items-center justify-center text-2xl">👟</div>
                    <div>
                        <p className="text-sm font-bold text-gray-900 dark:text-white">Nike Air Force 1</p>
                        <p className="text-[11px] text-gray-500 dark:text-gray-400">Blanco • Talla 42</p>
                    </div>
                    <div className="ml-auto font-black text-sm text-gray-900 dark:text-white">${price}</div>
                </div>
                {/* Selectores */}
                <div className="bg-gray-50 dark:bg-zinc-950 p-1 rounded-xl grid grid-cols-2 gap-1 mb-6 border border-transparent dark:border-zinc-800">
                    <button 
                        onClick={() => setMethod('pago_movil')}
                        className={`py-2 rounded-lg text-[10px] font-bold transition-all ${method === 'pago_movil' ? 'bg-white dark:bg-zinc-800 text-black dark:text-white shadow-sm ring-1 ring-black/5 dark:ring-white/10' : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'}`}
                    >
                        Pago Móvil (Bs)
                    </button>
                    <button 
                        onClick={() => setMethod('zelle')}
                        className={`py-2 rounded-lg text-[10px] font-bold transition-all ${method === 'zelle' ? 'bg-green-500 text-white shadow-md' : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'}`}
                    >
                        Zelle (-${penalty})
                    </button>
                </div>
                {/* Total */}
                <div className="bg-[#0A0A0A] dark:bg-black rounded-2xl p-5 text-white relative overflow-hidden border border-transparent dark:border-zinc-800">
                    <div className="flex justify-between items-end relative z-10">
                        <div>
                             <p className="text-[9px] text-gray-400 font-bold uppercase mb-1">Total a Pagar</p>
                             <motion.p 
                                key={finalUSD}
                                initial={{ opacity: 0, y: 5 }}
                                animate={{ opacity: 1, y: 0 }}
                                className="text-3xl font-black tracking-tight"
                             >
                                ${finalUSD.toFixed(2)}
                             </motion.p>
                        </div>
                        <div className="text-right">
                             {method === 'pago_movil' ? (
                                <>
                                    <p className="text-[9px] text-gray-400 font-bold uppercase mb-1">Referencia BCV</p>
                                    <p className="text-sm font-mono text-green-400 font-bold border-b border-green-500/30 pb-0.5">
                                        Bs {finalBs.toLocaleString('es-VE', { maximumFractionDigits: 2 })}
                                    </p>
                                </>
                             ) : (
                                <span className="bg-green-500/20 text-green-400 px-2 py-1 rounded text-[10px] font-bold">
                                    Descuento Aplicado
                                </span>
                             )}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    )
}
const VariantShowcase = () => {
    const [color, setColor] = useState('black')
    const [size, setSize] = useState('42')
    return (
        <section className="py-24 bg-transparent border-t border-gray-100 dark:border-zinc-900 transition-colors duration-300">
            <div className="max-w-7xl flex justify-center mx-auto px-6 grid lg:grid-cols-2 gap-16 items-center">
                <div className="order-2 lg:order-1">
                    <div className="relative bg-gray-50/60 dark:bg-zinc-900/60 backdrop-blur-md border border-gray-200 dark:border-zinc-800 rounded-[2.5rem] p-8 md:p-12 overflow-hidden transition-colors duration-300">
                        {/* Fake Browser Header */}
                        <div className="flex gap-2 mb-8">
                            <div className="w-3 h-3 rounded-full bg-red-400/80"></div>
                            <div className="w-3 h-3 rounded-full bg-yellow-400/80"></div>
                            <div className="w-3 h-3 rounded-full bg-green-400/80"></div>
                        </div>
                        <div className="flex gap-8">
                             {/* Product Image Placeholder */}
                            <motion.div 
                                key={color}
                                initial={{ opacity: 0.5, scale: 0.9 }}
                                animate={{ opacity: 1, scale: 1 }}
                                className={`w-32 h-32 md:w-48 md:h-48 rounded-2xl flex items-center justify-center text-4xl shadow-inner ${color === 'black' ? 'bg-gray-900 text-white dark:bg-black' : (color === 'green' ? 'bg-green-600 text-white' : 'bg-white border border-gray-200 dark:border-zinc-700 text-black')}`}
                            >
                                👟
                            </motion.div>
                            <div className="flex-1 space-y-6">
                                <div>
                                    <h4 className="font-black text-xl mb-1 dark:text-white">Urban Kicks V2</h4>
                                    <p className="text-sm text-gray-500 dark:text-zinc-400 font-mono">$120.00 USD</p>
                                </div>
                                <div>
                                    <p className="text-[10px] font-bold uppercase text-gray-400 mb-2">Color</p>
                                    <div className="flex gap-2">
                                        {['black', 'white', 'green'].map(c => (
                                            <button 
                                                key={c} 
                                                onClick={() => setColor(c)}
                                                className={`w-8 h-8 rounded-full border-2 transition-all ${color === c ? 'border-black dark:border-white scale-110' : 'border-transparent opacity-50 hover:opacity-100'} ${c === 'black' ? 'bg-black' : (c === 'green' ? 'bg-green-600' : 'bg-white border-gray-200 dark:border-zinc-700 shadow-sm')}`}
                                            />
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <p className="text-[10px] font-bold uppercase text-gray-400 mb-2">Talla</p>
                                    <div className="flex gap-2">
                                        {['40', '41', '42'].map(s => (
                                            <button 
                                                key={s}
                                                onClick={() => setSize(s)}
                                                className={`w-8 h-8 rounded-lg text-xs font-bold transition-all ${size === s ? 'bg-black dark:bg-white text-white dark:text-black' : 'bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 text-gray-500 dark:text-zinc-400 hover:border-gray-400'}`}
                                            >
                                                {s}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div className="order-1 lg:order-2">
                    <span className="inline-block px-3 py-1 rounded-full bg-black/5 dark:bg-white/10 text-black dark:text-white text-[10px] font-bold uppercase tracking-widest mb-6">
                        Gestión de Catálogo V2
                    </span>
                    <h2 className="text-4xl md:text-5xl font-black tracking-tight mb-6 dark:text-white">
                        No vendas productos.<br/>
                        <span className="text-gray-400 dark:text-zinc-600">Vende opciones.</span>
                    </h2>
                    <p className="text-lg text-gray-500 pr-4 dark:text-zinc-400 mb-8 leading-relaxed">
                        El cliente venezolano es exigente. Quiere ver la foto exacta del color que le gusta y saber si hay su talla. 
                        Preziso gestiona <strong>variantes complejas, stock por talla</strong> y categorías ilimitadas.
                    </p>
                    <ul className="space-y-4">
                        <li className="flex items-center gap-3 font-medium dark:text-zinc-300">
                            <CheckCircle2 size={18} className="text-black dark:text-white"/> Control de Stock por Talla/Color
                        </li>
                        <li className="flex items-center gap-3 font-medium dark:text-zinc-300">
                            <CheckCircle2 size={18} className="text-black dark:text-white"/> Fotos específicas por Variante
                        </li>
                        <li className="flex items-center gap-3 font-medium dark:text-zinc-300">
                            <CheckCircle2 size={18} className="text-black dark:text-white"/> Precios distintos según material
                        </li>
                    </ul>
                </div>
            </div>
        </section>
    )
}
const FAQ = () => {
    const [open, setOpen] = useState<number | null>(null)
    const faqs = [
        { q: "¿Cuándo tendré acceso?", a: "Estamos liberando cupos semanalmente para garantizar que la sincronización con el BCV sea perfecta para cada tienda nueva. Al registrarte te notificaremos por WhatsApp." },
        { q: "¿Necesito tarjeta internacional?", a: "No. Preziso está hecho para Venezuela. Podrás pagar tu mensualidad con Pago Móvil o Binance." },
        { q: "¿El dinero pasa por ustedes?", a: "Nunca. Preziso es una herramienta de cálculo y catálogo. El dinero de tus ventas va directo de tu cliente a tu banco." },
        { q: "¿Funciona en teléfonos viejos?", a: "Sí. La tienda que ven tus clientes es ultra ligera y carga rápido incluso con datos móviles inestables." }
    ]
    return (
        <section className="py-24 bg-transparent border-t border-gray-200 dark:border-zinc-800 transition-colors duration-300">
            <div className="max-w-3xl mx-auto px-6">
                <h2 className="text-3xl font-black text-center mb-12 dark:text-white">Preguntas Frecuentes</h2>
                <div className="space-y-4">
                    {faqs.map((faq, i) => (
                        <div key={i} className="bg-white/80 dark:bg-zinc-900/80 backdrop-blur-md rounded-2xl border border-gray-200 dark:border-zinc-800 overflow-hidden transition-colors duration-300">
                            <button 
                                onClick={() => setOpen(open === i ? null : i)}
                                className="w-full flex items-center justify-between p-6 text-left hover:bg-gray-50/50 dark:hover:bg-zinc-800/30 transition-colors"
                            >
                                <span className="font-bold text-gray-900 dark:text-white">{faq.q}</span>
                                <ChevronDown 
                                    className={`text-gray-400 transition-transform duration-300 ${open === i ? 'rotate-180' : ''}`}
                                />
                            </button>
                            <AnimatePresence>
                                {open === i && (
                                    <motion.div 
                                        initial={{ height: 0 }}
                                        animate={{ height: 'auto' }}
                                        exit={{ height: 0 }}
                                        className="overflow-hidden"
                                    >
                                        <p className="p-6 pt-0 text-gray-500 dark:text-zinc-400 leading-relaxed text-sm">
                                            {faq.a}
                                        </p>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    ))}
                </div>
            </div>
        </section>
    )
}
const Testimonials = () => (
    <section className="py-24 bg-transparent border-t border-gray-200 dark:border-zinc-900 transition-colors duration-300">
        <div className="max-w-7xl mx-auto px-6 text-center">
            <h2 className="text-3xl font-black mb-16 dark:text-white">Ya confían en nosotros</h2>
            <div className="grid md:grid-cols-3 gap-8">
                {[
                    { name: "Carlos D.", role: "Tech Store VE", text: "Antes pasaba 2 horas cada mañana cambiando etiquetas. Ahora me levanto y los precios ya están al día." },
                    { name: "Andrea M.", role: "Moda & Calzado", text: "Mis clientes aman que el carrito les diga exactamente cuánto es en Bolívares. Cierro el doble de ventas por WhatsApp." },
                    { name: "Luis R.", role: "Repuestos Auto", text: "Lo mejor es el control de stock. Si vendo una pieza por mostrador, se descuenta de la web al instante." }
                ].map((t, i) => (
                    <div key={i} className="p-8 rounded-[2rem] bg-gray-50/60 dark:bg-zinc-900/60 backdrop-blur-md border border-gray-100 dark:border-zinc-800 hover:shadow-xl transition-all duration-300">
                        <div className="flex justify-center mb-4 text-green-500">★★★★★</div>
                        <p className="text-gray-600 dark:text-zinc-300 font-medium mb-6 italic">"{t.text}"</p>
                        <div>
                            <p className="font-black text-gray-900 dark:text-white">{t.name}</p>
                            <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">{t.role}</p>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </section>
)
// --- LANDING PRINCIPAL ---
export default function LandingClient() {
    const [isDarkMode, setIsDarkMode] = useState(false)
    const [menuOpen, setMenuOpen] = useState(false)
    // Lógica de Modo Oscuro Manual
    useEffect(() => {
        if (isDarkMode) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    }, [isDarkMode])
   const scrollToForm = () => {
    const formElement = document.getElementById('formulario-registro') 
    if (formElement) {
        formElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
    }
}
    // AQUI ES DONDE OCURRE LA MAGIA DEL FONDO: "relative z-0" y bg-transparent
    return (
        <div className={`min-h-screen relative z-0 bg-transparent font-sans text-gray-900 dark:text-zinc-100 selection:bg-black selection:text-white dark:selection:bg-white dark:selection:text-black overflow-x-hidden transition-colors duration-300 ${isDarkMode ? 'dark' : ''}`}>
            <AmbientBackground />
            <BcvTicker />
                    {/* NAVBAR */}
<nav className="relative top-2 w-[98%] left-1/2 -translate-x-1/2 rounded-[25px] z-40 bg-white/70 dark:bg-zinc-950/70 backdrop-blur-xl border-b border-gray-100 dark:border-zinc-800 transition-colors duration-300">
    <div className="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
        {/* ZONA DEL LOGO MODIFICADA */}
        <div className="flex items-center gap-2 cursor-pointer">
            {/* Logo para Modo Claro (Se oculta en dark mode) */}
            {/* mix-blend-multiply ayuda a que el fondo gris del JPG se fusione con el header */}
            <img 
                src="/pezisologo.png" 
                alt="Preziso Logo" 
                className="h-13 w-auto object-contain block dark:hidden mix-blend-multiply" 
            />
            {/* Logo para Modo Oscuro (Se muestra solo en dark mode) */}
            <img 
                src="/pezisologow.png" 
                alt="Preziso Logo" 
                className="h-13 w-auto object-contain hidden dark:block" 
            />
        </div>
                    <div className="hidden md:flex items-center gap-8">
                        <a href="#features" className="text-xs font-bold text-gray-500 hover:text-black dark:hover:text-white uppercase tracking-wide">Características</a>
                        <a href="#demo" className="text-xs font-bold text-gray-500 hover:text-black dark:hover:text-white uppercase tracking-wide">Demo</a>
                    </div>
                    <div className="flex items-center gap-4">
                        {/* Botón Dark Mode */}
                        <button 
                            onClick={() => setIsDarkMode(!isDarkMode)}
                            className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors"
                        >
                            {isDarkMode ? <Sun size={18} /> : <Moon size={18} />}
                        </button>
                        <button onClick={scrollToForm} className="bg-black dark:bg-white text-white dark:text-black px-6 py-3 rounded-full text-xs font-bold uppercase tracking-wider hover:bg-gray-800 dark:hover:bg-gray-200 transition-all shadow-lg flex items-center gap-2">
                            Unirse a la Lista <ArrowRight size={14}/>
                        </button>
                    </div>
                </div>
            </nav>
            {/* HERO - bg-transparent */}
            <section className="pt-24 pb-20 lg:pt-32 lg:pb-32 relative overflow-hidden bg-transparent">
                <div className="max-w-7xl mx-auto px-6 grid lg:grid-cols-12 gap-12 items-center">
                    <div className="lg:col-span-7 flex flex-col items-center lg:items-start text-center lg:text-left">
                        <motion.div 
                            id="formulario-registro"
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="inline-flex items-center gap-2 bg-white/60 dark:bg-zinc-900/60 backdrop-blur-md border border-gray-200 dark:border-zinc-800 rounded-full px-4 py-1.5 mb-8 shadow-sm transition-colors duration-300"
                        >
                            <span className="flex h-2 w-2 relative">
                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            <span className="text-[10px] font-black text-gray-500 dark:text-zinc-400 uppercase tracking-widest">Sistema Operativo para Venezuela</span>
                        </motion.div>
                        <motion.h1 
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: 0.1 }}
                            className="text-5xl md:text-7xl font-black tracking-tighter mb-6 leading-[0.9] text-gray-900 dark:text-white transition-colors duration-300"
                        >
                            Vende en Dólares.<br/>
                            <span className="bg-clip-text text-transparent bg-gradient-to-r from-black to-[#2a6544] dark:from-white dark:to-zinc-500">Cobra en Bs.</span><br/>
                            <span className="bg-clip-text text-transparent bg-gradient-to-r from-[#2a6544] to-black dark:from-white dark:to-zinc-500">Automático.</span>
                        </motion.h1>
                        <motion.p 
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: 0.2 }}
                            className="text-xl text-gray-500 dark:text-zinc-400 mb-6 leading-relaxed font-medium max-w-xl"
                        >
                            Olvídate de calcular la tasa cada mañana. Preziso actualiza tus precios con el BCV, organiza tus pedidos de WhatsApp y protege tu margen.
                        </motion.p>
                        <motion.div
                             initial={{ opacity: 0, y: 20 }}
                             animate={{ opacity: 1, y: 0 }}
                             transition={{ delay: 0.3 }}
                             className="w-full flex justify-center lg:justify-start"
                        >
                            <WaitlistForm />
                        </motion.div>
                        <p className="mt-4 text-[10px] text-gray-400 dark:text-zinc-600 font-bold uppercase tracking-widest">
                            * Cupos limitados para garantizar estabilidad
                        </p>
                    </div>
                    <div className="lg:col-span-5 relative flex justify-center lg:justify-end">
                        <InteractiveDemo />
                    </div>
                </div>
            </section>
            {/* SECCIÓN VARIANTES - bg-transparent */}
            <VariantShowcase />
            {/* FEATURES GRID - bg-transparent */}
            <section id="features" className="py-24 bg-transparent border-t border-gray-200/50 dark:border-zinc-800/50 transition-colors duration-300">
                <div className="max-w-7xl mx-auto px-6">
                    <div className="text-center mb-16">
                        <h2 className="text-4xl font-black mb-4 dark:text-white">El fin del caos manual.</h2>
                        <p className="text-gray-500 dark:text-zinc-400 text-lg">Reemplazamos tu Excel y tu calculadora.</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 auto-rows-[minmax(200px,auto)]">
                        {/* Card BCV */}
                        <div className="md:col-span-2 bg-white/70 dark:bg-zinc-900/70 backdrop-blur-md rounded-[2.5rem] p-10 border border-gray-100 dark:border-zinc-800 shadow-lg relative overflow-hidden group transition-colors duration-300 hover:bg-white/80 dark:hover:bg-zinc-900/80">
                            <div className="absolute -right-10 -top-10 opacity-5 dark:opacity-[0.02] group-hover:scale-110 transition-transform duration-500">
                                <RefreshCw size={200} />
                            </div>
                            <div className="w-14 h-14 bg-green-50 dark:bg-green-900/20 rounded-2xl flex items-center justify-center mb-6 text-green-600 dark:text-green-400">
                                <TrendingUp size={28} />
                            </div>
                            <h3 className="text-2xl font-black mb-3 dark:text-white">Sincronización BCV Automática</h3>
                            <p className="text-gray-500 dark:text-zinc-400 font-medium max-w-md">
                                Si el dólar sube a las 9:00 AM, tus precios en Bs suben a las 9:01 AM. 
                                Protección total contra la devaluación sin mover un dedo.
                            </p>
                        </div>
                        {/* Card CRM */}
                        <div className="md:row-span-2 bg-[#0A0A0A] dark:bg-black text-white rounded-[2.5rem] p-10 relative overflow-hidden flex flex-col justify-between group shadow-2xl border border-transparent dark:border-zinc-800">
                             <div className="absolute top-0 right-0 w-full h-full bg-gradient-to-b from-green-500/10 to-transparent pointer-events-none"></div>
                             <div>
                                <div className="w-14 h-14 bg-white/10 rounded-2xl flex items-center justify-center mb-6 text-white border border-white/10">
                                    <Layers size={28} />
                                </div>
                                <h3 className="text-2xl font-black mb-3">CRM de Pedidos</h3>
                                <p className="text-gray-400 text-sm font-medium mb-8">
                                    De "Pendiente" a "Pagado" con un clic. Organiza tus ventas de WhatsApp en un tablero Kanban.
                                </p>
                             </div>
                             {/* Mini UI */}
                             <div className="space-y-2 font-mono text-[10px] opacity-80">
                                <div className="flex justify-between border-b border-white/10 pb-2">
                                    <span>#1044 Angel</span> <span className="text-green-400">PAGADO</span>
                                </div>
                                <div className="flex justify-between border-b border-white/10 pb-2">
                                    <span>#1045 Maria</span> <span className="text-yellow-400">PENDIENTE</span>
                                </div>
                             </div>
                        </div>
                        {/* Card Web */}
                        <div className="bg-white/70 dark:bg-zinc-900/70 backdrop-blur-md rounded-[2.5rem] p-10 border border-gray-100 dark:border-zinc-800 shadow-lg group hover:-translate-y-1 transition-all duration-300">
                             <div className="w-14 h-14 bg-blue-50 dark:bg-blue-900/20 rounded-2xl flex items-center justify-center mb-6 text-blue-600 dark:text-blue-400">
                                <Globe size={28} />
                            </div>
                            <h3 className="text-xl font-black mb-2 dark:text-white">Tu Web .app</h3>
                            <p className="text-gray-500 dark:text-zinc-400 text-sm font-medium">
                                Tu tienda en <code>preziso.app/tu-marca</code>. Carga instantánea en 4G.
                            </p>
                        </div>
                         {/* Card WhatsApp */}
                         <div className="bg-white/70 dark:bg-zinc-900/70 backdrop-blur-md rounded-[2.5rem] p-10 border border-gray-100 dark:border-zinc-800 shadow-lg group hover:-translate-y-1 transition-all duration-300">
                             <div className="w-14 h-14 bg-purple-50 dark:bg-purple-900/20 rounded-2xl flex items-center justify-center mb-6 text-purple-600 dark:text-purple-400">
                                <MessageCircle size={28} />
                            </div>
                            <h3 className="text-xl font-black mb-2 dark:text-white">Pedidos a WhatsApp</h3>
                            <p className="text-gray-500 dark:text-zinc-400 text-sm font-medium">
                                El cliente arma el carrito y te llega un mensaje listo con el total y los datos.
                            </p>
                        </div>
                    </div>
                </div>
            </section>
            {/* TESTIMONIOS - bg-transparent */}
            <Testimonials />
            {/* FAQ - bg-transparent */}
            <FAQ />
            {/* CTA FINAL - bg-transparent */}
            <section id="pricing" className="py-32 bg-transparent relative overflow-hidden transition-colors duration-300">
                <div className="max-w-4xl mx-auto px-6 text-center relative z-10 flex flex-col items-center">
                    <h2 className="text-5xl md:text-7xl font-black tracking-tighter mb-8 dark:text-white">
                        Únete al club.
                    </h2>
                    <p className="text-gray-500 dark:text-zinc-400 text-xl mb-12 max-w-lg">
                        Estamos abriendo cupos gradualmente. Regístrate ahora para asegurar tu precio de lanzamiento.
                    </p>
                    <div className="w-full flex justify-center">
                        <WaitlistForm />
                    </div>
                </div>
            </section>
            {/* FOOTER - bg-transparent */}
                <footer className="py-12 bg-transparent border-t border-gray-200/50 dark:border-zinc-900 text-center transition-colors duration-300">
     <div className="flex items-center justify-center gap-2 mb-6 opacity-60 hover:opacity-100 transition-opacity">
        {/* Logo Light Footer */}
        <img src="/pezisologo.png" alt="Preziso" className="h-15 block dark:hidden mix-blend-multiply grayscale" />
        {/* Logo Dark Footer */}
        <img src="/pezisologow.png" alt="Preziso" className="h-15 hidden dark:block" />
     </div>
                 <p className="text-gray-400 dark:text-zinc-600 text-xs font-bold uppercase tracking-widest mb-4">
                     Hecho en Venezuela 🇻🇪
                 </p>
                 <p className="text-gray-300 dark:text-zinc-700 text-xs">
                     © {new Date().getFullYear()} Preziso Inc.
                 </p>
            </footer>
        </div>
    )
}
</file>

<file path="components/StoreInterface.tsx">
'use client'
import { useState, useMemo, useEffect } from 'react'
import { Search, ShoppingBag, X, Tag, Info, Plus, ArrowUpRight } from 'lucide-react'
import ProductModal from './ProductModal' 
import FloatingCheckout from './FloatingCheckout'
import NumberTicker from './NumberTicker'
// --- COMPONENTES UI ---
const CategoryPill = ({ label, active, onClick }: { label: string, active: boolean, onClick: () => void }) => (
  <button 
    onClick={onClick} 
    className={`px-5 py-2 md:px-6 md:py-2.5 rounded-full text-[11px] md:text-xs font-medium tracking-wide transition-all duration-300 border active:scale-95 ${
      active 
        ? 'bg-black text-white border-black shadow-md' 
        : 'bg-white text-gray-500 border-transparent hover:bg-gray-50 hover:text-gray-900'
    }`}
  >
    {label}
  </button>
)
interface Props { store: any; products: any[]; rates: any; }
export default function StoreInterface({ store, products, rates }: Props) {
  // Skeleton de carga minimalista
  if (!store) return (
    <div className="min-h-screen bg-white flex flex-col items-center justify-center gap-4">
        <div className="w-8 h-8 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
        <p className="text-xs font-medium tracking-widest uppercase text-gray-400">Cargando Boutique...</p>
    </div>
  )
  // --- CONFIGURACIÓN & ESTADO ---
  const isEur = store.currency_type === 'eur'
  const activeRate = isEur ? Number(rates?.eur_rate || 0) : Number(rates?.usd_rate || 0)
  const [search, setSearch] = useState('')
  const [selectedCategory, setSelectedCategory] = useState('Todos')
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [selectedProductForModal, setSelectedProductForModal] = useState<any>(null)
  const [isVisible, setIsVisible] = useState(true)
  const [lastScrollY, setLastScrollY] = useState(0)
  // --- LOGICA DE SCROLL ---
  useEffect(() => {
    const controlNavbar = () => {
      if (typeof window !== 'undefined') {
        const currentScrollY = window.scrollY
        if (currentScrollY < 80) { setIsVisible(true); setLastScrollY(currentScrollY); return }
        setIsVisible(currentScrollY <= lastScrollY)
        setLastScrollY(currentScrollY)
      }
    }
    window.addEventListener('scroll', controlNavbar, { passive: true })
    return () => window.removeEventListener('scroll', controlNavbar)
  }, [lastScrollY])
  // --- FILTROS ---
  const normalizeCategory = (cat: string) => {
    if (!cat) return "";
    const trimmed = cat.trim().toLowerCase();
    return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
  };
  const categories = useMemo(() => {
    const cats = products.map(p => normalizeCategory(p.category)).filter(Boolean)
    return ['Todos', ...Array.from(new Set(cats))]
  }, [products])
  const filteredProducts = useMemo(() => {
    return products.filter(p => {
      const matchesSearch = p.name.toLowerCase().includes(search.toLowerCase())
      const productCatClean = normalizeCategory(p.category);
      const matchesCategory = selectedCategory === 'Todos' || productCatClean === selectedCategory
      return matchesSearch && matchesCategory
    })
  }, [products, search, selectedCategory])
  const handleOpenProduct = (product: any) => {
    setSelectedProductForModal(product)
    setIsModalOpen(true)
  }
  // --- ENGINE DE PRECIOS ---
  const getProductPricing = (product: any) => {
    const cashPrice = Number(product.usd_cash_price || 0)
    const markup = Number(product.usd_penalty || 0)
    const listPrice = cashPrice + markup
    const priceInBs = listPrice * activeRate
    const discountPercent = listPrice > 0 ? Math.round((markup / listPrice) * 100) : 0
    return {
        cashPrice,
        priceInBs,
        discountPercent,
        hasDiscount: markup > 0
    }
  }
  return (
    <div className="min-h-screen bg-white pb-32 font-sans selection:bg-black selection:text-white">
      {/* --- HEADER FLOTANTE --- */}
      <header 
        className={`sticky top-0 z-40 bg-white/85 backdrop-blur-xl border-b border-gray-100/50 transition-transform duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] will-change-transform ${
          isVisible ? 'translate-y-0' : '-translate-y-full'
        }`}
      >
        <div className="max-w-6xl mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between">
          {/* Brand */}
          <div className="flex items-center gap-3 md:gap-4 group cursor-pointer" onClick={() => window.location.reload()}>
            <div className="relative shrink-0">
                {store.logo_url ? (
                  <img src={store.logo_url} className="w-9 h-9 md:w-10 md:h-10 object-contain rounded-full border border-gray-100 bg-gray-50" alt="Logo"/>
                ) : (
                  <div className="w-9 h-9 md:w-10 md:h-10 bg-black rounded-full flex items-center justify-center text-white">
                    <ShoppingBag size={16} strokeWidth={1.5} />
                  </div>
                )}
            </div>
            <div className="flex flex-col">
              <h1 className="text-base md:text-lg font-bold tracking-tight text-gray-900 leading-none truncate max-w-[140px] md:max-w-none">
                {store.name}
              </h1>
              <span className="text-[9px] md:text-[10px] uppercase font-bold tracking-[0.15em] text-gray-400 mt-0.5 md:mt-0.5">
                Official Store
              </span>
            </div>
          </div>
          {/* Ticker Tasa */}
          <div className="flex items-center gap-2 pl-3 pr-4 py-1.5 bg-gray-50/80 rounded-full border border-gray-200/60 shadow-sm">
            <div className="flex items-center gap-1.5">
               <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
               <span className="text-[9px] md:text-[10px] font-bold text-gray-400 uppercase tracking-wide hidden md:inline">
                 {isEur ? 'Tasa EUR' : 'Tasa BCV'}
               </span>
               <span className="text-[9px] font-bold text-gray-400 uppercase tracking-wide md:hidden">
                 {isEur ? 'EUR' : 'BCV'}
               </span>
            </div>
            <div className="h-3 w-[1px] bg-gray-300"></div>
            <span className="font-mono text-xs font-semibold text-gray-900 tracking-tight">
               <NumberTicker value={activeRate} />
            </span>
          </div>
        </div>
        {/* Search & Categories */}
        <div className="max-w-6xl mx-auto px-4 pb-3 md:pb-4">
           <div className="flex flex-col md:flex-row gap-3 md:gap-4 items-center">
                <div className="relative flex-1 w-full md:w-auto group">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-black transition-colors" size={16} strokeWidth={2} />
                    <input 
                      type="text" 
                      placeholder="Buscar..." 
                      value={search} 
                      onChange={(e) => setSearch(e.target.value)} 
                      className="w-full bg-gray-100/50 hover:bg-gray-100 focus:bg-white border-0 rounded-2xl pl-11 pr-4 py-2.5 text-sm font-medium placeholder:text-gray-400 outline-none ring-1 ring-transparent focus:ring-gray-200 transition-all appearance-none"
                    />
                    {search && (
                      <button onClick={() => setSearch("")} className="absolute right-3 top-1/2 -translate-y-1/2 p-1 hover:bg-gray-200 rounded-full transition-colors">
                        <X size={14} className="text-gray-500" />
                      </button>
                    )}
                </div>
                <div 
                  className="w-full md:w-auto flex gap-2 overflow-x-auto pb-1 [&::-webkit-scrollbar]:hidden"
                  style={{ 
                    scrollbarWidth: 'none', 
                    msOverflowStyle: 'none',
                    maskImage: 'linear-gradient(to right, black 90%, transparent 100%)',
                    WebkitMaskImage: 'linear-gradient(to right, black 90%, transparent 100%)'
                  }}
                >
                    {categories.map(cat => (
                      <CategoryPill key={cat} label={cat} active={selectedCategory === cat} onClick={() => setSelectedCategory(cat)} />
                    ))}
                </div>
           </div>
        </div>
      </header>
      {/* --- GRID DE PRODUCTOS --- */}
      <main className="max-w-6xl mx-auto px-4 pt-6 md:pt-10 pb-24">
        <div className="flex justify-between items-end mb-6 px-1 border-b border-gray-100 pb-2">
          <h2 className="text-lg md:text-xl font-bold text-gray-900 tracking-tight">Catálogo</h2>
          <span className="text-[10px] md:text-xs font-medium text-gray-400 tabular-nums">
            {filteredProducts.length} Items
          </span>
        </div>
        {filteredProducts.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-24 border border-dashed border-gray-200 rounded-2xl bg-gray-50/50">
            <Search className="text-gray-300 mb-4" size={32} strokeWidth={1.5} />
            <p className="font-medium text-gray-900 text-sm">Sin resultados</p>
          </div>
        ) : (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-3 gap-y-8 md:gap-x-8 md:gap-y-12">
             {filteredProducts.map(product => {
                const pricing = getProductPricing(product)
                return (
                  <div 
                    key={product.id} 
                    className="group cursor-pointer flex flex-col gap-3 relative active:scale-[0.98] transition-transform duration-200 md:active:scale-100"
                    onClick={() => handleOpenProduct(product)}
                  >
                      {/* Imagen Container */}
                      <div className="relative aspect-[4/5] md:aspect-square w-full bg-gray-50 rounded-[4px] overflow-hidden">
                        {product.image_url ? (
                          <img 
                            src={product.image_url} 
                            alt={product.name}
                            loading="lazy"
                            className="h-full w-full object-cover md:object-contain p-0 md:p-4 mix-blend-multiply transition-transform duration-700 ease-out md:group-hover:scale-105 will-change-transform"
                          />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center bg-gray-100 text-gray-300">
                            <ShoppingBag size={24} strokeWidth={1} />
                          </div>
                        )}
                        {/* Badges */}
                        <div className="absolute top-2 left-2 flex flex-col gap-1 items-start z-10">
                            {pricing.hasDiscount && (
                                <span className="bg-black/90 backdrop-blur-md text-white text-[8px] md:text-[9px] font-bold uppercase tracking-wider px-1.5 py-0.5 md:px-2 md:py-1 rounded-sm shadow-sm">
                                    -{pricing.discountPercent}% OFF
                                </span>
                            )}
                            {product.stock <= 0 && (
                                <span className="bg-gray-200/90 backdrop-blur-md text-gray-500 text-[8px] md:text-[9px] font-bold uppercase tracking-wider px-1.5 py-0.5 md:px-2 md:py-1 rounded-sm">
                                    Agotado
                                </span>
                            )}
                        </div>
                        {/* BOTÓN ACCIÓN RÁPIDA */}
                        <div 
                          className="absolute bottom-2 right-2 z-20 
                                     opacity-100 translate-y-0 
                                     md:bottom-3 md:right-3 md:opacity-0 md:translate-y-4 md:group-hover:translate-y-0 md:group-hover:opacity-100 
                                     transition-all duration-300 ease-out"
                        >
                            <button 
                              className="bg-white text-black p-2 md:p-2.5 rounded-full shadow-sm hover:bg-black hover:text-white transition-colors border border-gray-100 active:scale-90"
                              onClick={(e) => {
                                e.stopPropagation(); 
                                handleOpenProduct(product);
                              }}
                            >
                                <Plus className="w-4 h-4 md:w-[18px] md:h-[18px]" strokeWidth={2} />
                            </button>
                        </div>
                      </div>
                      {/* Info del Producto */}
                      <div className="flex flex-col gap-0.5 md:gap-1 px-0.5">
                        <div className="flex justify-between items-start gap-2">
                            <h3 className="text-[13px] md:text-sm font-medium text-gray-900 tracking-tight leading-snug md:group-hover:text-gray-600 transition-colors line-clamp-2">
                              {product.name}
                            </h3>
                        </div>
                        <div className="flex flex-wrap items-baseline gap-x-2 gap-y-0 mt-1">
                           <span className="text-[15px] md:text-base font-bold text-gray-900 tracking-tight">
                             ${pricing.cashPrice.toFixed(2)}
                           </span>
                           <span className="text-[10px] md:text-xs text-gray-400 font-medium whitespace-nowrap">
                              Bs {new Intl.NumberFormat('es-VE', { maximumFractionDigits: 2 }).format(pricing.priceInBs)}
                           </span>
                        </div>
                        {pricing.hasDiscount && (
                            <span className="text-[9px] md:text-[10px] font-medium text-emerald-600 mt-0.5">
                                Precio efectivo divisa
                            </span>
                        )}
                      </div>
                  </div>
                )
             })}
          </div>
        )}
      </main>
      {/* --- FLOATING COMPONENTS --- */}
      <FloatingCheckout 
        rates={{ usd: Number(rates?.usd_rate || 0), eur: Number(rates?.eur_rate || 0) }} 
        currency={isEur ? 'eur' : 'usd'} 
        phone={store.phone || '584120000000'}
        storeName={store.name}
        storeId={store.id}       
        storeConfig={store}    
      />
      <ProductModal 
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        product={selectedProductForModal}
        currency={isEur ? 'eur' : 'usd'} 
        rates={{ usd: Number(rates?.usd_rate || 0), eur: Number(rates?.eur_rate || 0) }} 
      />
    </div>
  )
}
</file>

<file path="app/globals.css">
@import "tailwindcss";
/* --- ESTA LÍNEA HACE FUNCIONAR EL MODO OSCURO CON EL BOTÓN --- */
@custom-variant dark (&:where(.dark, .dark *));
@layer base {
   textarea, select {
    @apply bg-gray-50/50 border-0 ring-1 ring-gray-200 transition-all duration-300;
    color: #0a0a0a;
  }
  input:focus, textarea:focus, select:focus {
    @apply ring-black ring-offset-0 border-[1.2px] border-[rgba(0,0,0,0.55)] bg-white shadow-lg;
    outline: none;
  }
  input::placeholder { color: #a1a1aa; }
}
:root {
  /* INDUSTRIAL PALETTE */
  --background: #ffffff;
  --foreground: #09090b;
  --card-bg: #ffffff;
  --border-subtle: #e4e4e7;
}
/* FIX AUTOCOMPLETADO */
input:-webkit-autofill,
input:-webkit-autofill:hover, 
input:-webkit-autofill:focus, 
input:-webkit-autofill:active {
    /* Color del texto (Negro/Oscuro) */
    -webkit-text-fill-color: #0C0A09 !important;
    /* Fondo Blanco: Se logra con una sombra interna (inset) de color #ffffff */
    -webkit-box-shadow: 0 0 0 1000px #ffffff inset !important;
    box-shadow: 0 0 0 1000px #ffffff inset !important;
    /* Mantiene el fondo blanco evitando que el navegador lo cambie */
    transition: background-color 5000s ease-in-out 0s;
}
@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --font-serif: var(--font-serif); 
}
body {
  background: var(--background);
  color: var(--foreground);
  font-family: var(--font-sans), Arial, sans-serif;
  -webkit-font-smoothing: antialiased; 
}
</file>

<file path="package.json">
{
  "name": "preziso",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "context": "npx repomix --style xml --remove-empty-lines --ignore \"**/*.spec.ts,**/ui/**,public/**,node_modules/**,.git/**,estructura.txt\""
  },
  "dependencies": {
    "@supabase/auth-helpers-nextjs": "^0.15.0",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.89.0",
    "autoprefixer": "^10.4.24",
    "clsx": "^2.1.1",
    "framer-motion": "^12.28.1",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "papaparse": "^5.5.3",
    "postcss": "^8.5.6",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "sweetalert2": "^11.26.17",
    "tailwind-merge": "^3.4.1",
    "zod": "^4.3.6",
    "zustand": "^5.0.9"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@types/node": "^20.19.27",
    "@types/papaparse": "^5.5.2",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "tailwindcss": "^4.1.18",
    "typescript": "^5"
  }
}
</file>

<file path="components/FloatingCheckout.tsx">
'use client'
import { useState, useMemo } from 'react'
import { 
  ShoppingCart, 
  X, 
  Trash2, 
  ArrowRight, 
  MessageCircle, 
  Loader2, 
  Check, 
  CreditCard, 
  Copy, 
  AlertCircle, 
  ShoppingBag, 
  Truck,
  ChevronRight,
  Minus,
  Plus
} from 'lucide-react'
import { useCart } from '@/app/store/useCart'
import { getSupabase } from '@/lib/supabase-client'
import Swal from 'sweetalert2'
interface CheckoutProps {
  rates: { usd: number, eur: number }
  currency: 'usd' | 'eur'
  phone: string
  storeName: string
  storeId: string 
  storeConfig: any 
}
export default function FloatingCheckout({ rates, currency, phone, storeName, storeId, storeConfig }: CheckoutProps) {
  const { items, removeItem, clearCart, updateQuantity } = useCart()
  const [isOpen, setIsOpen] = useState(false)
  const [step, setStep] = useState(1) 
  const [loading, setLoading] = useState(false)
  const [copied, setCopied] = useState(false)
  // 1. CONFIGURACIÓN
  const isEurMode = currency === 'eur'
  const activeRate = isEurMode ? rates.eur : rates.usd
  const currencySymbol = '$' 
  const payments = storeConfig?.payment_config || {}
  const shipping = storeConfig?.shipping_config || {}
  const paymentKeysMap: { [key: string]: string } = { 'Pago Móvil': 'pago_movil', 'Zelle': 'zelle', 'Binance': 'binance', 'Zinli': 'zinli', 'Efectivo': 'cash' }
  const hardCurrencyMethods = ['Zelle', 'Binance', 'Zinli', 'Efectivo']
  const activePaymentMethods = useMemo(() => {
      const active = []
      if (payments.pago_movil?.active) active.push('Pago Móvil')
      if (payments.zelle?.active) active.push('Zelle')
      if (payments.binance?.active) active.push('Binance')
      if (payments.zinli?.active) active.push('Zinli')
      if (payments.cash?.active) active.push('Efectivo')
      return active
  }, [payments])
  const activeCouriers = useMemo(() => {
      const active = []
      if (shipping.mrw?.active) active.push('MRW')
      if (shipping.zoom?.active) active.push('Zoom')
      if (shipping.tealca?.active) active.push('Tealca')
      return active
  }, [shipping])
  const [clientData, setClientData] = useState({ name: '', paymentMethod: '', deliveryType: 'pickup', courier: '', address: '', identityCard: '', phone: '', notes: '' })
  // --- CÁLCULOS MATEMÁTICOS ---
  const totalBaseNominal = useMemo(() => items.reduce((acc, item) => acc + (item.basePrice * item.quantity), 0), [items])
  const totalPenaltyNominal = useMemo(() => items.reduce((acc, item) => acc + ((item.penalty || 0) * item.quantity), 0), [items])
  const finalTotalBs = (totalBaseNominal + totalPenaltyNominal) * activeRate
  const isHardCurrencyPayment = clientData.paymentMethod && hardCurrencyMethods.includes(clientData.paymentMethod)
  const displayTotalDivisa = totalBaseNominal
  const displayTotalSavings = totalPenaltyNominal
  // --- UI ALERTAS (Clean Look) ---
  const getAlert = () => {
      if (!clientData.paymentMethod) return null
      if (isHardCurrencyPayment) {
          if (totalPenaltyNominal > 0) {
              return (
                  <div className="bg-emerald-50/80 border border-emerald-100/50 rounded-xl p-3 flex items-start gap-3 animate-in fade-in slide-in-from-top-1">
                      <div className="bg-emerald-100 text-emerald-600 p-1.5 rounded-full shrink-0"><Check size={12} strokeWidth={3}/></div>
                      <div>
                          <p className="text-[10px] font-bold text-emerald-700 uppercase tracking-wider mb-0.5">Descuento Aplicado</p>
                          <p className="text-xs text-emerald-600/90 font-medium leading-relaxed">
                            Ahorras <span className="font-bold text-emerald-700">{currencySymbol}{displayTotalSavings.toFixed(2)}</span> por pagar en divisa.
                          </p>
                      </div>
                  </div>
              )
          }
      } else {
          if (totalPenaltyNominal > 0) {
              return (
                  <div className="bg-orange-50/80 border border-orange-100/50 rounded-xl p-3 flex items-start gap-3 animate-in fade-in slide-in-from-top-1">
                      <div className="bg-orange-100 text-orange-600 p-1.5 rounded-full shrink-0"><AlertCircle size={12} strokeWidth={3}/></div>
                      <div>
                          <p className="text-[10px] font-bold text-orange-700 uppercase tracking-wider mb-0.5">Sugerencia de Ahorro</p>
                          <p className="text-xs text-orange-600/90 font-medium leading-relaxed">
                              Paga en Efectivo o Zelle y ahorra <span className="font-bold border-b border-orange-200 border-dashed">{currencySymbol}{displayTotalSavings.toFixed(2)}</span> en tu compra.
                          </p>
                      </div>
                  </div>
              )
          }
      }
      return null
  }
  const handleCopy = (text: string) => {
    navigator.clipboard.writeText(text)
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
  }
  const getSelectedPaymentDetails = () => {
      if (!clientData.paymentMethod) return null
      const key = paymentKeysMap[clientData.paymentMethod]
      // @ts-ignore
      return payments[key]?.details || ''
  }
  const [supabase] = useState(() => getSupabase())
  const handleCheckout = async () => {
    if (!clientData.name) return Swal.fire({ title: 'Falta Nombre', text: 'Indícanos tu nombre', icon: 'warning', confirmButtonColor: '#000' })
    if (!clientData.paymentMethod) return Swal.fire({ title: 'Método de Pago', text: 'Selecciona cómo deseas pagar', icon: 'warning', confirmButtonColor: '#000' })
    if (clientData.deliveryType === 'courier' && (!clientData.courier || !clientData.identityCard || !clientData.phone || !clientData.address)) return Swal.fire({ title: 'Datos de Envío', text: 'Completa la información de envío', icon: 'warning', confirmButtonColor: '#000' })
    setLoading(true)
    try {
        const deliveryInfoFull = clientData.deliveryType === 'pickup' ? 'Retiro Personal' : `${clientData.courier} - ${clientData.address} | CI: ${clientData.identityCard} | Tlf: ${clientData.phone}`
        const { data: order, error: orderError } = await supabase
            .from('orders')
            .insert({
                store_id: storeId,
                customer_name: clientData.name,
                customer_phone: clientData.phone,
                total_usd: isHardCurrencyPayment ? totalBaseNominal : (totalBaseNominal + totalPenaltyNominal), 
                total_bs: finalTotalBs, 
                exchange_rate: activeRate,
                currency_type: currency, 
                status: 'pending',
                payment_method: clientData.paymentMethod,
                shipping_method: clientData.deliveryType === 'pickup' ? 'pickup' : clientData.courier,
                delivery_info: deliveryInfoFull
            })
            .select()
            .single()
        if (orderError) throw orderError
        const orderItems = items.map(item => ({
            order_id: order.id,
            product_id: item.productId,
            product_name: item.name,
            variant_info: item.variantInfo || 'N/A',
            quantity: item.quantity,
            price_at_purchase: item.basePrice, 
            variant_id: (item.variantId && item.variantId.length === 36) ? item.variantId : null 
        }))
        await supabase.from('order_items').insert(orderItems)
        let message = `*PEDIDO #${order.order_number}* 🛍️\n`
        message += `Cliente: *${clientData.name}*\n`
        message += `────────────────\n`
        items.forEach(item => { message += `▪️ ${item.quantity}x ${item.name} ${item.variantInfo ? `(${item.variantInfo})` : ''}\n` })
        if (isHardCurrencyPayment) {
            message += `────────────────\n*TOTAL: ${currencySymbol}${totalBaseNominal.toFixed(2)}*\n`
        } else {
            message += `────────────────\n*TOTAL BS: ${finalTotalBs.toLocaleString('es-VE', { maximumFractionDigits: 2 })}*\n`
            message += `_Ref: ${currencySymbol}${(totalBaseNominal + totalPenaltyNominal).toFixed(2)}_\n`
        }
        message += `\n📦 *ENTREGA:* ${clientData.deliveryType === 'pickup' ? 'Retiro' : clientData.courier}\n`
        if (clientData.deliveryType === 'courier') message += `📍 ${clientData.address}\n🆔 CI ${clientData.identityCard}\n`
        message += `💳 *PAGO:* ${clientData.paymentMethod}\n`
        if (clientData.notes) message += `📝 Nota: ${clientData.notes}\n`
        clearCart()
        setIsOpen(false)
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank')
    } catch (error: any) {
        Swal.fire('Error', error.message, 'error')
    } finally {
        setLoading(false)
    }
  }
  if (items.length === 0 && !isOpen) return null
  return (
    <>
        {/* --- BOTÓN FLOTANTE "ISLA" --- */}
        {!isOpen && items.length > 0 && (
            <div className="fixed bottom-6 left-0 right-0 px-4 z-50 flex justify-center animate-in slide-in-from-bottom-10 fade-in duration-500">
                <button 
                    onClick={() => setIsOpen(true)} 
                    className="bg-black/90 backdrop-blur-md text-white pl-4 pr-5 py-3 rounded-full shadow-2xl shadow-black/20 flex items-center gap-4 hover:scale-[1.02] active:scale-[0.98] transition-all border border-white/10 group w-full max-w-sm justify-between"
                >
                    <div className="flex items-center gap-3">
                        <div className="relative bg-white/10 p-2 rounded-full">
                            <ShoppingCart size={20} className="pointer-events-none" strokeWidth={2} />
                            <span className="absolute -top-1 -right-1 bg-white text-black text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full shadow-sm pointer-events-none">
                                {items.reduce((acc, i) => acc + i.quantity, 0)}
                            </span>
                        </div>
                        <div className="flex flex-col items-start">
                            <span className="text-[10px] font-medium text-white/60 uppercase tracking-widest leading-none mb-0.5">Total</span>
                            <span className="text-base font-bold tracking-tight">{currencySymbol}{totalBaseNominal.toFixed(2)}</span>
                        </div>
                    </div>
                    <div className="flex items-center gap-2 pl-4 border-l border-white/10">
                        <span className="text-xs font-semibold tracking-wide">Pagar</span>
                        <ArrowRight size={14} className="group-hover:translate-x-1 transition-transform pointer-events-none"/>
                    </div>
                </button>
            </div>
        )}
        {/* --- MODAL FULLSCREEN / DRAWER --- */}
        {isOpen && (
            <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center">
                <div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={() => setIsOpen(false)}></div>
                <div className="relative bg-white w-full md:max-w-md h-[92vh] md:h-[85vh] rounded-t-[32px] md:rounded-[32px] shadow-2xl flex flex-col overflow-hidden animate-in slide-in-from-bottom-16 duration-300 ease-out">
                    {/* Header */}
                    <div className="bg-white px-6 pt-6 pb-4 flex justify-between items-center shrink-0 border-b border-gray-50">
                        <div>
                            <h2 className="text-xl font-bold text-gray-900 tracking-tight">{step === 1 ? 'Tu Bolsa' : 'Checkout'}</h2>
                            <p className="text-xs text-gray-400 font-medium">{step === 1 ? 'Revisa tus items' : 'Completa tus datos'}</p>
                        </div>
                        <button onClick={() => setIsOpen(false)} className="p-2 bg-gray-50 hover:bg-gray-100 rounded-full transition-colors text-gray-500"><X size={20}/></button>
                    </div>
                    {/* Scrollable Body */}
                    <div className="flex-1 overflow-y-auto p-6 scroll-smooth">
                        {step === 1 ? (
                            <div className="space-y-6">
                                {items.map((item) => {
                                    const itemTotalNominal = item.basePrice * item.quantity
                                    return (
                                        <div key={item.id} className="flex gap-4 group">
                                            <div className="w-20 h-20 bg-gray-50 rounded-xl overflow-hidden shrink-0 border border-gray-100 relative">
                                                <img src={item.image} className="w-full h-full object-cover mix-blend-multiply" />
                                                {item.penalty > 0 && <div className="absolute bottom-0 inset-x-0 h-1 bg-emerald-500"></div>}
                                            </div>
                                            <div className="flex-1 flex flex-col justify-between py-0.5">
                                                <div>
                                                    <div className="flex justify-between items-start">
                                                        <h3 className="font-semibold text-sm text-gray-900 line-clamp-2 leading-snug">{item.name}</h3>
                                                        <button onClick={() => removeItem(item.id)} className="text-gray-300 hover:text-red-500 p-1 -mr-2"><Trash2 size={16}/></button>
                                                    </div>
                                                    <p className="text-[11px] text-gray-500 mt-0.5">{item.variantInfo || 'Estándar'}</p>
                                                </div>
                                                <div className="flex items-end justify-between mt-2">
                                                    <span className="font-bold text-sm text-gray-900">{currencySymbol}{itemTotalNominal.toFixed(2)}</span>
                                                    <div className="flex items-center bg-gray-50 rounded-lg p-1 gap-3 border border-gray-100">
                                                        <button onClick={() => updateQuantity(item.id, item.quantity - 1)} className="w-6 h-6 flex items-center justify-center bg-white rounded-md shadow-sm border border-gray-100 text-gray-500 hover:text-black disabled:opacity-50" disabled={item.quantity <= 1}><Minus size={12}/></button>
                                                        <span className="text-xs font-semibold w-3 text-center">{item.quantity}</span>
                                                        <button onClick={() => updateQuantity(item.id, item.quantity + 1)} className="w-6 h-6 flex items-center justify-center bg-black text-white rounded-md shadow-sm hover:bg-gray-800"><Plus size={12}/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        ) : (
                            <div className="space-y-8 animate-in fade-in slide-in-from-right-8 duration-300">
                                {/* PASO 1: Contacto */}
                                <div className="space-y-4">
                                    <div className="flex items-center gap-2 text-xs font-bold text-gray-900 uppercase tracking-widest">
                                        <span className="w-5 h-5 rounded-full bg-black text-white flex items-center justify-center text-[10px]">1</span>
                                        Contacto
                                    </div>
                                    <input 
                                        value={clientData.name} 
                                        onChange={e => setClientData({...clientData, name: e.target.value})} 
                                        className="w-full bg-gray-50/50 border border-gray-200 rounded-xl px-4 py-3.5 text-sm font-medium text-gray-900 placeholder:text-gray-400 focus:border-black focus:bg-white focus:ring-0 transition-all outline-none" 
                                        placeholder="Nombre completo" 
                                        autoFocus
                                    />
                                </div>
                                {/* PASO 2: Entrega */}
                                <div className="space-y-4">
                                    <div className="flex items-center gap-2 text-xs font-bold text-gray-900 uppercase tracking-widest">
                                        <span className="w-5 h-5 rounded-full bg-black text-white flex items-center justify-center text-[10px]">2</span>
                                        Método de Entrega
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => setClientData({...clientData, deliveryType: 'pickup'})} className={`p-4 rounded-xl border text-sm font-medium flex flex-col items-center justify-center gap-2 transition-all duration-300 ${clientData.deliveryType==='pickup' ? 'border-black bg-black text-white shadow-lg':'border-gray-100 bg-white text-gray-500 hover:border-gray-200 hover:bg-gray-50'}`}>
                                            <ShoppingBag size={20} strokeWidth={1.5} className="pointer-events-none"/> 
                                            <span>Retiro</span>
                                        </button>
                                        <button onClick={() => setClientData({...clientData, deliveryType: 'courier'})} className={`p-4 rounded-xl border text-sm font-medium flex flex-col items-center justify-center gap-2 transition-all duration-300 ${clientData.deliveryType==='courier' ? 'border-black bg-black text-white shadow-lg':'border-gray-100 bg-white text-gray-500 hover:border-gray-200 hover:bg-gray-50'}`}>
                                            <Truck size={20} strokeWidth={1.5} className="pointer-events-none"/> 
                                            <span>Envío</span>
                                        </button>
                                    </div>
                                    {clientData.deliveryType === 'courier' && (
                                        <div className="space-y-4 animate-in fade-in slide-in-from-top-4 bg-gray-50/50 p-5 rounded-2xl border border-gray-100">
                                            <div>
                                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-2 block tracking-wider">Empresa de Encomiendas</label>
                                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                                    {activeCouriers.map(c => (
                                                        <button key={c} onClick={() => setClientData({...clientData, courier: c})} className={`px-5 py-2.5 rounded-lg text-xs font-bold border whitespace-nowrap transition-all duration-200 ${clientData.courier === c ? 'bg-black text-white border-black shadow-md' : 'bg-white text-gray-500 border-gray-200 hover:border-gray-300'}`}>{c}</button>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <input value={clientData.identityCard} onChange={e => setClientData({...clientData, identityCard: e.target.value})} className="w-full bg-white border border-gray-200 rounded-lg px-3 py-3 text-xs font-medium focus:border-black outline-none transition-colors" placeholder="Cédula (V-...)" />
                                                <input value={clientData.phone} onChange={e => setClientData({...clientData, phone: e.target.value})} className="w-full bg-white border border-gray-200 rounded-lg px-3 py-3 text-xs font-medium focus:border-black outline-none transition-colors" placeholder="Teléfono" />
                                            </div>
                                            <textarea value={clientData.address} onChange={e => setClientData({...clientData, address: e.target.value})} className="w-full bg-white border border-gray-200 rounded-lg px-3 py-3 text-xs font-medium text-gray-900 focus:border-black outline-none resize-none h-20 transition-colors" placeholder="Dirección exacta de envío..." />
                                        </div>
                                    )}
                                </div>
                                {/* PASO 3: Pago (REDISEÑADO) */}
                                <div className="space-y-4">
                                   <div className="flex items-center gap-2 text-xs font-bold text-gray-900 uppercase tracking-widest">
                                        <span className="w-5 h-5 rounded-full bg-black text-white flex items-center justify-center text-[10px]">3</span>
                                        Pago
                                    </div>
                                   {/* Grilla de Métodos */}
                                   <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                      {activePaymentMethods.length > 0 ? activePaymentMethods.map(pm => (
                                         <button 
                                            key={pm} 
                                            onClick={() => setClientData({...clientData, paymentMethod: pm})} 
                                            className={`px-3 py-3 rounded-xl text-[11px] sm:text-xs font-bold border transition-all duration-300 ${
                                                clientData.paymentMethod === pm 
                                                ? 'bg-black text-white border-black shadow-md scale-[1.02]' 
                                                : 'bg-white text-gray-500 border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                            }`}
                                         >
                                            {pm}
                                         </button>
                                      )) : <p className="text-xs text-red-400 bg-red-50 px-3 py-2 rounded-lg border border-red-100 col-span-3">No hay métodos activos.</p>}
                                   </div>
                                   {getAlert()}
                                    {/* Tarjeta de Detalles Premium */}
                                    {clientData.paymentMethod && getSelectedPaymentDetails() && (
                                        <div className="mt-2 relative overflow-hidden rounded-2xl bg-zinc-900 p-6 text-white shadow-xl animate-in zoom-in-95 duration-500">
                                              {/* Decoración de Fondo */}
                                              <div className="absolute top-[-20px] right-[-20px] opacity-10 rotate-12 pointer-events-none">
                                                  <CreditCard size={140} className="text-white"/>
                                              </div>
                                              <div className="relative z-10">
                                                  <div className="flex justify-between items-start mb-5">
                                                    <div>
                                                        <p className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-1">Datos para Transferir</p>
                                                        <span className="text-sm font-bold text-white tracking-wide">{clientData.paymentMethod}</span>
                                                    </div>
                                                    <button 
                                                        onClick={() => handleCopy(getSelectedPaymentDetails())} 
                                                        className="flex items-center gap-1.5 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-[10px] font-bold text-white uppercase transition-colors backdrop-blur-md border border-white/5"
                                                    >
                                                        {copied ? <Check size={12} className="pointer-events-none"/> : <Copy size={12} className="pointer-events-none"/>} 
                                                        {copied ? 'Copiado' : 'Copiar'}
                                                    </button>
                                                  </div>
                                                  <div className="bg-black/30 rounded-xl p-4 border border-white/5 backdrop-blur-sm">
                                                    <p className="font-mono text-xs text-zinc-300 leading-relaxed whitespace-pre-wrap">{getSelectedPaymentDetails()}</p>
                                                  </div>
                                              </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                    {/* --- FOOTER RESPONSIVE (Fixed for Mobile) --- */}
                    <div className="bg-white px-5 py-4 border-t border-gray-100 shrink-0 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-20">
                        <div className="flex flex-col md:flex-row md:justify-between md:items-end gap-4">
                            {/* Bloque Precio */}
                            <div className="flex justify-between md:block items-center">
                                <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Total a Pagar</p>
                                {isHardCurrencyPayment || step === 1 ? (
                                    <span className="text-2xl md:text-3xl font-bold text-gray-900 tracking-tighter">{currencySymbol}{totalBaseNominal.toFixed(2)}</span>
                                ) : (
                                    <div className="flex flex-col items-end md:items-start">
                                        <span className="text-xl md:text-3xl font-bold text-gray-900 tracking-tighter">Bs {finalTotalBs.toLocaleString('es-VE', { maximumFractionDigits: 2 })}</span>
                                        <span className="text-[10px] text-gray-400 font-semibold line-through">Ref: {currencySymbol}{(totalBaseNominal + totalPenaltyNominal).toFixed(2)}</span>
                                    </div>
                                )}
                            </div>
                            {/* Bloque Botones (Full width en mobile) */}
                            <div className="flex gap-3 w-full md:w-auto">
                                {step === 2 && (
                                    <button onClick={() => setStep(1)} className="px-4 py-3.5 text-xs font-bold text-gray-500 hover:text-black bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors md:w-auto shrink-0">
                                        Volver
                                    </button>
                                )}
                                {step === 1 ? (
                                    <button onClick={() => setStep(2)} className="flex-1 md:flex-none bg-black text-white px-8 py-3.5 rounded-xl font-bold text-sm hover:bg-gray-800 transition-all shadow-xl shadow-black/10 active:scale-95 flex items-center justify-center gap-2">
                                        Continuar <ChevronRight size={16} className="pointer-events-none"/>
                                    </button>
                                ) : (
                                    <button onClick={handleCheckout} disabled={loading} className="flex-1 md:flex-none bg-emerald-600 text-white px-6 py-3.5 rounded-xl font-bold text-sm hover:bg-emerald-700 transition-all shadow-xl shadow-emerald-600/20 active:scale-95 flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                                        {loading ? <Loader2 className="animate-spin pointer-events-none" size={18}/> : <><MessageCircle size={18} className="pointer-events-none"/> Confirmar Pedido</>}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        )}
        <style jsx global>{`
            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        `}</style>
    </>
  )
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import { Geist, Geist_Mono, Playfair_Display } from "next/font/google";
import "./globals.css";
const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});
const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});
const playfair = Playfair_Display({
  variable: "--font-serif",
  subsets: ["latin"],
  style: ['normal', 'italic'],
});
export const metadata: Metadata = {
  metadataBase: new URL('https://preziso.vercel.app'),
  title: {
    default: "Preziso | E-commerce Automatizado para Venezuela",
    template: "%s | Preziso"
  },
  description: "Sistema de ventas inteligente que actualiza tus precios a Tasa BCV automáticamente. Vende en dólares, cobra en bolívares y gestiona pedidos por WhatsApp.",
  keywords: ["catalogo digital", "venezuela", "tasa bcv", "automatizacion", "tienda online", "ventas whatsapp", "dolar monitor"],
  // --- CONFIGURACIÓN DE REDES SOCIALES (WhatsApp, Facebook, LinkedIn) ---
  openGraph: {
    title: "Preziso - Deja de ser esclavo de la tasa",
    description: "Tu tienda online que calcula el dólar sola. Prueba gratis hoy.",
    siteName: "Preziso",
    locale: "es_VE",
    type: "website",
    url: 'https://preziso.vercel.app',
    images: [
      {
        url: '/opengraph-image.jpg', // AQUI estaba el error, ahora coinciden
        width: 1200,
        height: 630,
        alt: 'Preziso Dashboard Preview',
      },
    ],
  },
  // --- CONFIGURACIÓN PARA TWITTER / X ---
  twitter: {
    card: 'summary_large_image',
    title: 'Preziso - Sistema Operativo para Venezuela',
    description: 'Automatiza tu tienda con tasa BCV en tiempo real.',
    images: ['/opengraph-image.jpg'], // Coincide con la de arriba
  },
  // --- CONFIGURACIÓN DE ICONOS (FAVICON) ---
  icons: {
    icon: [
      // MODO CLARO (Navegador Blanco) -> Necesitas la Z NEGRA (favicon-light.png)
      {
        media: '(prefers-color-scheme: light)',
        url: '/favicon-light.png',
        href: '/favicon-light.png',
      },
      // MODO OSCURO (Navegador Negro) -> Necesitas la Z BLANCA (favicon-dark.png)
      {
        media: '(prefers-color-scheme: dark)',
        url: '/favicon-dark.png',
        href: '/favicon-dark.png',
      },
    ],
  },
  // Bloqueo de traducción automática (Correcto)
  other: {
    google: "notranslate",
  },
};
export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    // 2. SEGUNDA DEFENSA: lang="es" para SEO local y translate="no" HTML5 estándar
    <html lang="es" translate="no">
      <body
        // 3. TERCERA DEFENSA: Clase 'notranslate' que bloquea la acción en el DOM
        className={`${geistSans.variable} ${geistMono.variable} ${playfair.variable} antialiased notranslate`}
      >
        {children}
      </body>
    </html>
  );
}
</file>

<file path="app/[slug]/page.tsx">
import { createClient } from '@/utils/supabaseServer'
import StoreInterface from '@/components/StoreInterface'
import { notFound } from 'next/navigation'
export const dynamic = 'force-dynamic'
export default async function StorePage({ params }: { params: Promise<{ slug: string }> }) {
  const { slug } = await params
  const supabase = await createClient()
  // 1. OBTENER TIENDA
  const { data: store } = await supabase
    .from('stores')
    .select('*, payment_config, shipping_config') 
    .eq('slug', slug)
    .single()
  if (!store) {
    return notFound()
  }
  // 2. OBTENER PRODUCTOS
  const { data: products } = await supabase
    .from('products')
    .select('*, product_variants(*)')
    .eq('user_id', store.user_id)
    .order('created_at', { ascending: false })
  // 3. OBTENER TASAS (CORREGIDO: Usando 'app_config')
  const { data: rates } = await supabase
    .from('app_config') // <--- AQUÍ ESTABA EL ERROR
    .select('*')
    .limit(1)
    .single()
  return (
    <StoreInterface 
      store={store} 
      products={products || []} 
      rates={rates || { usd_rate: 0, eur_rate: 0 }}
    />
  )
}
</file>

<file path="app/admin/page.tsx">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import { 
  Plus, 
  Package, 
  Settings, 
  ExternalLink, 
  TrendingUp, 
  AlertTriangle, 
  ChevronRight, 
  ShoppingBag, 
  Layers, 
  MessageCircle, 
  Clock 
} from 'lucide-react'
import RateWidget from '@/components/admin/RateWidget'
export default async function AdminDashboard() {
  const cookieStore = await cookies()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
      },
    }
  )
  // 1. Verificación de Sesión
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    redirect('/auth/login')
  }
  // 2. Carga de Datos Paralela (Bleeding Edge Performance)
  const today = new Date().toISOString().split('T')[0]
  const [storeRes, productsRes, variantsRes, ordersRes, configRes] = await Promise.all([
    // Tienda (Necesitamos currency_type)
    supabase.from('stores').select('*').eq('user_id', user.id).single(),
    // Productos
    supabase.from('products').select('*', { count: 'exact' }).order('created_at', { ascending: false }).limit(4),
    // Stock
    supabase.from('product_variants').select('stock'),
    // Pedidos
    supabase.from('orders').select('status, total_usd, created_at'),
    // Configuración Global (Tasas BCV)
    supabase.from('app_config').select('usd_rate, eur_rate, updated_at').eq('id', 1).single()
  ])
  // 3. Procesamiento de Datos
  const store = storeRes.data
  const recentProducts = productsRes.data || []
  const totalProducts = productsRes.count || 0
  // KPI Logic
  const lowStock = variantsRes.data?.filter(v => v.stock <= 3).length || 0
  const pendingOrders = ordersRes.data?.filter(o => o.status === 'pending').length || 0
  const salesToday = ordersRes.data
    ?.filter(o => o.created_at.startsWith(today) && o.status !== 'cancelled')
    .reduce((acc, o) => acc + Number(o.total_usd), 0) || 0
  // 4. Preparación de datos para el Widget de Moneda
  // Si no hay configuración en BD, usamos fallbacks seguros para evitar crashes
  const usdRate = configRes.data?.usd_rate ?? 0
  const eurRate = configRes.data?.eur_rate ?? 0
  const lastUpdated = configRes.data?.updated_at ?? null
  const storeCurrency = store?.currency_type === 'eur' ? 'eur' : 'usd' // Default to USD
  return (
    <div className="min-h-screen bg-[#F8F9FA] pb-20 font-sans text-gray-900 selection:bg-black selection:text-white">
      {/* HEADER */}
      <header className="bg-white border-b border-gray-100 px-6 py-8 md:px-12 md:py-10">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div className="flex items-center gap-5">
                <div className="w-16 h-16 rounded-2xl bg-gray-900 flex items-center justify-center shadow-xl shadow-gray-900/10 overflow-hidden border-4 border-white">
                    {store?.logo_url ? (
                        <img src={store.logo_url} className="w-full h-full object-contain bg-white" alt="Logo" />
                    ) : (
                        <ShoppingBag className="text-white" size={24} />
                    )}
                </div>
                <div>
                    <h1 className="text-2xl md:text-3xl font-black tracking-tight text-gray-900">
                      Hola, {store?.name || 'Admin'}
                    </h1>
                    <p className="text-sm font-medium text-gray-400">
                      Panel de Control &bull; {new Date().toLocaleDateString('es-VE', { weekday: 'long', day: 'numeric', month: 'long' })}
                    </p>
                </div>
            </div>
            <div className="flex gap-3">
                 <Link 
                    href={`/${store?.slug || ''}`} 
                    target="_blank"
                    className="flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-200 rounded-full text-sm font-bold text-gray-600 hover:border-black hover:text-black transition-all shadow-sm"
                 >
                    <ExternalLink size={16}/> <span className="hidden md:inline">Ver Tienda</span>
                 </Link>
                 <Link 
                    href="/admin/settings" 
                    className="flex items-center gap-2 px-5 py-2.5 bg-gray-100 border border-transparent rounded-full text-sm font-bold text-gray-600 hover:bg-gray-200 transition-all"
                    title="Ajustes"
                 >
                    <Settings size={16}/>
                 </Link>
            </div>
        </div>
      </header>
      <main className="max-w-7xl mx-auto px-6 md:px-12 py-10 space-y-12">
        {/* SECCIÓN 1: KPIs y CONTROL MONETARIO */}
        {/* Usamos grid-dense para que el widget se acomode perfectamente */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-fr">
            {/* WIDGET DE TASA (Ahora ocupa 1 columna y tiene la misma altura/estilo) */}
            <div className="lg:col-span-1 row-span-1">
                <RateWidget 
                    storeCurrency={storeCurrency} 
                    usdRate={usdRate} 
                    eurRate={eurRate} 
                    lastUpdated={lastUpdated} 
                />
            </div>
             {/* Card 1: Pedidos Pendientes */}
            <Link href="/admin/orders" className="group bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-between h-48 hover:border-yellow-400 transition-colors relative overflow-hidden lg:col-span-1">
                {pendingOrders > 0 && <div className="absolute top-0 right-0 w-16 h-16 bg-yellow-400/10 blur-2xl rounded-full -mr-8 -mt-8"></div>}
                <div className="flex justify-between items-start">
                    <div className={`p-3 rounded-2xl ${pendingOrders > 0 ? 'bg-yellow-50 text-yellow-600' : 'bg-gray-50 text-gray-400'}`}>
                        <Clock size={24} />
                    </div>
                    {pendingOrders > 0 && <span className="flex h-3 w-3 relative"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span></span>}
                </div>
                <div>
                    <p className={`text-4xl font-black tracking-tight ${pendingOrders > 0 ? 'text-gray-900' : 'text-gray-400'}`}>{pendingOrders}</p>
                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest group-hover:text-yellow-600 transition-colors mt-1">Pedidos Pendientes</p>
                </div>
            </Link>
            {/* Card 2: Ventas Hoy */}
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-between h-48 lg:col-span-1">
                <div className="flex justify-between items-start">
                    <div className="p-3 rounded-2xl bg-green-50 text-green-600">
                        <TrendingUp size={24} />
                    </div>
                </div>
                <div>
                    <p className="text-4xl font-black tracking-tight text-gray-900">${salesToday.toFixed(0)}</p>
                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Ventas Hoy</p>
                </div>
            </div>
            {/* Card 3: Stock Alert (Combinado Stock y Productos para ahorrar espacio o dejarlo separado) */}
            <div className={`bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-between h-48 lg:col-span-1 ${lowStock > 0 ? 'hover:border-red-200' : ''}`}>
                <div className="flex justify-between items-start">
                    <div className={`p-3 rounded-2xl ${lowStock > 0 ? 'bg-red-50 text-red-500' : 'bg-gray-50 text-green-500'}`}>
                        {lowStock > 0 ? <AlertTriangle size={24} /> : <Package size={24} />}
                    </div>
                </div>
                <div>
                    <p className={`text-4xl font-black tracking-tight ${lowStock > 0 ? 'text-red-500' : 'text-gray-900'}`}>{lowStock}</p>
                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Alertas Stock</p>
                </div>
            </div>
        </div>
        {/* SECCIÓN 2: ACCIONES RÁPIDAS */}
        <div>
            <h2 className="text-lg font-black text-gray-900 mb-6 flex items-center gap-2">
                <TrendingUp size={20} className="text-gray-400"/> Acciones Rápidas
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {/* 1. NUEVO PRODUCTO */}
                <Link href="/admin/product/new" className="group relative bg-black rounded-3xl p-8 overflow-hidden shadow-xl shadow-black/10 hover:shadow-2xl hover:scale-[1.01] transition-all duration-300">
                    <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-16 -mt-16 group-hover:bg-white/20 transition-all"></div>
                    <div className="relative z-10 flex flex-col h-full justify-between min-h-[140px]">
                        <div className="bg-white/20 w-12 h-12 rounded-2xl flex items-center justify-center text-white mb-4">
                            <Plus size={24} strokeWidth={3} />
                        </div>
                        <div>
                            <h3 className="text-2xl font-black text-white mb-1">Nuevo Producto</h3>
                            <p className="text-white/60 text-sm font-medium">Agregar al catálogo</p>
                        </div>
                    </div>
                </Link>
                {/* 2. GESTIÓN PEDIDOS */}
                <Link href="/admin/orders" className="group relative bg-white border border-gray-200 rounded-3xl p-8 overflow-hidden shadow-sm hover:border-blue-500 hover:shadow-blue-500/10 transition-all duration-300">
                    <div className="relative z-10 flex flex-col h-full justify-between min-h-[140px]">
                        <div className="bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors w-12 h-12 rounded-2xl flex items-center justify-center mb-4">
                            <MessageCircle size={24} strokeWidth={2.5} />
                        </div>
                        <div className="flex justify-between items-end">
                            <div>
                                <h3 className="text-2xl font-black text-gray-900 mb-1 group-hover:text-blue-600 transition-colors">Pedidos</h3>
                                <p className="text-gray-400 text-sm font-medium">Gestionar ventas ({pendingOrders})</p>
                            </div>
                            <div className="bg-gray-50 rounded-full p-2 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                <ChevronRight size={20}/>
                            </div>
                        </div>
                    </div>
                </Link>
                {/* 3. INVENTARIO */}
                <Link href="/admin/inventory" className="group relative bg-white border border-gray-200 rounded-3xl p-8 overflow-hidden shadow-sm hover:border-black hover:shadow-lg transition-all duration-300">
                    <div className="relative z-10 flex flex-col h-full justify-between min-h-[140px]">
                        <div className="bg-gray-100 group-hover:bg-black group-hover:text-white transition-colors w-12 h-12 rounded-2xl flex items-center justify-center text-black mb-4">
                            <Package size={24} strokeWidth={2.5} />
                        </div>
                        <div className="flex justify-between items-end">
                            <div>
                                <h3 className="text-2xl font-black text-gray-900 mb-1">Inventario</h3>
                                <p className="text-gray-400 text-sm font-medium group-hover:text-gray-600 transition-colors">Control de Stock ({totalProducts})</p>
                            </div>
                            <div className="bg-gray-50 rounded-full p-2 group-hover:bg-black group-hover:text-white transition-colors">
                                <ChevronRight size={20}/>
                            </div>
                        </div>
                    </div>
                </Link>
            </div>
        </div>
        {/* SECCIÓN 3: ACTIVIDAD RECIENTE */}
        <div className="bg-white rounded-3xl border border-gray-100 p-8 shadow-sm">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-lg font-black text-gray-900">Últimos Productos</h2>
                <Link href="/admin/inventory" className="text-xs font-bold text-gray-400 hover:text-black transition-colors uppercase tracking-wide">Ver Todo</Link>
            </div>
            <div className="space-y-4">
                {recentProducts.length === 0 ? (
                    <div className="text-center py-10 text-gray-400 text-sm">Aún no hay productos.</div>
                ) : (
                    recentProducts.map(prod => (
                        <div key={prod.id} className="flex items-center justify-between group cursor-default">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 rounded-xl bg-gray-50 border border-gray-100 overflow-hidden relative">
                                    {prod.image_url ? (
                                        <img src={prod.image_url} className="w-full h-full object-cover" alt={prod.name} />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-gray-300"><Package size={16}/></div>
                                    )}
                                </div>
                                <div>
                                    <p className="font-bold text-sm text-gray-900 group-hover:text-blue-600 transition-colors">{prod.name}</p>
                                    <p className="text-[10px] text-gray-400 font-bold uppercase">{prod.category}</p>
                                </div>
                            </div>
                            <Link href={`/admin/product/edit/${prod.id}`} className="text-gray-300 hover:text-black p-2 transition-colors">
                                <Settings size={16} />
                            </Link>
                        </div>
                    ))
                )}
            </div>
        </div>
      </main>
    </div>
  )
}
</file>

</files>
